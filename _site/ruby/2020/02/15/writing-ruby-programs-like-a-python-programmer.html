<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Writing Ruby Programs Like a Python Programmer</title>
  <meta name="description" content="Pizza courtesy of Pizza for Ukraine!Donate Now to Pizza for Ukraine&nbsp;">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://localhost:4000/blog/ruby/2020/02/15/writing-ruby-programs-like-a-python-programmer.html">
  <link rel="alternate" type="application/rss+xml" title="FuzzyBlog" href="http://localhost:4000/blog/feed.xml">
  
  <!-- favicons -->
  <!-- shout out to: http://www.favicon-generator.org/ --> 
  <link rel="apple-touch-icon" sizes="57x57" href="/blog/assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/blog/assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/blog/assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/blog/assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/blog/assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/blog/assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/blog/assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/favicon-16x16.png">
  <link rel="manifest" href="/blog/assets/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/blog/assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- end_favicons -->
  
  <!-- twitter specific head tags -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@fuzzygroup">
  <meta name="twitter:creator" content="@fuzzygroup">
  <meta name="twitter:title" content="Writing Ruby Programs Like a Python Programmer">

  
    <meta name="twitter:description"
      content="

Pizza courtesy of Pizza for Ukraine!

Donate Now to Pizza for Ukraine

&amp;nbsp;

As of late, I have found myself writing a number of what amount to &quot;Non Rails&quot; tools.  These are tools...">
  

  
    <meta name="twitter:image"
      content="http://fuzzyblog.io/blog/assets/scott_johnson.jpg">
  
  
  
  
  
  <!--
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83931583-1', 'auto');
    ga('send', 'pageview');

  </script>
  -->
    
  
    
  <script type="text/javascript">
    function do_search() {
      var searchForm = document.getElementById('search');
      var q = document.getElementById('q');
      var searchQuery = "site:fuzzyblog.io " + q.value;
      document.location = "https://www.google.com/search?q=" + searchQuery;
    }
  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">FuzzyBlog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/aws.html">AWS</a>
          
        
          
          <a class="page-link" href="/blog/category.html">Category</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/blog/resume.html">Resume for J. Scott Johnson</a>
          
        
          
          <a class="page-link" href="/blog/tag.html">Tag</a>
          
        
          
          <a class="page-link" href="/blog/youtube.html">Watch Scott Live</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div style="width: 50%; float:left; ">
            <p style="text-align: center; padding: 10px; border: 2px dashed orange">
              <!--
              <a href="https://www.jobhound.io/" class="cta-button-blue">My new product is Job Hound:<br/>Make applying for tech jobs suck less!</a>
                -->
                <a href="https://www.pizzaforukraine.com/" class="cta-button-blue"><img src="/blog/assets/pizza_icon.png">Help the Ukraine<br/>by Donating a Pizza!<img src="/blog/assets/pizza_icon.png"></a>
            </p>
        </div>
        <div style="width: 40%; float:right; text-align: center; valign: center; padding: 10px; border: 2px dashed blue">

            <form id="search" action="https://www.google.com/search">
              <input id="q" name="q" size=40>
              <button type="submit" form="form1" value="Search" onclick="do_search();">Search</button><br/>&nbsp;
            </form>

        </div>
        <p>&nbsp;</p>
        
        <!--
        <div style="width: 75%; float:left; ">&nbsp;&nbsp;&nbsp;</div>
        -->
          <!--
        <div style="width: 20%; float:right; ">
            <p style="text-align: center; padding: 10px; border: 2px dashed #000">
              <a href="http://www.fuzzyblog.io/" class="cta-button-blue">Hire Me!</a>
            </p>
        </div>
            -->
        <div style="clear: both;"></div>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Writing Ruby Programs Like a Python Programmer</h1>
    <p class="I'll"><time datetime="2020-02-15T00:00:00-05:00" itemprop="datePublished">Feb 15, 2020</time> 
      </p> 
  </header>
  

  <div class="post-content" itemprop="articleBody">
    <p><img style="display: block; margin-left: auto; margin-right: auto; width: 75%; height: 75%" src="http://pizzaforukraine.com:443/assets/random/DSC03684_edit_125707612201650.jpg" /></p>

<p class="center">Pizza courtesy of Pizza for Ukraine!</p>

<p class="center"><a href="https://www.pizzaforukraine.com/">Donate Now to Pizza for Ukraine</a></p>

<p>&nbsp;</p>

<p>As of late, I have found myself writing a number of what amount to "Non Rails" tools.  These are tools that tend to:</p>

<ul>
  <li>Run continuously in the background</li>
  <li>Are deployed as SystemD services on Unix boxes</li>
  <li>Have the normal issues of coding complexities between development (OSX) and production (Ubuntu)</li>
</ul>

<p>Even though I normally just generate a Rails application for even my command line tools, this project felt like minimalism was called for and, well, I wanted that particular challenge.</p>

<p>In the remainder of this blog post, I'm going to talk about what this looks like and what I've learned from spending a few months in the Python world and how I'm applying it here.</p>

<h2 id="file-structure">File Structure</h2>

<p>Here's a directory listing from one of these tools.  The thing to understand is that "ohi" is the abbreviation for the project (which explains why you see it multiple times).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ls -l
total 64
-rw-r--r--@ 1 sjohnson  staff   189 Feb 24 09:58 Gemfile
-rw-r--r--  1 sjohnson  staff  2083 Feb 24 09:58 Gemfile.lock
-rw-r--r--@ 1 sjohnson  staff   307 Feb 24 10:21 README.md
-rwxr-xr-x@ 1 sjohnson  staff   111 Feb 24 14:35 deploy.sh
-rw-r--r--@ 1 sjohnson  staff  3542 Feb 24 14:07 loader.rb
-rw-r--r--@ 1 sjohnson  staff  1477 Feb 24 14:12 loader_kafka_to_ohi.rb
-rw-r--r--@ 1 sjohnson  staff   436 Feb 24 10:29 loader_kafka_to_ohi.service
-rw-r--r--@ 1 sjohnson  staff   125 Feb 24 10:22 loader_kafka_to_ohi.sh
</code></pre></div></div>

<p>Here is the role of each of these pieces:</p>

<ul>
  <li>Gemfile / Gemfile.lock – the standard Ruby packages that the tool relies on</li>
  <li>README.md – the Readme</li>
  <li>deploy.sh – a shell script that SCP's everything up to a deployment server.  Yeah, yeah. I need CI/CD.  And it will come but for now this makes deployment easy.</li>
  <li>loader.rb – the "God" class for this tool (explained below)</li>
  <li>loader_kafka_to_ohi.rb – the actual main loop for the tool</li>
  <li>loader_kafka_to_ohi.service – the SystemD service file for this</li>
  <li>loader_kafka_to_ohi.sh – the shell script called by the SystemD service file</li>
</ul>

<h2 id="it-really-is-about-separating-def-main-from-supporting-functions">It really is About Separating def main From Supporting Functions</h2>

<p>While all these tools tend to come down to the 8 files above (or variants on them), the bulk of it is in two files:</p>

<ul>
  <li>loader_kafka_to_ohi.rb</li>
  <li>loader.rb</li>
</ul>

<p>The first file, loader_kafka_to_ohi.rb, basically amounts to  a few sections:</p>

<ul>
  <li>A comment at the very top showing how to execute it including any command line arguments</li>
  <li>A set of require statements to load the gems (remember - this isn't Rails so you need to manually require your gems)</li>
  <li>Constant declaration</li>
  <li>A def main function</li>
  <li>A call to execute main()</li>
</ul>

<p>Here's the skeleton:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">#</span>
<span class="c1"># Execution Example</span>
<span class="c1"># RAILS_ENV=development TOPIC=reddit ruby loader_reddit_to_kafka.rb</span>
<span class="c1">#</span>

<span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'kafka'</span>
<span class="nb">require</span> <span class="s1">'mechanize'</span>
<span class="nb">require</span> <span class="s1">'ostruct'</span>
<span class="nb">require</span> <span class="s1">'redd'</span>
<span class="nb">require</span> <span class="s1">'redis'</span>
<span class="nb">require_relative</span> <span class="s1">'loader'</span>

<span class="no">TOPIC</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'TOPIC'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">main</span>
  <span class="c1"># code here</span>
<span class="k">end</span>

<span class="n">main</span>
</code></pre></div></div>

<p><strong>Note 0</strong>: You'll notice that I still use the convention of RAILS_ENV for the environment; I'm too damn trained at this point in my career to even consider naming that something else</p>

<p>Having written a number of these tools lately, I can definitively state that there is a <strong>huge</strong> clarity of code benefit to separating out the main loop from the supporting code.  It is a forest for the trees sort of thing.</p>

<p>The second file, loader.rb, is a "God Class" which wraps every function used by main (or any of the functions that main calls) into a single class.  Given that the underlying function of this tool is to load data, well, I call the class: Loader i..e</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Loader</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Even though a God class is generally a bad thing (poor use of name spaces, too big, etc.), I found it to be a decent compromise in terms of abstractions simply because it makes debugging <em>trivial</em>.  I find myself constantly switching between local development and remote development (where all my tooling like Kafka, my API server, etc) exist.  With a god class like loader, I can easily ssh into my production box and then just use irb in my deployment directory to:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'loader'</span>
</code></pre></div></div>

<p>and then continue figuring out whatever problem has come up with easy access to functions in my god class (everything is just a def self.whatever method in loader.rb so all methods can be called trivially).</p>

<p><strong>Note 1</strong>: My main loop including require statements, constants and declarations is less than 60 lines and my god class is less than 160 lines.  As I said this is a compromise.</p>

<p><strong>Note 2</strong>: Normally the term God object is used instead of "God class" but since I'm not actually ever instantiating an object, it felt like God class was more accurate.</p>

<p><strong>Note 3</strong>: But shouldn't you always have your development environment mirror your production environment?  Sure in an ideal world but Kafka servers are a <em>damn censored</em> pain in the arse to setup where as the AWS managed kafka service is almost brainless in its simplicity.  This is a very lightly staffed project and I chose to spend my time on coding rather than DevOps (and, yes, getting something complex installed locally is still DevOps).</p>

<h2 id="use-require_relative-to-import-a-god-class">Use require_relative to Import A God Class</h2>

<p>The key technique to making this style of development work was my realizing that while <a href="https://www.thoughtco.com/requre-method-2908199">require</a> worked for gems, it worked poorly, if at all, for my own function libraries.  The reason for this is apparently Ruby madness with respect to the current working directory or cwd.  Happily <a href="https://stackoverflow.com/questions/9750610/ruby-require-error-cannot-load-such-file">require_relative solves this issue with flying colors</a>.</p>

<h2 id="wheres-the-python-connection">Where's the Python Connection?</h2>

<p>I find this technique, a god class with require_relative, to be very similar to coding in Python using import statements.  Oddly Python feels a bit more object oriented because anything you import automatically gets treated as a namespace that makes coding look like a class.  Python folk use this technique very readily and I find that flexibility quite pleasant in Ruby (even if I have to define a class to make it work).</p>

<p><strong>Note 4</strong>: Yes I should be able to do this also with <a href="https://ruby-doc.com/docs/ProgrammingRuby/html/tut_modules.html">modules</a> but I've found modules to be problematic in past experience so … (and I freely admit that it might be me).</p>

<h2 id="what-about-test-coverage">What About Test Coverage</h2>

<p>While I shudder to admit it, I actually haven't written test coverage for these things yet.  When I do I'll figure out how to graft test coverage onto a non Rails application.</p>

  </div>
  
  <!--
    http://fuzzyblog.io/blog/tag.html#aws
    http://localhost:5000/blog/category.html#facebook
  -->
  
  <hr/><br/>
  <p><strong>Posted In:</strong>
  
    <a href="http://localhost:4000/blog/tag.html#ruby" >
      #ruby
    </a>
    
    <a href="http://localhost:4000/blog/tag.html#python" >
      #python
    </a>
    
  </p>
  
  <!--
  <hr/><br/>
  <div style="text-align: center;">
      <ul class="list-inline tags" >       
     
     <li style="display: inline-block;">
       <a href="http://localhost:4000/blog/tag.html#ruby" class="link_button">
         ruby
       </a>
     </li>
     
     <li style="display: inline-block;">
       <a href="http://localhost:4000/blog/tag.html#python" class="link_button">
         python
       </a>
     </li>
     
    </ul>

  </div>
-->  


  
  
  

</article>

<!--
<div class="just-comments" data-apikey="2fb5b93f-dad4-41c0-a9c4-645079ddc541"></div>
<script async src="https://just-comments.com/w.js"></script>
-->

      </div>
    </div>

    <div class="wrapper">
  <div style="">
    <!--
    <p style="text-align: center; padding: 10px; border: 2px dashed #000">
      <a href="https://www.gamenanny.io/" class="cta-button-blue">My new product is Game Nanny: Never be surprised by your kid's Xbox spending again!</a>
    </p>
      -->
      <p style="text-align: center; padding: 10px; border: 2px dashed red">
        <a href="https://www.jobhound.io/" class="cta-button-blue">My new product is Job Hound:<br/>Make applying for tech jobs suck less!</a>
      </p>
      
  </div>
</div>

<footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">FuzzyBlog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>FuzzyBlog</li>
          <li><a href="mailto:fuzzygroup@gmail.com">fuzzygroup@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fuzzygroup"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/fuzzygroup"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
