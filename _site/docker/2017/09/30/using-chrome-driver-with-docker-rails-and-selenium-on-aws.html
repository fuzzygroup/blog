<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using Chrome Driver with Docker, Rails and Selenium on AWS</title>
  <meta name="description" content="I’ve done a lot of crawling in my professional career and I mean a lot.  The recent trend towards JavaScript based sites, however, has wreaked havoc on my tr...">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://fuzzyblog.io//blog/docker/2017/09/30/using-chrome-driver-with-docker-rails-and-selenium-on-aws.html">
  <link rel="alternate" type="application/rss+xml" title="FuzzyBlog" href="http://fuzzyblog.io//blog/feed.xml">
  
  <!-- favicons -->
  <!-- shout out to: http://www.favicon-generator.org/ --> 
  <link rel="apple-touch-icon" sizes="57x57" href="/blog/assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/blog/assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/blog/assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/blog/assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/blog/assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/blog/assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/blog/assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/favicon-16x16.png">
  <link rel="manifest" href="/blog/assets/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/blog/assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- end_favicons -->
  
  <!-- twitter specific head tags -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@fuzzygroup">
  <meta name="twitter:creator" content="@fuzzygroup">
  <meta name="twitter:title" content="Using Chrome Driver with Docker, Rails and Selenium on AWS">

  
    <meta name="twitter:description"
      content="Although normally thought of as a testing tool, Selenium can also allow you to do crawling in Rails not through low level parsing but also through an embedded browser.  However getting Selenium working on a headless AWS server is tedious and non-obvious.  Here is how I did it.">
  

  
    <meta name="twitter:image"
      content="http://fuzzyblog.io/blog/assets/scott_johnson.jpg">
  
  
  
  
  
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83931583-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">FuzzyBlog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/aws.html">AWS</a>
          
        
          
          <a class="page-link" href="/blog/category.html">Category</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/blog/resume.html">Resume for J. Scott Johnson</a>
          
        
          
          <a class="page-link" href="/blog/tag.html">Tag</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <p style="text-align: center; padding: 10px; border: 2px dashed #000">
        <a href="https://www.gamenanny.io/" class="cta-button-blue">My new product is Game Nanny: Take Control of Your Kid's Xbox Gaming - Sign Up for Game Nanny Today!</a></p>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using Chrome Driver with Docker, Rails and Selenium on AWS</h1>
    <p class="I'll"><time datetime="2017-09-30T00:00:00-04:00" itemprop="datePublished">Sep 30, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I’ve done a lot of crawling in my professional career and I mean a <strong>lot</strong>.  The recent trend towards JavaScript based sites, however, has wreaked havoc on my traditional approach of low level html parsing.  For a new product I’m launching, I recently had to make the switch to using <a href="https://github.com/SeleniumHQ/">Selenium</a> for crawling.  Selenium, commonly known as a testing tool, can be used in an embedded fashion where you use code like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>browser = Selenium::WebDriver.for :chrome
browser.get "https://www.google.com"
html = browser.page_source
</code></pre>
</div>

<p>Here’s a rough equivalent in Mechanize:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>agent = Mechanize.new
page = agent.get("https://www.google.com")
html = page.body
</code></pre>
</div>

<p>Although the lines of code look similar to something like <a href="https://github.com/sparklemotion/mechanize">Mechanize</a> this is actually an entirely different approach because underneath it all is a full browser including JavaScript which lets something like a page which sends its data down in a JavaScript array and then uses JavaScript to display it actually render and return back to you parseable html.</p>

<h1 id="doing-this-server-side">Doing this Server Side</h1>

<p>If you’re going to use Selenium for a server side crawling process then what you actually needs is called ChromeDriver which is the embedded chrome executable that represents a browser.  One approach is to locally install ChromeDriver on each of your compute nodes but the better approach is to Dockerize everything and run ChromeDriver as a container.  Here are the steps to do just that.</p>

<h2 id="add-chromedriver-to-your-docker-compose-file">Add ChromeDriver to Your Docker Compose File</h2>

<p>You’ll likely need to implement both Step 1 and Step 2.</p>

<h3 id="step-1">Step 1</h3>

<p>Here’s what you’ll need for docker-compose.yml or docker-compose.production.yml:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>chromedriver:
  image: 'robcherry/docker-chromedriver'
  ports: 
    - 4444:4444
  restart: on-failure
  shm_size: 1G    
  environment:
    - CHROMEDRIVER_WHITELISTED_IPS=""
</code></pre>
</div>

<h3 id="step-2">Step 2</h3>

<p>A docker container is dramatically lighter than a full computer and you’ll find that Chrome will start.  The specific error you are likely to hit is:</p>

<blockquote>
  <p>Selenium::WebDriver::Error::UnknownError: unknown error: Chrome failed to start: crashed</p>
</blockquote>

<p>When you discover this you need to change your daemon.json file (normally located in /etc/docker/daemon.json) to have a larger shm_size like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cat daemon.json
{
  "default-shm-size":"2g",
  "storage-driver": "overlay2",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m"
  }
}
</code></pre>
</div>

<p>Yes I’m aware that I use 1G in the first example and 2g in the second.  This is how I currently have it working and I’m leaving it alone until I play with it more.  I suspect you could sync these but I don’t know that definitively.</p>

<h3 id="step-3">Step 3</h3>

<p>The next error you are likely to hit is one of these two, possibly both:</p>

<blockquote>
  <p>Net::ReadTimeout during browser launch</p>
</blockquote>

<blockquote>
  <p>UnknownError: session deleted because of page crash from tab crashed</p>
</blockquote>

<p>The solution to each of these is how you invoke the core browser object.  Here’s what I used:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>browser = Selenium::WebDriver.for :chrome, url: "http://chromedriver:4444", :prefs =&gt; {:password_manager_enable =&gt; false, :credentials_enable_service =&gt; false}, :switches =&gt; ["disable-infobars", "no-sandbox"]
</code></pre>
</div>

<h1 id="security-issues">Security Issues</h1>

<p>Here’s an interesting security note:</p>

<p>Note: ChromeDriver restricts access to local connections by default. To allow external connections, you can pass in a custom CHROMEDRIVER_WHITELISTED_IPS environment variable. By default, this is set to 127.0.0.1, but this can by any comma separated list of IP addresses. Setting the value as empty will allow all remote connections.</p>

<p>AWS security groups really save you on this one.  By setting CHROMEDRIVER_WHITELISTED_IPS=””, I am able to use ChromeDriver from any other container but nothing else can execute them.  An embedded browser like Selenium is akin to an open proxy so you do not want that.</p>

<h1 id="references">References</h1>
<ul>
  <li><a href="https://hub.docker.com/r/robcherry/docker-chromedriver/">Docker Chrome Driver</a></li>
  <li><a href="https://github.com/SeleniumHQ/selenium/wiki/Ruby-Bindings">Ruby and Selenium</a></li>
  <li><a href="https://gist.github.com/ziadoz/3e8ab7e944d02fe872c3454d17af31a5">Installing Chrome Driver Locally on Ubuntu</a></li>
  <li><a href="https://github.com/SeleniumHQ/docker-selenium/issues/198">Net::ReadTimeout during browser launch</a></li>
  <li><a href="https://intoli.com/blog/running-selenium-with-headless-chrome/">Running Selenium on Headless Chrome</a></li>
  <li><a href="https://docs.docker.com/engine/reference/run/#ipc-settings-ipc">Setting Docker Shm</a></li>
  <li><a href="https://github.com/elgalu/docker-selenium">Docker and Selenium</a></li>
  <li><a href="https://github.com/zalando/zalenium#run-it">Zalenium</a></li>
  <li><a href="https://github.com/elgalu/docker-selenium/issues/20#issuecomment-133011186">Docker and Selenium and Shm / Chrome</a></li>
</ul>

<h1 id="thank-you">Thank You</h1>

<p>Kudos and thanks to <a href="http://www.nickjanetakis.com/">Nick my Docker buddy</a>.  He teaches Docker professionally and really knows his stuff.  I probably could have slogged through this but his help turned what would have been a man day into a quick one hour pairing session.  Appreciated.</p>

  </div>
  
  

</article>

      </div>
    </div>

    <div class="wrapper">
<p style="text-align: center; padding: 10px; border: 2px dashed #000">
<a href="https://www.gamenanny.io/" class="cta-button-blue">My new product is Game Nanny: Take Control of Your Kid's Xbox Gaming - Sign Up for Game Nanny Today!</a></p>
</div>

<footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">FuzzyBlog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>FuzzyBlog</li>
          <li><a href="mailto:fuzzygroup@gmail.com">fuzzygroup@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fuzzygroup"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/fuzzygroup"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
