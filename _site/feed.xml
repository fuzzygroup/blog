<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>FuzzyBlog</title>
    <description>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</description>
    <link>http://fuzzyblog.io//blog/</link>
    <atom:link href="http://fuzzyblog.io//blog/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Fri, 01 Sep 2017 09:46:13 -0400</pubDate>
    <lastBuildDate>Fri, 01 Sep 2017 09:46:13 -0400</lastBuildDate>
    <generator>Jekyll v3.2.1</generator>
    
      <item>
        <title>Notes on Upgrading to Rails 5.1</title>
        <description>&lt;p&gt;Rails 5.1 Upgrade Notes
description: With Rails 5.1.4 on the horizon, it is time to upgrade to Rails 5.1.  Here I discuss the issues that I found with upgrading a suite of 7 Rails apps from Rails 5.0.2 to Rails 5.1.&lt;/p&gt;

&lt;p&gt;So this morning I upgraded the suite of Rails apps (7 in total) that make up the product that I’ve been building from Rails 5.0.2 to 5.1.3.  I took my usual, slow as a turtle, approach to doing this upgrade (5.1.4 has now reached RC1 status which means that 1 release behind is uite stable by now).  The main change driving my desire to upgrade was the improved low level connection handling in ActiveRecord which should make developing multi-tenant applications better.&lt;/p&gt;

&lt;p&gt;Here are a few notes on upgrading to Rails 5.1.&lt;/p&gt;

&lt;h1 id=&quot;the-lines-to-change-in-gemfile&quot;&gt;The Lines to Change in Gemfile&lt;/h1&gt;

&lt;p&gt;Previously I had:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem 'rails', '~&amp;gt; 5.0.2'
gem 'puma', '~&amp;gt; 3.0'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;which I changed to&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem 'rails', '~&amp;gt; 5.1.3'
gem 'puma', '~&amp;gt; 3.10'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The reason for the Puma update turned out to be unneeded but it is a core part of my stack so it is likely good to upgrade.&lt;/p&gt;

&lt;h1 id=&quot;useful-links&quot;&gt;Useful Links&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://edgeguides.rubyonrails.org/5_1_release_notes.html&quot;&gt;Rails 5.1 Readme&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rubygems.org/gems/puma/versions/3.4.0&quot;&gt;Ruby Gems on Puma&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rubygems.org/gems/rails/versions/5.0.0&quot;&gt;Ruby Gems on Rails&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;dont-be-afraid-to-delete-gemfilelock-and-re-bundle&quot;&gt;Don’t Be Afraid to Delete Gemfile.lock and Re Bundle&lt;/h1&gt;

&lt;p&gt;Out of my seven apps, all built on top of the same version of Rails, two had problems with:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle update rails puma&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;These two applications had issues with the font-awesome-rails gem and railties.  Rather than try and monkey around with them, I simply did a:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;git rm Gemfile.lock&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;and then a:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle install&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;And that fixed everything.&lt;/p&gt;

&lt;h1 id=&quot;puma-now-needs-a-space-before-the-port&quot;&gt;Puma Now Needs a Space Before the Port&lt;/h1&gt;

&lt;p&gt;Right after my Rails update and before I did the Puma update, I got this bit of joy when I started my server:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bundle exec rails s -p3203
=&amp;gt; Booting Puma
=&amp;gt; Rails 5.1.3 application starting in development on http://localhost:3203
=&amp;gt; Run `rails server -h` for more startup options
Puma starting in single mode...
* Version 3.10.0 (ruby 2.3.1-p112), codename: Russell's Teapot
* Min threads: 2, max threads: 2
* Environment: development
* Listening on tcp://
Exiting
/Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `initialize': getaddrinfo: nodename nor servname provided, or not known (SocketError)
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `new'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `add_tcp_listener'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:105:in `block in parse'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:88:in `each'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:88:in `parse'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/runner.rb:144:in `load_and_bind'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/single.rb:87:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/launcher.rb:183:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/rack/handler/puma.rb:69:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/rack-2.0.3/lib/rack/server.rb:297:in `start'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:44:in `start'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:131:in `block in perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:126:in `tap'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:126:in `perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor/command.rb:27:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor/invocation.rb:126:in `invoke_command'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor.rb:387:in `dispatch'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/command/base.rb:63:in `perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/command.rb:44:in `invoke'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands.rb:16:in `&amp;lt;top (required)&amp;gt;'
        from /Users/sjohnson/Dropbox/fuzzygroup/hyde/seira_watch/seira_admin/bin/rails:9:in `require'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This turned out to be a change somewhere in Rails where a space is now needed between the -p and the port number, so this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle exec rails s -p3203&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;needs to be:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle exec rails s -p 3203&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This was covered in this &lt;a href=&quot;https://github.com/rails/rails/issues/28971&quot;&gt;Github Issue&lt;/a&gt;. Supposedly the latest version of Puma restores the previous functionality where a space isn’t needed but I have &lt;strong&gt;NOT&lt;/strong&gt; found that to be so.  The solution was to simply accept that a space after -p is required.  Technically I could have not upgraded Puma but it feels like running the current version of is always a good thing.&lt;/p&gt;

&lt;h1 id=&quot;middleware-now-needs-a-class-constant-not-a-string&quot;&gt;Middleware Now Needs a Class Constant Not a String&lt;/h1&gt;

&lt;p&gt;What I am building uses a multi-tenant approach based on the &lt;a href=&quot;https://github.com/influitive/apartment&quot;&gt;Apartment gem&lt;/a&gt; and this requires an initializer that specifies a middleware layer.  Prior to Rails 5.1, this was done as follows:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rails.application.config.middleware.use 'Apartment::Elevators::Subdomain'
(in config/initializers/apartment.rb)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;When I first started my application using Rails 5.1, I got this unpleasant result:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; bundle exec rails s -p 3210
=&amp;gt; Booting Puma
=&amp;gt; Rails 5.1.3 application starting in development on http://localhost:3210
=&amp;gt; Run `rails server -h` for more startup options
Exiting
/Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:35:in `build': undefined method `new' for &quot;Apartment::Elevators::Subdomain&quot;:String (NoMethodError)
Did you mean?  next
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `block in build'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `each'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `inject'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `build'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:508:in `block in app'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:504:in `synchronize'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:504:in `app'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/application/finisher.rb:45:in `block in &amp;lt;module
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Apparently middleware layers that used to take a string now need a class constant so this needs to be rewritten as:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rails.application.config.middleware.use Apartment::Elevators::Subdomain
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This is discussed in this &lt;a href=&quot;https://github.com/rails/rails/issues/28946&quot;&gt;Rails Issue&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&quot;skipbeforefilter-is-now-skipbeforeaction&quot;&gt;skip_before_filter Is Now skip_before_action&lt;/h1&gt;

&lt;p&gt;Although I was able to start my application correctly in development mode with a still in place skip_before_filter, when I tried it in production, I got:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;=&amp;gt; Run `rails server -h` for more startup options
Exiting
/Users/sjohnson/Dropbox/fuzzygroup/hyde/seira_watch/seira_watch_web_app/app/controllers/api_controller.rb:3:in   `&amp;lt;class:ApiController&amp;gt;': undefined method `skip_before_filter' for ApiController:Class (NoMethodError)
Did you mean?  skip_before_action
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This was an easy change but it is still something that could easily trip you up.  Obviously I have been seeing the deprecation warnings for some time now and it is my bad for not having made these changes.&lt;/p&gt;

&lt;h1 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h1&gt;

&lt;p&gt;While mildly annoying these are relatively small issues htat I was able to work around quite cleanly.  The total time to upgrade 7 Rails apps from 5.0.2 to 5.1 was less than an hour in total even including the research and deploy time.  &lt;strong&gt;Recommended&lt;/strong&gt;.&lt;/p&gt;

&lt;h1 id=&quot;public-service-announcement&quot;&gt;Public Service Announcement&lt;/h1&gt;

&lt;p&gt;If you haven’t upgraded your Ruby Gems executable, you likely should.  &lt;a href=&quot;https://www.ruby-lang.org/en/news/2017/08/29/multiple-vulnerabilities-in-rubygems/&quot;&gt;More details are here&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Fri, 01 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/09/01/notes-on-upgrading-to-rails-5-1.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/09/01/notes-on-upgrading-to-rails-5-1.html</guid>
        
        <category>rails</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Running out of Disc Space with Docker</title>
        <description>&lt;p&gt;I’ve now been exploring &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; for almost a year now and using it daily for five months or so.  And, as I get ever closer to shipping a product that runs using containers for everything, I have been continually hitting issues regarding running out of disc space.&lt;/p&gt;

&lt;h1 id=&quot;understanding-the-problem&quot;&gt;Understanding The Problem&lt;/h1&gt;

&lt;p&gt;The platform I have been using is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Docker Community Edition, Docker version 17.06.0-ce, build 02c1d87&lt;/li&gt;
  &lt;li&gt;AWS EC2 instances including ELB&lt;/li&gt;
  &lt;li&gt;No use of Kubernetes or the AWS ECS&lt;/li&gt;
  &lt;li&gt;Ubuntu Linux&lt;/li&gt;
  &lt;li&gt;Docker Hub for image hosting&lt;/li&gt;
  &lt;li&gt;Rails / Ruby as an application language&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What I have experienced is constant growth in disc space usage ultimately ending up in 0 bytes of free disc space and subsequent failure conditions in most of my containers.&lt;/p&gt;

&lt;h1 id=&quot;docker-on-linux-basics&quot;&gt;Docker on Linux Basics&lt;/h1&gt;

&lt;p&gt;On Ubuntu and most Linux platforms that I understand, the core Docker installation of your data is stored in /var/lib/docker and then a collection of subdirectories.  Here’s an example:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ls -l /var/lib/docker
total 44
drwx------ 21 root root  4096 Aug 30 01:17 containers
drwx------  3 root root  4096 Aug 30 01:10 image
drwxr-x---  3 root root  4096 Aug 30 01:10 network
drwx------ 85 root root 12288 Aug 30 01:17 overlay2
drwx------  4 root root  4096 Aug 30 01:10 plugins
drwx------  2 root root  4096 Aug 30 01:10 swarm
drwx------  2 root root  4096 Aug 30 01:16 tmp
drwx------  2 root root  4096 Aug 30 01:10 trust
drwx------ 12 root root  4096 Aug 30 03:01 volumes
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;There are two interesting directories here: containers and overlay2.  You should note that on a default docker installation the overlay2 directory would be named aufs.  The directories overlay2 and aufs are different filesystems that Docker can use to store your containers, volumes, etc.  The default Docker filesystem is called aufs and it is the oldest Docker filesystem.  The overlay2 filesystem is newer and seems to have some dramatic advantages.&lt;/p&gt;

&lt;p&gt;I am currently involved in what is termed &lt;em&gt;green field&lt;/em&gt; software development – this is a development term related to creating a brand new product i.e. everything is a green field waiting to be plowed.  One of the characteristics of green field development is a &lt;strong&gt;lot&lt;/strong&gt; of deploys.  As I initially looked into this problem, its characteristics seemed to map directly to the number of deploys – more deploys meant more disc space used.  When you see this type of situation, it tends to argue that the underlying issue is somehow tied to garbage collection.  My research and analysis of this led me to think that the issue was somehow tied to issues in the Docker aufs filesystem and I switched my installation from aufs to overlay2 and thought it was resolved.&lt;/p&gt;

&lt;p&gt;Last night I started getting alerts that my production server was again almost out of disc space (thank you &lt;a href=&quot;https://github.com/arnaudsj/monit&quot;&gt;Monit!&lt;/a&gt;).  Now the interesting thing is that between when I thought this was resolved and last night, I &lt;strong&gt;have not been deploying at all&lt;/strong&gt;.  Over the past 5 days, I have been involved in an intense refactor of my new product’s two core &lt;a href=&quot;https://en.wikipedia.org/wiki/God_object&quot;&gt;god objects&lt;/a&gt; - course.rb and teacher.rb.  In software development parlance, a god object is an object that knows too much or does too much and it is regarded as an &lt;a href=&quot;https://en.wikipedia.org/wiki/Anti-pattern&quot;&gt;anti pattern&lt;/a&gt;.  When you do this type of refactoring, it tends to shut down everything since it breaks, well, &lt;strong&gt;everything&lt;/strong&gt;.  Seeing that I was again running out of disc space – while I wasn’t deploying – argued that my working theory was just plain &lt;strong&gt;wrong&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;My next step was to ssh into the box (yes, even with a containerized architecture, there are still servers and sshing in is still a thing) and look into /var/lib/docker once again.  My general tool for this was the command du -shc *  which translates to “show me the disc space usage at a summary level and translate it to human style (i.e. k / megs / gigs)”.  Here’s an example of my command flow:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su - 
cd /var/lib/docker
du -shc * 

du -shc *
10G	containers
11M	image
140K	network
3.4G	overlay2
20K	plugins
4.0K	swarm
4.0K	tmp
4.0K	trust
3.3M	volumes
13.5G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I started to wonder what could possibly be in the containers directory with a size of &lt;strong&gt;10G&lt;/strong&gt; so I changed into that directory and I found an anomaly, a single file, 6.2 gigs in size, like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;586e6e0b559281785d023097518ed9303e15db66eee04173792856ff7b2da528-json.log
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;When I looked at that file, it was a log file showing the log output from the underlying crawler at the coder of the product I have been building.  And with this one discovery, the problem came into focus:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;While there may have been issues related to a constant ongoing deploy process, the core underlying issue seems to be disc usage due to log file build up.&lt;/li&gt;
  &lt;li&gt;Docker makes it very hard to see the underlying problem since there doesn’t seem to be a “where is my damn disc space going” type of command.  Update: Try using “docker system df” to visualize docker disc space usage.  I only found this late in the writing process on this post.  The docker system df command doesn’t specifically report log file space usage which I suspect would illuminate this problem.&lt;/li&gt;
  &lt;li&gt;Logs appear to be persistent over time and not reclaimed as you deploy.  My suspicion is that logs are only reset when you stop the Docker daemon (and sometimes not even then).&lt;/li&gt;
  &lt;li&gt;Traditional log management like log rotate won’t work unless you restart the Docker daemon.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Sidebar&lt;/strong&gt;: I wonder how many people that have struggled with this issue have actually had log file growth issues not actual Docker problems?  Most of the unresolved Docker / Moby issues below don’t explore the logs possibility.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;It should be noted that I’m not logging to files from within my application code and I’m using the log to standard out approach from the &lt;a href=&quot;https://github.com/nickjj/orats&quot;&gt;Orats gem&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;fixing-this-problem-once-and-for-all&quot;&gt;Fixing this Problem Once and For All&lt;/h1&gt;

&lt;p&gt;Here are the steps that I took to address this problem:&lt;/p&gt;

&lt;h2 id=&quot;step-1-stop-the-docker-daemon&quot;&gt;Step 1: Stop the Docker Daemon&lt;/h2&gt;

&lt;p&gt;The first step is shutting down Docker itself:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo service docker stop&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;step-2-delete-varlibdocker&quot;&gt;Step 2: Delete /var/lib/docker&lt;/h2&gt;

&lt;p&gt;The next step appears drastic and it is.  If you have important data in your Docker system then you’re going to lose it at this stage but when I attempted to do this piecemeal, I got bizarre deployment errors related to missing containers and even redeploying did not fix it.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su
umount /var/lib/docker/overlay2
cd /var/lib/docker
rm -rf * 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This blows away everything in your Docker installation.  The second command line is only necessary if you have already switched your system to overlay2 as I had.&lt;/p&gt;

&lt;h2 id=&quot;step-3-switch-from-aufs-to-overlay2-and-add-log-limits-to-docker-config&quot;&gt;Step 3: Switch from aufs to overlay2 and Add Log Limits to Docker Config&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: Full use of the overlay2 driver is covered &lt;a href=&quot;https://docs.docker.com/engine/userguide/storagedriver/overlayfs-driver/#configure-docker-with-the-overlay-or-overlay2-storage-driver&quot;&gt;here&lt;/a&gt; and should probably be read before you make this switch.  Not everyone can make use of overlay2.&lt;/p&gt;

&lt;p&gt;The core docker config file is:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/docker/daemon.json&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You should edit this file and make it look something like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;storage-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;overlay2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;log-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;log-opts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;max-size&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;100m&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Disclaimer&lt;/strong&gt;: I’m honestly not 100% certain that switching from aufs to overlay2 is absolutely required but it was a part of the overall solution and does seem to have benefits so I left it in here although I suspect that the logging is clearly the biggest win here.&lt;/p&gt;

&lt;h2 id=&quot;step-4-restart-docker-daemon&quot;&gt;Step 4: Restart Docker Daemon&lt;/h2&gt;

&lt;p&gt;Start Docker up again:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo service docker start&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;step-5-add-logging-limits-to-your-compose-files&quot;&gt;Step 5: Add Logging Limits to Your Compose Files&lt;/h2&gt;

&lt;p&gt;On your local machine where you do your development, you need to set the logging options on a per container basis to your docker-compose file.  The lines to add are to each service are:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;logging:
  options:
    max-size: 50m
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Here’s an example in the context of a full container:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;services:
  redis:
    image: 'redis:3.2-alpine'
    ports:
      - '6379'
    volumes:
      - 'redis:/var/lib/redis/data'
    restart: on-failure
    logging:
      options:
        max-size: 50m
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Theoretically I could have ignored this at a per container level and just relied on the log management defined in /etc/docker/daemon.json but when you have a system level config file, that often gets changed and not checked into version control, belt &lt;strong&gt;and&lt;/strong&gt; suspenders is better.  Setting this at the application level and the system level should ensure that I don’t get bit by this again.  This will also protect your local dev box from unlimited log growth which could otherwise be a problem since your local dev box isn’t configured by the same /etc/docker/daemon.json file.&lt;/p&gt;

&lt;h2 id=&quot;add-cron-jobs-for-removing-unused-stuff-periodically&quot;&gt;Add Cron Jobs for Removing Unused Stuff Periodically&lt;/h2&gt;

&lt;p&gt;I added cron jobs to my underlying instance for cleaning up after dangling containers and volumes:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#Ansible: docker rmi images
1 1 * * * docker rmi -f $(docker images -a -q -f dangling=true)
#Ansible: docker volume rm
1 3 * * * docker volume rm -f $(docker volume ls -q -f dangling=true)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The #Ansible comment indicates that these were added by Ansible as part of my machine provisioning script (Step 8 below is now also part of that same script).&lt;/p&gt;

&lt;h2 id=&quot;step-7-get-etcdockerdaemonjson-into-ansible--version-control&quot;&gt;Step 7: Get /etc/docker/daemon.json into Ansible / Version Control&lt;/h2&gt;

&lt;p&gt;However you configure a new instance, you should make sure that your modified daemon.json file from Step 3 is part of that process or you’ll find that setting up a new machine has this same problem.&lt;/p&gt;

&lt;h2 id=&quot;step-8-redeploy-everything&quot;&gt;Step 8: Redeploy Everything&lt;/h2&gt;

&lt;p&gt;The final step is to re-deploy everything as all containers, volumes, etc have been deleted earlier in the process.  Hopefully you will find that your disc space usage comes under control.&lt;/p&gt;

&lt;h1 id=&quot;sidebar-1-docker-system-df&quot;&gt;Sidebar 1: docker system df&lt;/h1&gt;

&lt;p&gt;As I was finishing this post, I found the command docker system df which shows you the space docker uses.  Here’s an example from my local dev box:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FuzzygroupMacbookPro2016% docker system df
TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              671                 67                  40.59GB             24.07GB (59%)
Containers          84                  5                   742.2MB             718MB (96%)
Local Volumes       41                  22                  634.5MB             1.553kB (0%)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;sidebar-2-docker-system-prune&quot;&gt;Sidebar 2: docker system prune&lt;/h1&gt;

&lt;p&gt;The command docker system prune reclaims dangling images and stopped containers.  Here’s an example:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FuzzygroupMacbookPro2016% docker system prune
WARNING! This will remove:
        - all stopped containers
        - all networks not used by at least one container
        - all dangling images
        - all build cache
Are you sure you want to continue? [y/N] y
Deleted Containers:
4fc625609ac8f86f8d8f9076a8e75d5ccb31c1e871ed6f4589b79de2721af02c
... (A long, long list of containers was here)
Total reclaimed space: 28.72GB
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The interesting thing here is that before I ran this I had 46 gigs of free space on my local dev box and after I ran this, I still had 46 gigs free.  I don’t know why Docker states that it reclaimed space when it doesn’t.&lt;/p&gt;

&lt;p&gt;Note: I’m not the only person who can’t reclaim this space.&lt;/p&gt;

&lt;h1 id=&quot;what-to-learn-from-this&quot;&gt;What to Learn from This&lt;/h1&gt;

&lt;p&gt;I would argue that the big takeaway from this isn’t actually the specific Docker commands, useful as they are, but the observation that disc space growth wasn’t tied to deploys but instead to system operation.  Realizing this changed how I approached the problem.  When you build complex systems, learning how to observe them and then correlating that with what you are doing to the system is a key technique.&lt;/p&gt;

&lt;h1 id=&quot;thank-yous&quot;&gt;Thank Yous&lt;/h1&gt;

&lt;p&gt;Most of what I know about Docker, I learned from the courses of &lt;a href=&quot;https://diveintodocker.com/&quot;&gt;Nick Janetakis&lt;/a&gt;.  He is a friend and he pitched in greatly on the analysis and resolution of this.  Thanks man!&lt;/p&gt;

&lt;h1 id=&quot;references&quot;&gt;References&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://blog.idetailaid.co.uk/docker-using-up-all-your-disk-space-dont-forget-to-clean-up-after-docker/&quot;&gt;Interesting Blog Post about Cleaning Up After Docker&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.google.com/search?tbs=li:1&amp;amp;q=how+much+space+are+my+docker+logs+taking&quot;&gt;Docker Logs on Stack Overflow&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/3804&quot;&gt;Docker Disc Space Quotas and aufs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://thehftguy.com/2016/11/01/docker-in-production-an-history-of-failure/&quot;&gt;Docker in Production a History of Failure&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=12872304&quot;&gt;Docker in Production a History of Failure&lt;/a&gt; (search for overlay2)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/22207&quot;&gt;Docker not Cleaning Up tmp Files&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/29486&quot;&gt;Docker Orphaned Diffs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.docker.com/engine/userguide/storagedriver/overlayfs-driver/&quot;&gt;Using Overlay2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.github.com/stanislavb/6634fc35b3d1655201a93d2dd2c3a366&quot;&gt;A seemingly good shell script for cleaning up after Docker&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Wed, 30 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/08/30/running-out-of-disc-space-with-docker.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/08/30/running-out-of-disc-space-with-docker.html</guid>
        
        <category>docker</category>
        
        <category>aufs</category>
        
        <category>disc_space</category>
        
        <category>bloat</category>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>When Gems Won't Install - The mkmf.log Problem</title>
        <description>&lt;p&gt;Computing is rich enough and deep enough as a profession that you can spent literally over a decade at something and still learn new things.  And, as frustrating as this is, I find that one of the best parts.   Personally I’ve been using Ruby now since 2006 and one of the things that is absolutely bedeviling is when a gem won’t install.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Upfront Disclaimer&lt;/strong&gt;: This problem was one of my own making but it proved to be an interesting exercise as I waited for someone to arrive for a meeting.  Far better than simply surfing the web or playing on my phone.&lt;/p&gt;

&lt;p&gt;I was trying to get the &lt;a href=&quot;https://github.com/feedbin/feedbin&quot;&gt;FeedBin&lt;/a&gt; aggregator to install so I did the usual open source Rails dance:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;fork it&lt;/li&gt;
  &lt;li&gt;clone it&lt;/li&gt;
  &lt;li&gt;bundle install&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And, WHAM, this gave me the wonderfulness below:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Gem::Ext::BuildError: ERROR: Failed to build gem native extension.

    current directory: /Users/sjohnson/.rvm/gems/ruby-2.3.1@feedbin/gems/nio4r-2.1.0/ext/nio4r
/Users/sjohnson/.rvm/rubies/ruby-2.3.1/bin/ruby -r ./siteconf20170828-91881-jc70x3.rb extconf.rb
--with-cflags=-std=c99
checking for unistd.h... *** extconf.rb failed ***
Could not create Makefile due to some reason, probably lack of necessary
libraries and/or headers.  Check the mkmf.log file for more details.  You may
need configuration options.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Nothing like an abstractly referenced log file &lt;strong&gt;WITHOUT A FULL PATH&lt;/strong&gt; to be completely unhelpful.  I’ve been seeing references to mkmf.log about as long as Gems have been in common usage and I’ve never understood exactly where that persnickety file was located.  Normally a quick Google or Stack Overflow gives me the answer but this time those just weren’t helpful.  What I did &lt;a href=&quot;https://stackoverflow.com/questions/20379274/when-a-gem-fails-where-do-i-find-the-mkmf-log-file&quot;&gt;discover&lt;/a&gt; was that the mkmf.log file is bundled with the gem where it is built.  Given that I use RVM, the example was to look in a path like this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;~/.rvm/gems/ruby-1.9.3-p194/gems/some-cool-gem-name/ext/mkmf.log&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I started with this find command:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;find ~/.rvm -name mkmf.log&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;and that produced a huge number of results, 995 to be specific (a decade or more of hacking Ruby stuff will do that).&lt;/p&gt;

&lt;p&gt;This took me into adding a grep to the end:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;table&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;find ~/.rvm -name mkmf.log&lt;/td&gt;
        &lt;td&gt;grep nio4r&lt;/td&gt;
      &lt;/tr&gt;
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/blockquote&gt;

&lt;p&gt;which still gave me a full page of output so I added feedbin as a secondary grep:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;table&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;find ~/.rvm -name mkmf.log&lt;/td&gt;
        &lt;td&gt;grep nio4r&lt;/td&gt;
        &lt;td&gt;grep feedbin&lt;/td&gt;
      &lt;/tr&gt;
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/blockquote&gt;

&lt;p&gt;which finally produced:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;/Users/sjohnson/.rvm/gems/ruby-2.3.1@feedbin/extensions/x86_64-darwin-15/2.3.0/nio4r-2.1.0/mkmf.log&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Digging into that file revealed this error:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;xcrun: error: active developer path (&quot;/Applications/Xcode.app/Contents/Developer&quot;) does not exist, use `xcode-select --switch path/to/Xcode.app` to specify the Xcode that you wish to use for command line developer tools (or see `man xcode-select`)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;So somehow XCode is missing and I’m certain that’s my fault (this isn’t my primary dev box so perhaps it got deleted at some point to save disc space).&lt;/p&gt;
</description>
        <pubDate>Mon, 28 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/08/28/when-gems-won-t-install-the-mkmf-log-problem.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/08/28/when-gems-won-t-install-the-mkmf-log-problem.html</guid>
        
        <category>rails</category>
        
        <category>ruby</category>
        
        <category>gems</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Rails, Apartment, Tenancy and Sidekiq</title>
        <description>&lt;h1 id=&quot;tldr&quot;&gt;TLDR&lt;/h1&gt;

&lt;p&gt;This is a long one.  If you need the quick answer on how to solve Apartment-Sidekiq errors then scroll down to the section titled &lt;strong&gt;Correctly Implementing Sidekiq with Apartment&lt;/strong&gt;.&lt;/p&gt;

&lt;h1 id=&quot;thanks&quot;&gt;Thanks&lt;/h1&gt;

&lt;p&gt;This blog post is dedicated to three people / things:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;My good friend &lt;a href=&quot;https://www.nickjanetakis.com&quot;&gt;Nick Janetakis&lt;/a&gt; who helped me debug these issues&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.mikeperham.com&quot;&gt;Mike Perham&lt;/a&gt;, the author of &lt;a href=&quot;https://www.contribsys.com&quot;&gt;Sidekiq&lt;/a&gt;, whose candor about Apartment-Sidekiq helped point the way&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://influitive.com/&quot;&gt;Influitive&lt;/a&gt; team at the Apartment gem; great work guys, thank you&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;overview&quot;&gt;Overview&lt;/h1&gt;

&lt;p&gt;Tenancy in database application development refers to using a separate storage system (think a partition within a database) or a whole separate database per “user” (note that user might mean a group of people).  The idea behind tenancy is to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Isolate one user from another; this tends to provide a much more secure approach&lt;/li&gt;
  &lt;li&gt;Isolate storage so that the capacity needs of one user don’t affect other users&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Tenancy is something that we don’t often think about but examples of it abound on the Internet.  The best known example is Wordpress.com where every user’s data is stored in a separate database.&lt;/p&gt;

&lt;p&gt;I’ve been developing a new product for sometime now and I went into it knowing that if I was successful, storage was going to be a huge issue.  When I first developed &lt;a href=&quot;https://web.archive.org/web/20100610030143/http://www.appdata.com:80/&quot;&gt;AppData&lt;/a&gt; I had no idea that I was beginning a near [decade long]*https://web.archive.org/web/20160905051931/http://www.appdata.com/ cycle of struggling with storage.  As with all engineers, I was determined to at least not hit the same errors (better to make different ones) so I knew that I needed a tenancy solution for my development platform, Rails, and that led me to the &lt;a href=&quot;https://github.com/influitive/apartment&quot;&gt;Apartment gem&lt;/a&gt;.  Apartment views tenancy as a problem of managing the underlying database connection so that when you goto foo.app.com, foo generally represents the underlying database or “tenant”.&lt;/p&gt;

&lt;h1 id=&quot;enter-sidekiq-enter-tenancy-problems&quot;&gt;Enter Sidekiq; Enter Tenancy Problems&lt;/h1&gt;

&lt;p&gt;When you develop a web application you are quickly going to discover the need for asynchronous processing.  This is a fancy term that could be defined as “don’t make the user wait while a long running operation completes”.  Let’s consider the very simple case of sending an email with account details once a user signs up.  Sending that email might be instantaneous or the email server might have problems and might take a few seconds.  By handling this operation asynchronously, the email is send by a separate process and control to the user returns instantly.  In the Rails world the leading technology for this is an open source tool called Sidekiq and Sidekiq is a fantastic bit of code.  It runs as a background daemon coupled to your application through Redis and its multi threading scalably handles all kinds of asynchronous needs.  In the past I’ve used it to handle email deliveries, data imports, whole site crawling and more.&lt;/p&gt;

&lt;p&gt;The problem I’ve been struggling with for sometime now is handling back data imports.  My new product has a cool feature – you sign up and the back history for your account is imported from a central data archive.  I wanted to avoid the problems with a data tool where data builds over time.  My goal was for people to sign up and then be instantly product, not productive after a week of data acquisition, at which point they might have stopped caring due to the waiting.  This was clearly a job for Sidekiq but how could that work since the underlying database connection changed for every single user?&lt;/p&gt;

&lt;p&gt;My tenancy solution was a Ruby gem called Apartment and there is actually an extension gem called &lt;a href=&quot;https://github.com/influitive/apartment-sidekiq&quot;&gt;Apartment-Sidekiq&lt;/a&gt;.  What apartment sidekiq purports to do is push into the redis stream a reference to the tenant and then patch sidekiq so that every time it processes the redis data it will connect to the right tenant.  The problem here is that this seems to only sort of work.  For the past two weeks or so my asynchronous code has worked – but with errors.  Sometime I would see 1 error related to tenancy when a back data import was processed and sometimes I would see 26 errors per import.&lt;/p&gt;

&lt;h2 id=&quot;the-solution---dont-use-apartment-sidekiq&quot;&gt;The Solution - Don’t Use Apartment Sidekiq&lt;/h2&gt;

&lt;p&gt;This problem was on my radar for quite a while and then I finally said “Ok I can’t ship until this is addressed” and I’ve been working it for the past two days.  Understanding the solution came from this &lt;a href=&quot;https://github.com/mperham/sidekiq/issues/3005&quot;&gt;Github Issue&lt;/a&gt;.  The key bit of wisdom is here:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Just as a side note, passing the tenant as a job argument is a hack. The correct way to implement a cross-cutting concern (like tenant) is with client and server middleware. You just need to copy and configure the two bits of code &lt;a href=&quot;https://github.com/influitive/apartment-sidekiq/tree/master/lib/apartment/sidekiq/middleware&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When you work with an open source project like Sidekiq, understanding who the people involved are is key because it tells you who to trust.  I’ve now used Sidekiq for years and years and I trust Mike implicitly when it comes to these matters.  When Mike Perham, the author of Sidekiq, describes something as a &lt;strong&gt;hack&lt;/strong&gt;, well, that tells me there might be real issues.&lt;/p&gt;

&lt;p&gt;I looked at the related &lt;a href=&quot;https://stackoverflow.com/questions/41229392/why-is-apartment-sidekiq-not-finding-the-tenant/41471241#41471241&quot;&gt;Stack Overflow&lt;/a&gt; but no where did I have a problem with my environment and that also didn’t mesh which Mikes comment about passing the tenant as a job argument.  Sorting through all kinds of tenancy issues took me different places:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/influitive/apartment-sidekiq/issues/10&quot;&gt;Possible Version Conflicts&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/influitive/apartment-sidekiq/issues/12#ref-pullrequest-190952852&quot;&gt;Maybe It is Rails 5&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/influitive/apartment-sidekiq/issues/11&quot;&gt;More Perham Commentary&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In the More Perham Commentary, I found this bit of wisdom:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;@andrba the intention cannot be done safely. You need to explicitly switch and cleanup any connections. I hate that callback and wish I’d never implemented it.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When something like the &lt;em&gt;underlying callback&lt;/em&gt; on which Apartment-Sidekiq is described in this way it made me realize, “Hm… this isn’t going to work, is it”.&lt;/p&gt;

&lt;h2 id=&quot;correctly-implementing-sidekiq-with-apartment&quot;&gt;Correctly Implementing Sidekiq with Apartment&lt;/h2&gt;

&lt;p&gt;Once I accepted that I couldn’t use the Apartment-Sidekiq gem, the solution was pretty obvious:&lt;/p&gt;

&lt;h3 id=&quot;step-1-remove-apartment-sidekiq-from-gemfile&quot;&gt;Step 1: Remove Apartment-Sidekiq from Gemfile&lt;/h3&gt;

&lt;p&gt;This was pretty easy - just delete one line and then run bundle install.&lt;/p&gt;

&lt;h3 id=&quot;step-2-pass-the-current-tenant-in-my-calls-to-the-sidekiq-worker&quot;&gt;Step 2: Pass the Current Tenant in my Calls to the Sidekiq Worker&lt;/h3&gt;

&lt;p&gt;Most of my import routines are after_create calls that look like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;after_create :import_back_history_sidekiq
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This method looks like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;def import_back_history_sidekiq
  InstructorImportBackHistoryWorker.perform_async(self.id, Apartment::Tenant.current)
end
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;There are two parameters here:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;self.id - Sidekiq is oriented around passing low level primitives not full blown ActiveRecord objects so you pass an id reference to the object you want to do an asynchronous call on and then you reload it in the Sidekiq context.&lt;/li&gt;
  &lt;li&gt;Apartment::Tenant.current - This is a string that represents the name of the current tenant.  We need to know this because the real solution to this entire problem is to switch to the right tenant in our Sidekiq worker code.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;step-3-switching-to-the-right-tenant&quot;&gt;Step 3: Switching to the Right Tenant&lt;/h3&gt;

&lt;p&gt;Here’s what the underlying Sidekiq worker class looks like:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;class InstructorImportBackHistoryWorker
  include Sidekiq::Worker

  def perform(id, tenant)
    Apartment::Tenant.switch!(tenant)
    instructor = Instructor.where(id: id).first
    if instructor
      instructor.import_back_history
    else
      # Some error handling code goes here
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;All this does is invoke Apartment::Tenant.switch!(tenant) at the start of the asynchronous processing and that ensures that the correct tenant is used.  After that the import proceeds as normal.  The reason that I have a wrapper approach (import_back_history versus import_back_history_sidekiq) is that I have cases where I use these calls in batch process routines where I don’t invoke Sidekiq.&lt;/p&gt;

&lt;p&gt;Using this approach to managing tenancy and Sidekiq, I went from multiple tenancy connection errors tracked thru &lt;a href=&quot;http://fuzzyblog.io/blog/aws/2017/08/11/using-errbit-to-host-your-own-error-tracker-on-aws-for-rails-apps.html&quot;&gt;Errbit&lt;/a&gt; to zero errors.&lt;/p&gt;

&lt;h1 id=&quot;references&quot;&gt;References&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/questions/41229392/why-is-apartment-sidekiq-not-finding-the-tenant&quot;&gt;Apartment-Sidekiq Stack Overflow&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/influitive/apartment-sidekiq/issues/11&quot;&gt;Long Error Thread&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Mon, 21 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/08/21/rails-apartment-tenancy-and-sidekiq.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/08/21/rails-apartment-tenancy-and-sidekiq.html</guid>
        
        <category>rails</category>
        
        <category>apartment</category>
        
        <category>tenancy</category>
        
        <category>multi_tenant</category>
        
        <category>sidekiq</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Marketing 101 - Ride the Wave If You Can</title>
        <description>&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: I haven’t written a Marketing 101 piece since 2003 but a friend recently pointed out that even &lt;a href=&quot;http://fuzzyblog.io/blog/tag.html#marketing101&quot;&gt;my old ones&lt;/a&gt; were pretty good so I’m giving it a shot.&lt;/p&gt;

&lt;p&gt;One of the more difficult things in marketing to grasp is the idea of a &lt;em&gt;wave&lt;/em&gt;.  I don’t know if there’s a better term for this but wave is how I’ve been thinking of this for the better part of two decades now.  A wave is an underlying meme or movement that resonates at the industry or even society level and I think the best way to illustrate this is with an example.  My first company, founded in 1987, was a hypertext authoring system (think FrontPage with an integrated browser but back in the DOS days).  There was a small burst of interest in all things hyper* due to Apple’s HyperCard but that pretty much subsided by late 1988 / early 1999.  And then, over the next few years the industry shifted, in a huge way, to &lt;strong&gt;multimedia&lt;/strong&gt;.  Multimedia became a huge wave – and we shifted our product features slightly and our marketing dramatically to ride the multimedia wave:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We added a small handful of features for controlling digital video discs&lt;/li&gt;
  &lt;li&gt;We went to multimedia centric trade shows&lt;/li&gt;
  &lt;li&gt;We adopted the multimedia term and related iconography to all our product literature&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We saw our fortunes increase in parallel with multimedia – there is truth in the old aphorism, &lt;em&gt;a rising tide lifts all boats&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;When you are a teeny, tiny startup, one of the best things that you can do is to &lt;em&gt;ride the wave&lt;/em&gt; when there is a wave.  I’ve been consulting recently with an up and coming online education product and my strongest advice to them has been to position their product as a &lt;em&gt;STEM learning tool&lt;/em&gt;. STEM is the current term in vogue for &lt;em&gt;science, technology, engineering and mathematics&lt;/em&gt; education.&lt;/p&gt;

&lt;p&gt;When you’re a pure technical person, the idea of riding a wave can at times be disturbing.  Technical founders tend to think of their product solely in the context where the original idea.  And, when that wasn’t the wave, repositioning the product in terms of a wave can feel a bit like being a &lt;a href=&quot;http://www.urbandictionary.com/define.php?term=carpet%20bagger&quot;&gt;carpet bagger&lt;/a&gt;.  I’m here to tell you, both as a technical person and a marketer, that this just is &lt;strong&gt;not&lt;/strong&gt; the case.  Waves are often large in nature – what was multimedia after all – and as long as the product is credible in terms of the wave, repositioning can actually benefit both you and the product’s customers:&lt;/p&gt;

&lt;p&gt;For you:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;You get to tap into a market that is growing faster that normal&lt;/li&gt;
  &lt;li&gt;You get access to a set of focused marketing events such as trade shows that are wave focused&lt;/li&gt;
  &lt;li&gt;You get access to a smaller but more focused group of customers&lt;/li&gt;
  &lt;li&gt;Customers are often willing to spend more due to funding specific to the wave (new budgets, grants, etc)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For the customer:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The customer gets a more specific product&lt;/li&gt;
  &lt;li&gt;The customer gets the benefit of at least some wave specific features&lt;/li&gt;
  &lt;li&gt;The customer gets the benefit of a company focusing very specifically on their needs&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Thu, 17 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/marketing/2017/08/17/marketing-101-ride-the-wave-if-you-can.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/marketing/2017/08/17/marketing-101-ride-the-wave-if-you-can.html</guid>
        
        <category>marketing101</category>
        
        
        <category>marketing</category>
        
      </item>
    
      <item>
        <title>10 Steps to Debugging Containerized Applications</title>
        <description>&lt;p&gt;I’ve recently been building a new product using Rails based on an approach that I call &lt;em&gt;Breaking the Monolith&lt;/em&gt;.  Rather than build a traditional Rails monolith, I use multiple microservices / small Rails applications and deploy them all with Docker into a distributed system.  The hardest part about distributed systems is always &lt;strong&gt;debugging&lt;/strong&gt; and I’ve written this guide as a step by step approach for how to go from a misbehaving application right down to a malfunctioning container – this is the actual process that I follow.&lt;/p&gt;

&lt;p&gt;All of this is being done on Ubuntu under AWS but the debugging process applies to any *nix type environment or Platform as a Service (PAAS).&lt;/p&gt;

&lt;h1 id=&quot;disclaimer-but-you-dont-ssh-into-containers&quot;&gt;Disclaimer: But You Don’t SSH into Containers…&lt;/h1&gt;

&lt;p&gt;A lot of the examples below are based around SSH’ing into a server and diagnosing the error in context.  I’ve seen a lot of things since the advent of containers that seemingly want you to believe, that in this brave new world, you just don’t SSH in anymore.  Now, perhaps I am doing things wrong, but I have not found that to be the case at all.  It may be that once I am out of active development that I will no longer be SSH’ing into servers but, for now, SSH is still a dear old friend.&lt;/p&gt;

&lt;h1 id=&quot;failure-context---504-gateway-error&quot;&gt;01: Failure Context - 504 Gateway Error&lt;/h1&gt;

&lt;p&gt;The general system for a failure on this application seems to be a 504 Gateway Error which basically means that the application load balancer (ALB) isn’t receiving output back from one of the HTTP subsystems.&lt;/p&gt;

&lt;h1 id=&quot;check-the-url-in-development-after-a-server-restart&quot;&gt;02.  Check the Url in Development after a Server Restart&lt;/h1&gt;

&lt;p&gt;Every single time you do a deploy with Docker, your entire Gem stack along with any initializers is rebuilt and that means that a stack level change that you made in development but failed to catch can break everything.  So the first diagnosis step is to stop the development server and make sure that things come back up correctly.  Each of my applications runs on a different port so I can’t give a single example here – do the ctrl+c on Puma and then restart it and check the status.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: If you don’t have a simple health check for your application then I would strongly recommend it.  Here’s a &lt;a href=&quot;https://gist.github.com/fuzzygroup/7dec79f94deac117ce591598243f596a&quot;&gt;simple gist showing a /health url&lt;/a&gt; for a Rails application.&lt;/p&gt;

&lt;p&gt;If your Rails app is running on say port 3200 then you can just do:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://localhost:3200/health
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;and you should see:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ok
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;test-the-health-check-logged-into-the-server&quot;&gt;03: Test the Health Check Logged into the Server&lt;/h1&gt;

&lt;p&gt;Once you’ve verified that things are correct in development, the next step is to log into the server and run the same curl test on the server where the failure is occurring.  In order to make this type of debugging extremely simple for me, I run all my applications server side on exactly the same port structure that I do in development.  Even http services like the main web site run on their development port since I can let the load balancer handle translation back to 80.  Having a deployment environment that mirrors development is a huge conceptual boon. Assuming our same 3200 port example, we would:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl http://localhost:3200/health
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;and you should see:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ok
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; If the failure is happening solely within the same subsystem then this usually is sufficient to reveal the problem.&lt;/p&gt;

&lt;h1 id=&quot;check-the-application-docker-logs&quot;&gt;04: Check the Application Docker Logs&lt;/h1&gt;

&lt;p&gt;The next step is the application level Docker logs.  My deployer engine, Dockerano, generates a per application shell script which generates logs for the “main” container called dshell so I see something like this&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./dlogs

web_1        | 2017-08-11T21:51:59.474344180Z /app/config/initializers/constants_global.rb:6: warning: previous definition of REAL_SKYPE was here
web_1        | 2017-08-11T21:51:59.474348492Z /app/config/initializers/constants_system.rb:6: warning: already initialized constant STATUS_OK
web_1        | 2017-08-11T21:51:59.474352887Z /app/config/initializers/constants_global.rb:7: warning: previous definition of STATUS_OK was here
web_1        | 2017-08-11T21:51:59.474356555Z /app/config/initializers/constants_system.rb:7: warning: already initialized constant HYDE_API_KEY
web_1        | 2017-08-11T21:51:59.474360577Z /app/config/initializers/constants_global.rb:8: warning: previous definition of HYDE_API_KEY was here
web_1        | 2017-08-11T21:51:59.783745567Z /app/config/initializers/seira_servers.rb:1: warning: already initialized constant HYDE_API_KEY
web_1        | 2017-08-11T21:51:59.783780705Z /app/config/initializers/constants_system.rb:7: warning: previous definition of HYDE_API_KEY was here
web_1        | 2017-08-11T21:52:00.421398929Z /app/app/controllers/home_controller.rb:124: warning: key :course is duplicated and overwritten on line 129
web_1        | 2017-08-11T21:52:00.421438372Z /app/app/controllers/home_controller.rb:147: warning: key :course is duplicated and overwritten on line 153
web_1        | 2017-08-11T21:52:01.118340090Z * Listening on tcp://0.0.0.0:3210
web_1        | 2017-08-11T21:52:01.118720653Z Use Ctrl-C to stop
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;What this is doing under the hood is a simple:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
docker-compose -f docker-compose.production.yml logs -f -t web
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;check-the-free-disc-space&quot;&gt;05: Check the Free Disc Space&lt;/h1&gt;

&lt;p&gt;As with anything, ever, resource consumption can always be an issue and our normal OS tools include df:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3.9G     0  3.9G 0% /dev
tmpfs           799M   83M  716M11% /run
/dev/xvda1       16G  7.0G  8.5G46% /
tmpfs           3.9G  7.0M  3.9G 1% /dev/shm
tmpfs           5.0M     0  5.0M 0% /run/lock
tmpfs           3.9G     0  3.9G 0% /sys/fs/cgroup
tmpfs           799M     0  799M 0% /run/user/1000
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I spent a lot of time on this project trying desperately to use T2.micro instances because, well, they’re cheap and, at best, it was a false economy.  Severe bloat within the Docker AUFS filesystem found me continually running out of disc space after multiple deploys even though my containers were actually tiny.  This is a &lt;a href=&quot;https://github.com/moby/moby/issues/22207&quot;&gt;known Docker Moby issue&lt;/a&gt; that has been open for over a year and a half now and is still &lt;strong&gt;unassigned&lt;/strong&gt; to anyone.&lt;/p&gt;

&lt;p&gt;In order to avoid this bug, I ended up moving from multiple T2.micro instances to a single m4.large instance and then doubling the underlying storage from 8 gigs to 16.  And, when I did that, a lot of my issues just magically disappeared.  Being cheap truly was a false economy here because I ended up with fewer instances and not only did my reliability go up but my bill went down.&lt;/p&gt;

&lt;h1 id=&quot;check-the-cpu-usage-and-ram-usage&quot;&gt;06: Check the CPU Usage and Ram Usage&lt;/h1&gt;

&lt;p&gt;If you don’t have htop installed on all your instances then you really, really should.  htop kicks the absolute snot out of classic top.  Install it with:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt-get install htop
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;And then invoke it with:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;htop
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;At this point you can easily see the underlying machine load, etc.&lt;/p&gt;

&lt;h1 id=&quot;look-at-individual-container-status&quot;&gt;07: Look at Individual Container Status&lt;/h1&gt;

&lt;p&gt;If you’re having an issue with a given application then you want to look at all the containers for that application.  The easiest way is to grep by name.  Let’s say that your underlying application is called seirawatchwebapp:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker ps | grep seirawatchwebapp
23c1b98a2add        fuzzygroup/seirawatchwebapp_web   &quot;bundle exec clock...&quot;   11 hours ago        Restarting (10) 9 seconds ago                              seirawatchwebapp_clockwork_1
6eb89122ee73        fuzzygroup/seirawatchwebapp_web   &quot;bundle exec sidek...&quot;   11 hours ago        Up 11 hours                                                seirawatchwebapp_sidekiq_1
36f49f07273f        fuzzygroup/seirawatchwebapp_web   &quot;/bin/sh -c 'puma ...&quot;   11 hours ago        Up 11 hours                     0.0.0.0:3210-&amp;gt;3210/tcp     seirawatchwebapp_web_1
49d72363de84        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   11 hours ago        Up 11 hours                     0.0.0.0:32820-&amp;gt;6379/tcp    seirawatchwebapp_redis_1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The thing to be concerned about here is 23c1b98a2add and the reason is that it generally shouldn’t be continuously restarting which is what this view shows.&lt;/p&gt;

&lt;h1 id=&quot;application-level-logs---timberio&quot;&gt;08: Application Level logs - Timber.io&lt;/h1&gt;

&lt;p&gt;I’ve recently started using &lt;a href=&quot;https://www.timber.io&quot;&gt;Timber.io&lt;/a&gt; which is a cross application logging environment and I’ve been very, very happy with it.  If you haven’t looked at Timber.io for your Rails development, I’d recommend it.  Even the free tier is actually quite useful.&lt;/p&gt;

&lt;p&gt;Timber.io is a full web app rather than a command line tool so you need to log into the Timber service and then select your application where you want to view the logs.&lt;/p&gt;

&lt;h1 id=&quot;check-your-error-logger&quot;&gt;09: Check Your Error Logger&lt;/h1&gt;

&lt;p&gt;If you aren’t running a dedicated error tracker, whether HoneyBadger, BugSnag or Errbit, you really, really should.&lt;/p&gt;

&lt;h1 id=&quot;the-answer-check-all-your-containers&quot;&gt;10: The Answer: Check All Your Containers&lt;/h1&gt;

&lt;p&gt;What I’m building is a multi-container system, a distributed system in truth, with formal APIs between each of the components and what this means is that a container failure in subsystem X can affect subsystem Y or subsystem Z without it being clear as to why.  The trouble with this type of debugging is getting a high enough level view to understand it as a whole.&lt;/p&gt;

&lt;p&gt;The easiest way to do this on a single machine is to use the &lt;strong&gt;docker stats&lt;/strong&gt; command:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker stats

CONTAINER           CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS
b17d34bf7268        0.01%               207.6MiB / 7.795GiB   2.60%               1.1MB / 1.53MB      20.5kB / 7.68MB     23
5c5460a763b1        0.00%               210.4MiB / 7.795GiB   2.64%               3.62MB / 900kB      1.18MB / 0B         4
ec28ede65792        0.06%               133.4MiB / 7.795GiB   1.67%               12.9MB / 16.9MB     0B / 0B             9
bb5839c2a6a7        0.00%               130.9MiB / 7.795GiB   1.64%               1.13MB / 1.61MB     86kB / 16.6MB       13
5e78dbc9489e        0.09%               6.215MiB / 7.795GiB   0.08%               16.9MB / 12.9MB     69.6kB / 434kB      3
2d5b14feb009        0.03%               119.3MiB / 7.795GiB   1.49%               8.48MB / 15.4MB     0B / 0B             7
13d42ed0ba35        0.01%               120.7MiB / 7.795GiB   1.51%               2.51MB / 3.88MB     401kB / 37.7MB      12
3fbd80153022        0.08%               6.219MiB / 7.795GiB   0.08%               15.4MB / 8.46MB     24.6kB / 434kB      3
c520fc5504f1        --                  -- / --               --                  --                  --                  --
26ee413fab7f        0.01%               116.2MiB / 7.795GiB   1.46%               1.23MB / 1.62MB     77.8kB / 16.7MB     11
1ab35bf6514c        0.07%               6.219MiB / 7.795GiB   0.08%               85.3kB / 0B         127kB / 0B          3
ac1462fccc60        0.00%               106.1MiB / 7.795GiB   1.33%               1.14MB / 1.37MB     172kB / 7.92MB      10
422787e2d5ab        0.12%               16.15MiB / 7.795GiB   0.20%               75.9MB / 52MB       754kB / 425MB       3
b19bb9629925        0.00%               235.6MiB / 7.795GiB   2.95%               93.4MB / 116MB      508kB / 8.19kB      3
79f484ac7c89        0.18%               388MiB / 7.795GiB     4.86%               6.35GB / 25.4GB     5.24MB / 12.3kB     15
e34789eed4cc        0.00%               108.5MiB / 7.795GiB   1.36%               22.2kB / 17.7kB     0B / 0B             4
6f0cd03996a3        0.12%               116.4MiB / 7.795GiB   1.46%               6.33MB / 13MB       45.1kB / 0B         6
4d8486ff6046        0.23%               344.9MiB / 7.795GiB   4.32%               1.17MB / 1.69MB     1.16MB / 16.7MB     28
4d978af45ff2        0.16%               6.219MiB / 7.795GiB   0.08%               13MB / 6.34MB       102kB / 442kB       3
533d96fc2ce1        0.24%               120.7MiB / 7.795GiB   1.51%               9.18MB / 16.7MB     258kB / 0B          6
6b60a945bff7        0.01%               188.3MiB / 7.795GiB   2.36%               14.5MB / 4.69MB     2.03MB / 0B         10
9c2e8ec55a06        0.10%               6.215MiB / 7.795GiB   0.08%               16.7MB / 9.17MB     369kB / 475kB       3
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The curious thing here is that one container, c520fc5504f1, is showing – for CPU % and all other metrics.  Let’s zoom in on that one.  Personally I find the view above to be more granular than needed and missing the application specific details that I need so my deployer generates a dstats shell script which does this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./dstats 
CONTAINER                      CPU %               MEM USAGE / LIMIT     CONTAINER ID
seirawatchshop_sidekiq_1       --                  -- / --               c520fc5504f1321d44078ea3df8a2f1ffc9147d0cb117564e913596eda76db32
seirawatchshop_web_1           0.01%               91.61MiB / 7.795GiB   cc24d6bcc576cc1ce0c7d04ba8af6b51a1b7599fbbfdcf0c1cb98bd1553e1224
seirawatchshop_redis_1         0.09%               6.215MiB / 7.795GiB   796829845da6dd5f5f63b7449ce3c95581e386e691626344b5b59010b088311d
seirasearch_web_1              0.47%               207.6MiB / 7.795GiB   b17d34bf72689e75f6332f387f964e1e3f2803c3cf544d3bb7de6d7b501c2a38
seirawatchwebapp_clockwork_1   0.01%               210.4MiB / 7.795GiB   5c5460a763b11f4347a0dc806cc7ff5b1314220a9d93ed55f729d4853c1d094f
seirawatchwebapp_sidekiq_1     0.32%               133.4MiB / 7.795GiB   ec28ede65792d435c7b3042909925a17c79182e820dfa16964be151b07241c07
seirawatchwebapp_web_1         0.00%               131MiB / 7.795GiB     bb5839c2a6a7e87e694baa84d1f7b102c54aebde6991203da14836fa60006742
seirawatchwebapp_redis_1       0.14%               6.215MiB / 7.795GiB   5e78dbc9489ecd3b050715b0aa1fe002cebb4636a858e17f93da56f5736aae2d
seirawatchsite_sidekiq_1       0.10%               119.3MiB / 7.795GiB   2d5b14feb009aa4eaf72cde6969bb271a6c81d6cd196a9648a5c64184ffab242
seirawatchsite_web_1           0.02%               121.1MiB / 7.795GiB   13d42ed0ba35bd56ffa0977fde429759f4713ec8e58ae0715e273d040a7a276c
seirawatchsite_redis_1         0.10%               6.219MiB / 7.795GiB   3fbd801530227940730abe8197b24d3e24d52edf9bdfb4145d30e3ae40399418
seirawebappapi_web_1           0.00%               106.1MiB / 7.795GiB   ac1462fccc60a569d86ce0a0b7939a66af42ae07328a261265d90bcc6928c372
seiracrawler_redis_1           0.15%               16.15MiB / 7.795GiB   422787e2d5ab64647fd67a0c9c25af2a8ecdbb7ce3ab0a6bc7ca16ededb5a93b
seiracrawler_rake_1            0.01%               236.5MiB / 7.795GiB   b19bb96299253434c9ea94f4e1c9640b255e5f359c3af7060acd49a6070ffc01
seiracrawler_sidekiq_1         0.14%               400MiB / 7.795GiB     79f484ac7c8958742dc744da0404652ff100a9e299080014a4d64b5b78ea000c
seiraadmin_clockwork_1         0.01%               108.5MiB / 7.795GiB   e34789eed4cc4a6bf7173ef3f278033799272e116f3f670ceb0754b521065b0d
seiraadmin_sidekiq_1           0.08%               116.4MiB / 7.795GiB   6f0cd03996a3414ee7bc0c3fb76adb542d06e3c1c0f7fa1fe108f156a9d9ac0f
seiraadmin_web_1               0.25%               121.3MiB / 7.795GiB   4d8486ff604656515f0e0e433b99486cf91131ce4a93b82701aa42ef77015155
seiraadmin_redis_1             0.11%               6.219MiB / 7.795GiB   4d978af45ff2db55c08212e404264422a39f4ee4fa4b6656b149a37df65bf147
shouldigem_sidekiq_1           0.06%               120.7MiB / 7.795GiB   533d96fc2ce1fb492faa477dfd171e370a30c107becce00e5a52d56bfe3b2622
shouldigem_web_1               0.10%               187.1MiB / 7.795GiB   6b60a945bff74748f3c447ff7b57f75ef12518758c79e75bd587d59531771f3e
shouldigem_redis_1             0.09%               6.215MiB / 7.795GiB   9c2e8ec55a066d382d0ee0ceadfb3e061196127f6b334e16b73e43551ee4f435
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Note 1: Source for dstats is &lt;a href=&quot;https://gist.github.com/fuzzygroup/b4293b4a7d15a9d8ea88a50ddb2ab3f0&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note 2: If you’re curious about how to configure the output of docker stats then see &lt;a href=&quot;https://docs.docker.com/engine/reference/commandline/stats/#formatting&quot;&gt;this link&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If I then docker ps and grep either with the name or the process id, I will see the same container:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker ps | grep seirawatchshop_sidekiq_1
631359e0cec8        fuzzygroup/seirawatchshop_web     &quot;bundle exec sidek...&quot;   10 hours ago        Restarting (1) 46 seconds ago                             seirawatchshop_sidekiq_1

docker ps | grep 631359e0cec8
631359e0cec8        fuzzygroup/seirawatchshop_web     &quot;bundle exec sidek...&quot;   9 hours ago         Restarting (1) 26 seconds ago                             seirawatchshop_sidekiq_1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Once we have this then we can get just the logs on this one container:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker logs 631359e0cec8

Error connecting to Redis on 127.0.0.1:6379 (Errno::ECONNREFUSED)
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:345:in `rescue in establish_connection'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:331:in `establish_connection'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:101:in `block in connect'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:293:in `with_reconnect'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:100:in `connect'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:364:in `ensure_connected'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:221:in `block in process'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:306:in `logging'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:220:in `process'
/usr/local/bundle/gems/redis-3.3.3/lib/redis/client.rb:120:in `call'
/usr/local/bundle/gems/redis-3.3.3/lib/redis.rb:251:in `block in info'
/usr/local/bundle/gems/redis-3.3.3/lib/redis.rb:58:in `block in synchronize'
/usr/local/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'
/usr/local/bundle/gems/redis-3.3.3/lib/redis.rb:58:in `synchronize'
/usr/local/bundle/gems/redis-3.3.3/lib/redis.rb:250:in `info'
/usr/local/bundle/gems/sidekiq-4.2.7/lib/sidekiq.rb:113:in `block in redis_info'
/usr/local/bundle/gems/sidekiq-4.2.7/lib/sidekiq.rb:95:in `block in redis'
/usr/local/bundle/gems/connection_pool-2.2.1/lib/connection_pool.rb:64:in `block (2 levels) in with'
/usr/local/bundle/gems/connection_pool-2.2.1/lib/connection_pool.rb:63:in `handle_interrupt'
/usr/local/bundle/gems/connection_pool-2.2.1/lib/connection_pool.rb:63:in `block in with'
/usr/local/bundle/gems/connection_pool-2.2.1/lib/connection_pool.rb:60:in `handle_interrupt'
/usr/local/bundle/gems/connection_pool-2.2.1/lib/connection_pool.rb:60:in `with'
/usr/local/bundle/gems/sidekiq-4.2.7/lib/sidekiq.rb:92:in `redis'
/usr/local/bundle/gems/sidekiq-4.2.7/lib/sidekiq.rb:106:in `redis_info'
/usr/local/bundle/gems/sidekiq-4.2.7/lib/sidekiq/cli.rb:71:in `run'
/usr/local/bundle/gems/sidekiq-4.2.7/bin/sidekiq:12:in `&amp;lt;top (required)&amp;gt;'
/usr/local/bundle/bin/sidekiq:22:in `load'
/usr/local/bundle/bin/sidekiq:22:in `&amp;lt;top (required)&amp;gt;'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;So what’s going on here is clearly at the Sidekiq stack layer and it is some type of connection to the underlying containerized Redis instance.  Once we know that, troubleshooting this should actually be pretty simple; it eventually turned out to be a missing pair of files - config/sidekiq.yml.erb and config/initializers/sidekiq.rb that had been overlooked in my initial configuration.&lt;/p&gt;

&lt;p&gt;Just as a sidebar, a docker ps -a is also sometimes useful:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker ps -a
CONTAINER ID        IMAGE                             COMMAND                  CREATED             STATUS                          PORTS       NAMES
b17d34bf7268        fuzzygroup/seirasearch_web        &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3230-&amp;gt;3230/tcp    seirasearch_web_1
5c5460a763b1        fuzzygroup/seirawatchwebapp_web   &quot;bundle exec clock...&quot;   9 hours ago         Up 9 hours       seirawatchwebapp_clockwork_1
ec28ede65792        fuzzygroup/seirawatchwebapp_web   &quot;bundle exec sidek...&quot;   9 hours ago         Up 9 hours       seirawatchwebapp_sidekiq_1
bb5839c2a6a7        fuzzygroup/seirawatchwebapp_web   &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3210-&amp;gt;3210/tcp    seirawatchwebapp_web_1
5e78dbc9489e        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:32779-&amp;gt;6379/tcp   seirawatchwebapp_redis_1
2d5b14feb009        fuzzygroup/seirawatchsite_web     &quot;bundle exec sidek...&quot;   9 hours ago         Up 9 hours       seirawatchsite_sidekiq_1
13d42ed0ba35        fuzzygroup/seirawatchsite_web     &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3200-&amp;gt;3200/tcp    seirawatchsite_web_1
3fbd80153022        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:32777-&amp;gt;6379/tcp   seirawatchsite_redis_1
631359e0cec8        fuzzygroup/seirawatchshop_web     &quot;bundle exec sidek...&quot;   9 hours ago         Restarting (1) 58 seconds ago       seirawatchshop_sidekiq_1
26ee413fab7f        fuzzygroup/seirawatchshop_web     &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3205-&amp;gt;3205/tcp    seirawatchshop_web_1
1ab35bf6514c        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:32775-&amp;gt;6379/tcp   seirawatchshop_redis_1
ac1462fccc60        fuzzygroup/seirawebappapi_web     &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3220-&amp;gt;3220/tcp    seirawebappapi_web_1
422787e2d5ab        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:32774-&amp;gt;6379/tcp   seiracrawler_redis_1
b19bb9629925        fuzzygroup/seiracrawler_rake      &quot;bundle exec clock...&quot;   9 hours ago         Up 9 hours       seiracrawler_rake_1
79f484ac7c89        fuzzygroup/seiracrawler_rake      &quot;bundle exec sidek...&quot;   9 hours ago         Up 9 hours       seiracrawler_sidekiq_1
e34789eed4cc        fuzzygroup/seiraadmin_web         &quot;bundle exec clock...&quot;   9 hours ago         Up 9 hours       seiraadmin_clockwork_1
6f0cd03996a3        fuzzygroup/seiraadmin_web         &quot;bundle exec sidek...&quot;   9 hours ago         Up 9 hours       seiraadmin_sidekiq_1
4d8486ff6046        fuzzygroup/seiraadmin_web         &quot;/bin/sh -c 'puma ...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:3203-&amp;gt;3203/tcp    seiraadmin_web_1
4d978af45ff2        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   9 hours ago         Up 9 hours                      0.0.0.0:32773-&amp;gt;6379/tcp   seiraadmin_redis_1
533d96fc2ce1        fuzzygroup/shouldigem_web         &quot;bundle exec sidek...&quot;   10 hours ago        Up 10 hours       shouldigem_sidekiq_1
6b60a945bff7        fuzzygroup/shouldigem_web         &quot;/bin/sh -c 'puma ...&quot;   10 hours ago        Up 10 hours                     0.0.0.0:3500-&amp;gt;3500/tcp    shouldigem_web_1
9c2e8ec55a06        redis:3.2-alpine                  &quot;docker-entrypoint...&quot;   10 hours ago        Up 10 hours                     0.0.0.0:32770-&amp;gt;6379/tcp   shouldigem_redis_1
6c2b013947d1        google/cadvisor:latest            &quot;/usr/bin/cadvisor...&quot;   11 hours ago        Exited (137) 11 hours ago       cadvisor2
34e1edbad906        google/cadvisor:latest            &quot;/usr/bin/cadvisor...&quot;   11 hours ago        Created       cadvisor1
8478172d0f2b        google/cadvisor:latest            &quot;/usr/bin/cadvisor...&quot;   11 hours ago        Exited (137) 11 hours ago       cadvisor
5b5c1709c1af        errbit/errbit:latest              &quot;bundle exec puma ...&quot;   3 days ago          Exited (0) 10 hours ago       errbit_errbit_1
ac91a943e789        mongo:3.2                         &quot;docker-entrypoint...&quot;   3 days ago          Exited (0) 10 hours ago       errbit_mongo_1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;go-nuclear---restart-the-docker-daemon&quot;&gt;11: Go Nuclear - Restart the Docker Daemon&lt;/h1&gt;

&lt;p&gt;The absolute nuclear approach here is to simply restart the &lt;a href=&quot;https://docs.docker.com/engine/admin/&quot;&gt;docker daemon&lt;/a&gt; itself.  On Ubuntu, this is:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo service docker restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I’m not going to go so far as to say that you don’t have to, rarely, restart the docker daemon but it is just that – &lt;strong&gt;rare&lt;/strong&gt;.  Your problems are far, far, far more likely to be application side errors, even when it looks like Docker is at fault.  I’ve mistakenly pointed the finger at Docker too many times – and I was &lt;strong&gt;wrong&lt;/strong&gt;.&lt;/p&gt;

&lt;h1 id=&quot;pitch-for-a-friend-learn-from-nick&quot;&gt;Pitch for a Friend: Learn from Nick&lt;/h1&gt;

&lt;p&gt;All my Docker knowledge came from Nick Janetakis’ &lt;a href=&quot;https://diveintodocker.com/&quot;&gt;Dive into Docker&lt;/a&gt; course and he does a great job teaching about Docker. He also kibitzed with me on this debugging process although he never saw the final draft before it went live.  Any errors are mine not his.  Strongly recommended.&lt;/p&gt;
</description>
        <pubDate>Tue, 15 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/08/15/10-steps-to-debugging-containerized-rails-applications.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/08/15/10-steps-to-debugging-containerized-rails-applications.html</guid>
        
        <category>docker</category>
        
        <category>debugging</category>
        
        <category>rails</category>
        
        <category>monolith</category>
        
        <category>aws</category>
        
        
        <category>docker</category>
        
      </item>
    
      <item>
        <title>Fundamental Usability Problems with Medium</title>
        <description>&lt;p&gt;Yesterday I was at the movies with my son and during the endless roll of trailers, promos and advertisements, I was terribly, terribly bored so I dropped into the Medium app and saw something that I &lt;strong&gt;knew&lt;/strong&gt; I wanted to read in more depth so I hearted it (by hearted I mean I clicked on the heart icon on the toolbar and watched it change color).  I figured that would be enough to find it later.  I also remembered a little bit about it:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;author: james altschuler&lt;/li&gt;
  &lt;li&gt;keywords: hedge fund marriage thestreet.com&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Just to cut to the chase, here’s the &lt;a href=&quot;https://medium.com/the-mission/step-by-step-guide-to-make-10-million-and-then-totally-blow-it-a9283b6de90c&quot;&gt;exact article&lt;/a&gt; but the process by which I found something that I had:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;already read&lt;/li&gt;
  &lt;li&gt;that I had hearted as a favorite&lt;/li&gt;
  &lt;li&gt;that I knew had certain keywords&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;was an absolute usability failure and one that I just don’t understand.&lt;/p&gt;

&lt;h1 id=&quot;usability-failure-1---where-are-my-hearted-things&quot;&gt;Usability Failure #1 - Where Are My Hearted Things?&lt;/h1&gt;

&lt;p&gt;The next day I went to Medium in my laptop’s browser and signed in and I &lt;strong&gt;could not&lt;/strong&gt; find the things I liked.  So I looked again, nope.  My next thought was ok maybe these are just stored in the Medium app on my phone – nope I couldn’t find anything there either.  This led me back to my laptop’s browser where I finally googled it and found a &lt;a href=&quot;https://www.quora.com/How-do-I-find-a-list-of-all-the-articles-I-recommended-on-Medium&quot;&gt;Quora post&lt;/a&gt; that talked about it but their solution was no longer part of the Medium user interface.  They also pointed out that you could goto http://medium.com/@user/has-recommended and find your posts.  I typed in the correct url for me: &lt;a href=&quot;http://medium.com/@fuzzygroup/has-recommended&quot;&gt;http://medium.com/@fuzzygroup/has-recommended&lt;/a&gt; and that actually did work but the question remains:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Medium has serious founders, serious money, serious talent – how can this be a problem?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: I never did find a way to get back to my hearted items on my phone.&lt;/p&gt;

&lt;h1 id=&quot;usability-failure-2---search&quot;&gt;Usability Failure #2 - Search&lt;/h1&gt;

&lt;p&gt;When I couldn’t find the article I &lt;strong&gt;knew&lt;/strong&gt; was there, I turned to search as the next obvious way to find it.  Here was my process:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;So I started with a search for &lt;a href=&quot;https://medium.com/search?q=james%20altschuler&quot;&gt;james altschuler&lt;/a&gt; and that gave zero hits.&lt;/li&gt;
  &lt;li&gt;Then I continued with a search for &lt;a href=&quot;https://medium.com/search?q=thestreet.com&quot;&gt;thestreet.com&lt;/a&gt; and that gave me hits but not the article I knew I had read.  Now I have no problem with a spelling error on altschuler but “thestreet.com” – &lt;strong&gt;nope&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;I then proceeded to search for &lt;a href=&quot;https://medium.com/search?q=hedge%20fund&quot;&gt;hedge fund&lt;/a&gt; and again the article that I wanted wasn’t there.&lt;/li&gt;
  &lt;li&gt;Ok I’ll accept that there are lots and lots of articles about hedge funds but how many &lt;a href=&quot;https://medium.com/search?q=hedge%20fund%20marriage&quot;&gt;hedge fund articles talk about the collapse of his marriage&lt;/a&gt; - that must work, right?  Nope.  That three word query brings back just a &lt;a href=&quot;https://medium.com/thinkprogress/hedge-fund-manager-runs-anti-gay-attack-ad-against-liz-cheney-2e851c82b758&quot;&gt;single article&lt;/a&gt;.  Interestingly Google finds &lt;a href=&quot;https://www.google.com/search?biw=1313&amp;amp;bih=646&amp;amp;q=site%3Amedium.com+%22hedge+fund%22+%22marriage%22&amp;amp;oq=site%3Amedium.com+%22hedge+fund%22+%22marriage%22&amp;amp;gs_l=psy-ab.3...34964.39387.0.39831.4.4.0.0.0.0.62.207.4.4.0....0...1.1.64.psy-ab..0.0.0.FNpHjvAPKsM&quot;&gt;360 things&lt;/a&gt; on medium that contain hedge fund and marriage and the post I was looking for was on the second page.  I ran the google search with “hedge fund” and “marriage” to force all the terms to be in there as well as to treat “hedge fund” as a string.&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;how-did-i-finally-find-it&quot;&gt;How Did I Finally Find It?&lt;/h1&gt;

&lt;p&gt;I finally ended up giving up on Medium’s user interface and its search engine and using my incorrect version of the author’s name and &lt;a href=&quot;https://www.google.com/search?q=site%3Amedium.com%20james%20altschuler&quot;&gt;Google found the right author as the very first result&lt;/a&gt;.  I then scrolled down and found &lt;a href=&quot;https://medium.com/the-mission/step-by-step-guide-to-make-10-million-and-then-totally-blow-it-a9283b6de90c&quot;&gt;the article&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;By any Silicon Valley standards, Medium is a real thing:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Medium_(website)&quot;&gt;5 years old&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Incredible Founder - Blogger and Twitter were Ev’s prior companies&lt;/li&gt;
  &lt;li&gt;Huge $$$ - More than &lt;a href=&quot;https://techcrunch.com/2016/04/21/medium-series-c/&quot;&gt;$107 Million&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Has north of &lt;a href=&quot;https://www.quora.com/How-many-employees-does-Medium-have-What-do-they-do&quot;&gt;167 employees&lt;/a&gt; as of November 2015&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It is very, very hard for me to understand this level of usability failure at a company with these type of metrics.  I can, perhaps, excuse the user interface to hearted items as being a redesign where something got lost in the shuffle.  But the search failure is deeply, deeply troubling.  If you’re in the content business then search is a &lt;strong&gt;requirement&lt;/strong&gt; not an option and a search algorithm that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;deals with misspellings&lt;/li&gt;
  &lt;li&gt;takes into account user input such as hearts / likes&lt;/li&gt;
  &lt;li&gt;actually finds the damn keywords the user puts in&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;should not be a problem in 2017.  I’m spent my career in search in retrieval and we were solving these types of issue back in the early 90s if not sooner.  I just can’t fathom exactly what Medium is doing but they would likely be better served at this point by just embedding google instead of whatever search tool they’ve&lt;/p&gt;

&lt;h1 id=&quot;obligatory-advertisement-for-myself&quot;&gt;Obligatory Advertisement for Myself&lt;/h1&gt;

&lt;p&gt;If you have search and retrieval needs, I’ve spent a long time working on these kinds of issues and I’m always happy to talk to potential clients.  My contact details are on &lt;a href=&quot;http://fuzzyblog.io/blog/resume.html&quot;&gt;my resume&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Mon, 14 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/medium/2017/08/14/the-problem-with-medium.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/medium/2017/08/14/the-problem-with-medium.html</guid>
        
        <category>medium</category>
        
        <category>blogging</category>
        
        
        <category>medium</category>
        
      </item>
    
      <item>
        <title>When Font Awesome Won't Render in Production on Rails 5.x</title>
        <description>&lt;p&gt;&lt;a href=&quot;http://fontawesome.io/&quot;&gt;Font Awesome&lt;/a&gt; is one of those staggeringly good open source projects that you don’t realize just how good it is until you use it – and then it goes away.  The degree of &lt;em&gt;polish&lt;/em&gt; and &lt;em&gt;finish&lt;/em&gt; that an easy to use, inline icon adds to a project honestly just astounds me.  That’s why, when I moved some code to production recently, and Font Awesome failed to render, well, I was &lt;strong&gt;beyond frustrated&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;My current production platform is Rails 5.x and this is how I got past that particular hellish little bit of the Rails asset pipeline.  The context is that I’ve been developing with Font Awesome for over 8 months now and I even spent the $$$ to back their &lt;a href=&quot;https://www.kickstarter.com/projects/232193852/font-awesome-5/comments&quot;&gt;KickStarter&lt;/a&gt; since Font Awesome is just that, well, &lt;strong&gt;awesome&lt;/strong&gt; and I’ve been viewing their icons daily for 8 months – until I deployed at which point they vanished.&lt;/p&gt;

&lt;p&gt;On digging into this problem, I found a lot of discussion and suggestions in the &lt;a href=&quot;https://stackoverflow.com/questions/17904949/rails-app-not-serving-assets-in-production-environment&quot;&gt;normal &lt;/a&gt; &lt;a href=&quot;https://github.com/FortAwesome/Font-Awesome/issues/5559&quot;&gt;places&lt;/a&gt; but I never found this solution.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Diagnose the problem by looking at the Chrome JavaScript console and seeing if you get a 404 error related to missing font files such as &lt;em&gt;fontawesome-webfont.woff2&lt;/em&gt;.  That’s the issue that this solution tackles.&lt;/li&gt;
  &lt;li&gt;Use the font-awesome-rails gem in Gemfile: &lt;strong&gt;gem “font-awesome-rails”&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;In your application.css.scss file you should have an import directive at or near the top like @import “font-awesome”;&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;In config/environments/production.rb, you need a series of asset compilation directives like these:&lt;/p&gt;

    &lt;p&gt;# Do not fallback to assets pipeline if a precompiled asset is missed.
 config.assets.compile = false
 # font_awesome additions
 config.serve_static_assets = true
 config.assets.compress = true
 config.assets.compile = true
 config.assets.digest = true&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;before-and-after&quot;&gt;Before and After&lt;/h1&gt;

&lt;p&gt;Here’s the obligatory before and after screenshots:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/blog/assets/font_awesome_broken.png&quot; alt=&quot;font_awesome_broken.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/blog/assets/font_awesome_working.png&quot; alt=&quot;font_awesome_broken.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The working screenshot has slightly different data in it since this was written over a series of days while this issue was researched.&lt;/p&gt;

&lt;h1 id=&quot;honest-disclaimer&quot;&gt;Honest Disclaimer&lt;/h1&gt;

&lt;p&gt;I’ve now been using Rails since 2007 and Ruby since 2006 (and HTML since 93) which means that I so thoroughly precede the asset pipeline that it honestly makes me laugh.  In all honesty, I really don’t understand the asset pipeline particularly well so if this advice is technically wrong, I &lt;strong&gt;apologize&lt;/strong&gt;.  What I can tell you is that this advice took a Rails 5 system where Font Awesome worked in development but failed in production and made it work in production – but when you don’t understand the low level details, well, it makes you &lt;em&gt;uncomfortable&lt;/em&gt;.&lt;/p&gt;
</description>
        <pubDate>Sat, 12 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/08/12/when-font-awesome-won-t-render-in-production-on-rails-5-x.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/08/12/when-font-awesome-won-t-render-in-production-on-rails-5-x.html</guid>
        
        <category>rails</category>
        
        <category>font_awesome</category>
        
        <category>asset_pipeline</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Using Errbit To Host Your own Error Tracker on AWS for Rails Apps</title>
        <description>&lt;p&gt;In this tutorial, I walk you through using &lt;a href=&quot;https://github.com/errbit/errbit&quot;&gt;the Errbit project&lt;/a&gt;, an open source error tracker to host your own error tracker.  Errbit is a competitor to &lt;a href=&quot;http://www.honeybadger.io&quot;&gt;HoneyBadger&lt;/a&gt;, &lt;a href=&quot;http://www.bugsnagcom/&quot;&gt;BugSnag&lt;/a&gt;, &lt;a href=&quot;http://www.airbrake.io&quot;&gt;AirBrake&lt;/a&gt; and other similar hosted error tracking tools that generally cost $29 to $49 / month or more.  Using Errbit means you only pay for infrastructure capacity and end up with a solution you can maintain yourself.&lt;/p&gt;

&lt;p&gt;I’ve written about HoneyBadger &lt;a href=&quot;http://fuzzyblog.io/blog/containers/2016/08/26/in-the-world-of-containers-honeybadger-will-reign-supreme-bye-bye-airbrake.html&quot;&gt;previously&lt;/a&gt; and it really is an excellent, excellent tool but I’m cheap and I wanted to experiment with an open source project that I’ve known about for years and never had the opportunity.  Although Errbit really is excellent, I found the getting started documentation lacking hence this post.&lt;/p&gt;

&lt;p&gt;I initially tried to get this running on Heroku but that resulted in what I termed &lt;a href=&quot;http://fuzzyblog.io/blog/fail/2017/08/08/utter-and-complete-heroku-fail.html&quot;&gt;Heroku Fail&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;step-1-getting-it-running-locally-using-docker&quot;&gt;Step 1: Getting it Running Locally Using Docker&lt;/h1&gt;

&lt;p&gt;Errbit is a modern Rails app and it requires:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Rails&lt;/li&gt;
  &lt;li&gt;Mongo&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The easiest way to get this running locally is to just pull down the docker-compose.yml file from the github repo and use docker-compose to run it.  If you don’t have Docker installed then you need to &lt;a href=&quot;http://www.docker.com/&quot;&gt;install it now&lt;/a&gt; for development and on your server for production use.  After that:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir errbit
cd errbit
wget https://github.com/errbit/errbit/blob/master/docker-compose.yml
docker-compose up 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Once that is running, in a separate terminal window you need to bootstrap the installation and generate an admin user.  Do that with:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; docker-compose exec errbit bundle exec rake errbit:bootstrap
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The default errbit port is 8080 and you can access it by going to http://localhost:8080 where you can use the credentials you generated by bootstrapping it to log in.&lt;/p&gt;

&lt;p&gt;Once you’ve logged in, you need to add your app by clicking on the Add a new App button and then setting:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;app name&lt;/li&gt;
  &lt;li&gt;github repo&lt;/li&gt;
  &lt;li&gt;issue tracker&lt;/li&gt;
  &lt;li&gt;notification service&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Once this is done, Errbit will generate you instructions for what to add to your Gemfile and what to configure in the errbit.rb initializer.  Generally this looks something like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Require the airbrake gem in your App.
# ---------------------------------------------
#
# Ruby - In your Gemfile
# gem 'airbrake', '~&amp;gt; 5.0'
#
# Then add the following to config/initializers/errbit.rb
# -------------------------------------------------------

Airbrake.configure do |config|
  config.host = 'http://localhost:8080'
  config.project_id = 1 # required, but any positive integer works
  config.project_key = '2020e526a09c78462f0f9d45010efc6c'

  # Uncomment for Rails apps
  # config.environment = Rails.env
  # config.ignore_environments = %w(development test)
end
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;If you want to test Errbit’s integration then you can use this rake task:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rake airbrake:test
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Once you’ve confirmed that this works, you can proceed to Step 2 and move it a server.&lt;/p&gt;

&lt;h1 id=&quot;step-2-moving-it-to-a-server&quot;&gt;Step 2: Moving it to a Server&lt;/h1&gt;

&lt;p&gt;Installing Errbit on a docker enabled server really is exactly the same as you did above.  Here’s the quick recap:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Log into your server.&lt;/li&gt;
  &lt;li&gt;Make an errbit directory where you want it.&lt;/li&gt;
  &lt;li&gt;wget https://raw.githubusercontent.com/errbit/errbit/master/docker-compose.yml&lt;/li&gt;
  &lt;li&gt;Run &lt;strong&gt;docker-compose up&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;In another terminal window, run &lt;strong&gt;docker-compose exec errbit bundle exec rake errbit:bootstrap&lt;/strong&gt; and make note of the credentials.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;At this point you have an http service running errbit on port 8080 which your AWS security group likely isn’t configured for and that brings us to step 3.&lt;/p&gt;

&lt;h1 id=&quot;step-3-aws-configuration&quot;&gt;Step 3: AWS Configuration&lt;/h1&gt;

&lt;p&gt;Our goal in this step is to configure a domain name like errbit.foo.com where foo.com is your base domain name.  I’m assuming that you are using the standard AWS tools including Route 53 for DNS and an ALB for load balancing.  Here are the things we need to do to make this work on AWS:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create a dns name for it.&lt;/li&gt;
  &lt;li&gt;Open a security group port for it.&lt;/li&gt;
  &lt;li&gt;Add it to our load balancer.&lt;/li&gt;
  &lt;li&gt;Add it to our monitoring tool&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;creating-a-dns-name-for-it&quot;&gt;Creating a DNS Name for It&lt;/h2&gt;

&lt;p&gt;Here are the steps to follow:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Go into AWS console for Route 53.&lt;/li&gt;
  &lt;li&gt;Select your main domain name, the “foo.com” from above.&lt;/li&gt;
  &lt;li&gt;Select Create Record Set.&lt;/li&gt;
  &lt;li&gt;In the name field enter errbit and then choose that it is type A and that it is an alias.&lt;/li&gt;
  &lt;li&gt;In the alias target select your load balancer.&lt;/li&gt;
  &lt;li&gt;Click the Create button.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This has created the domain name errbit.foo.com and assigned it to your load balanced AWS stack.&lt;/p&gt;

&lt;h2 id=&quot;opening-a-security-group-port&quot;&gt;Opening a Security Group Port&lt;/h2&gt;

&lt;p&gt;Your AWS security group is really nothing more than a firewall and to let traffic through you need to expose a hole for the port 8080.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Go into the AWS console for EC2 instances.&lt;/li&gt;
  &lt;li&gt;Select Security Groups from the left hand pane.&lt;/li&gt;
  &lt;li&gt;Click the Inbound tab and then click the Edit button.&lt;/li&gt;
  &lt;li&gt;Scroll all the way down to the bottom and click Add Rule.&lt;/li&gt;
  &lt;li&gt;Enter 8080 into the Port Range field as a custom TCP rule accessible to everywhere and then click the Save button.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;adding-errbit-to-your-aws-alb-load-balancer&quot;&gt;Adding Errbit to Your AWS ALB Load Balancer&lt;/h2&gt;

&lt;p&gt;At this point we just need to add Errbit to our AWS load balancer.  Please note that if you aren’t using a load balancer then at this point you would actually be done but since I have one, I should go through all the way to the end.&lt;/p&gt;

&lt;p&gt;The first step is to define a Target Group for your load balancer.  This allows you to map a service on a given port to an AWS instance.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Go into the AWS console for EC2 instances.&lt;/li&gt;
  &lt;li&gt;Select Target Groups from the left hand pane.&lt;/li&gt;
  &lt;li&gt;Click the Create Target Group button.&lt;/li&gt;
  &lt;li&gt;Enter errbit as the Target group name and specify /robots.txt as the health check path and then click Create.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Once you have a Target Group then you need to add an actual Target for the group to serve traffic to:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Select the errbit Target Group in the list of target groups on the top.&lt;/li&gt;
  &lt;li&gt;Select the Targets tab on the bottom.&lt;/li&gt;
  &lt;li&gt;Click the Edit button.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;IMPORTANT&lt;/strong&gt;: This next step is confusing so please pay attention.  You are now adding from a list on the bottom of the screen to a list on the top and then saving your work with a button on the bottom.  Honestly this is kind of a &lt;em&gt;shite show&lt;/em&gt; as far as UI design goes but it does work; it is just tricky and unintuitive.&lt;/li&gt;
  &lt;li&gt;Select your instance where errbit is installed from the list of instances on the bottom and then check its box on the far left.  Enter 8080 in the port field and then click the Add to registered button.&lt;/li&gt;
  &lt;li&gt;Now click the Save button.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;You now have both a target group and a target which means you can now create a load balancer rule to process the traffic.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Go into the AWS console for EC2 instances.&lt;/li&gt;
  &lt;li&gt;Select Load Balancers from the left hand pane&lt;/li&gt;
  &lt;li&gt;Select your load balancer from the list of load balancers at the top.&lt;/li&gt;
  &lt;li&gt;Select Listeners from the bottom grouping of tabs.&lt;/li&gt;
  &lt;li&gt;Out of the box, Errbit only supports http not https so on the http listener select View/edit rules.&lt;/li&gt;
  &lt;li&gt;Select the + icon to add a rule.&lt;/li&gt;
  &lt;li&gt;At the top of the load balancer select the Insert Rule link.&lt;/li&gt;
  &lt;li&gt;Add errbit.foo.com (make sure you specify your correct base domain) to the Host field in the &lt;strong&gt;IF&lt;/strong&gt; section of the rule.&lt;/li&gt;
  &lt;li&gt;Select your target group from the Forward to section of the &lt;strong&gt;THEN&lt;/strong&gt; section of the rule.&lt;/li&gt;
  &lt;li&gt;Click the Save button.&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;At this point you should goto your url, something like http://errbit.foo.com/ and you should get a login screen where you can use the credentials you generated earlier.&lt;/p&gt;

&lt;p&gt;Your first tasks now need to be:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Add yourself as a user so your email address is supported for notifications (note I still need to configure email sending and that will happen but likely in a later blog post).&lt;/li&gt;
  &lt;li&gt;Add any other team members.&lt;/li&gt;
  &lt;li&gt;You need to add all of your applications to Errbit and then configure your applications accordingly.&lt;/li&gt;
  &lt;li&gt;Use the Rake task above to test each of your applications and verify that they are connected to errbit.&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&quot;if-you-need-to-learn-docker&quot;&gt;If You Need to Learn Docker&lt;/h1&gt;

&lt;p&gt;All my Docker knowledge came from &lt;a href=&quot;https://diveintodocker.com/&quot;&gt;Nick Janetakis’ Dive into Docker course&lt;/a&gt; and he does a great job teaching about Docker.  Strongly recommended.&lt;/p&gt;
</description>
        <pubDate>Fri, 11 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/aws/2017/08/11/using-errbit-to-host-your-own-error-tracker-on-aws-for-rails-apps.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/aws/2017/08/11/using-errbit-to-host-your-own-error-tracker-on-aws-for-rails-apps.html</guid>
        
        <category>rails</category>
        
        <category>aws</category>
        
        <category>errbit</category>
        
        
        <category>aws</category>
        
      </item>
    
      <item>
        <title>Referencing Images in Rails 5 CSS Stylesheets</title>
        <description>&lt;p&gt;I recently had the issue where I switched the images in my stylesheet from an absolute url on someone else’s domain to a relative path indicating a file in my /app/assets/images directory and that worked fine – until I deployed and then my image disappeared.  It took a few iterations to figure it out and here’s the trick:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Make sure you are using the sass-rails gem which provides the necessary helpers.&lt;/li&gt;
  &lt;li&gt;For an image located in /app/assets/images/intro-bg.jpg, assuming that it is a CSS background image, you want to reference it as background: url(asset_path(“intro-bg.jpg”)).&lt;/li&gt;
  &lt;li&gt;You need to rename your stylesheet with a .scss extension so it is fed through the preprocessor.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Here’s a &lt;a href=&quot;https://stackoverflow.com/questions/15257555/how-to-reference-images-in-css-within-rails-4&quot;&gt;Stack Overflow&lt;/a&gt; on this but please note that the highest answer was actually wrong (at least for me).&lt;/p&gt;

&lt;p&gt;You should also note that, in my opinion, the asset pipeline is tricky and I no longer trust anything in it until I’ve deployed to production and tested it myself.&lt;/p&gt;
</description>
        <pubDate>Wed, 09 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/08/09/referencing-images-in-rails-5-stylesheets.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/08/09/referencing-images-in-rails-5-stylesheets.html</guid>
        
        <category>rails</category>
        
        <category>CSS</category>
        
        
        <category>rails</category>
        
      </item>
    
  </channel>
</rss>
