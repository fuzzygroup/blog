<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>FuzzyBlog</title>
    <description>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</description>
    <link>http://fuzzyblog.io//blog/</link>
    <atom:link href="http://fuzzyblog.io//blog/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Sat, 30 Sep 2017 16:36:20 -0400</pubDate>
    <lastBuildDate>Sat, 30 Sep 2017 16:36:20 -0400</lastBuildDate>
    <generator>Jekyll v3.2.1</generator>
    
      <item>
        <title>Using Chrome Driver with Docker, Rails and Selenium on AWS</title>
        <description>&lt;p&gt;I’ve done a lot of crawling in my professional career and I mean a &lt;strong&gt;lot&lt;/strong&gt;.  The recent trend towards JavaScript based sites, however, has wreaked havoc on my traditional approach of low level html parsing.  For a new product I’m launching, I recently had to make the switch to using &lt;a href=&quot;https://github.com/SeleniumHQ/&quot;&gt;Selenium&lt;/a&gt; for crawling.  Selenium, commonly known as a testing tool, can be used in an embedded fashion where you use code like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;browser = Selenium::WebDriver.for :chrome
browser.get &quot;https://www.google.com&quot;
html = browser.page_source
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Here’s a rough equivalent in Mechanize:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;agent = Mechanize.new
page = agent.get(&quot;https://www.google.com&quot;)
html = page.body
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Although the lines of code look similar to something like &lt;a href=&quot;https://github.com/sparklemotion/mechanize&quot;&gt;Mechanize&lt;/a&gt; this is actually an entirely different approach because underneath it all is a full browser including JavaScript which lets something like a page which sends its data down in a JavaScript array and then uses JavaScript to display it actually render and return back to you parseable html.&lt;/p&gt;

&lt;h1 id=&quot;doing-this-server-side&quot;&gt;Doing this Server Side&lt;/h1&gt;

&lt;p&gt;If you’re going to use Selenium for a server side crawling process then what you actually needs is called ChromeDriver which is the embedded chrome executable that represents a browser.  One approach is to locally install ChromeDriver on each of your compute nodes but the better approach is to Dockerize everything and run ChromeDriver as a container.  Here are the steps to do just that.&lt;/p&gt;

&lt;h2 id=&quot;add-chromedriver-to-your-docker-compose-file&quot;&gt;Add ChromeDriver to Your Docker Compose File&lt;/h2&gt;

&lt;p&gt;You’ll likely need to implement both Step 1 and Step 2.&lt;/p&gt;

&lt;h3 id=&quot;step-1&quot;&gt;Step 1&lt;/h3&gt;

&lt;p&gt;Here’s what you’ll need for docker-compose.yml or docker-compose.production.yml:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;chromedriver:
  image: 'robcherry/docker-chromedriver'
  ports: 
    - 4444:4444
  restart: on-failure
  shm_size: 1G    
  environment:
    - CHROMEDRIVER_WHITELISTED_IPS=&quot;&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;step-2&quot;&gt;Step 2&lt;/h3&gt;

&lt;p&gt;A docker container is dramatically lighter than a full computer and you’ll find that Chrome will start.  The specific error you are likely to hit is:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Selenium::WebDriver::Error::UnknownError: unknown error: Chrome failed to start: crashed&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When you discover this you need to change your daemon.json file (normally located in /etc/docker/daemon.json) to have a larger shm_size like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cat daemon.json
{
  &quot;default-shm-size&quot;:&quot;2g&quot;,
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;10m&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Yes I’m aware that I use 1G in the first example and 2g in the second.  This is how I currently have it working and I’m leaving it alone until I play with it more.  I suspect you could sync these but I don’t know that definitively.&lt;/p&gt;

&lt;h3 id=&quot;step-3&quot;&gt;Step 3&lt;/h3&gt;

&lt;p&gt;The next error you are likely to hit is one of these two, possibly both:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Net::ReadTimeout during browser launch&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;UnknownError: session deleted because of page crash from tab crashed&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The solution to each of these is how you invoke the core browser object.  Here’s what I used:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;browser = Selenium::WebDriver.for :chrome, url: &quot;http://chromedriver:4444&quot;, :prefs =&amp;gt; {:password_manager_enable =&amp;gt; false, :credentials_enable_service =&amp;gt; false}, :switches =&amp;gt; [&quot;disable-infobars&quot;, &quot;no-sandbox&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;security-issues&quot;&gt;Security Issues&lt;/h1&gt;

&lt;p&gt;Here’s an interesting security note:&lt;/p&gt;

&lt;p&gt;Note: ChromeDriver restricts access to local connections by default. To allow external connections, you can pass in a custom CHROMEDRIVER_WHITELISTED_IPS environment variable. By default, this is set to 127.0.0.1, but this can by any comma separated list of IP addresses. Setting the value as empty will allow all remote connections.&lt;/p&gt;

&lt;p&gt;AWS security groups really save you on this one.  By setting CHROMEDRIVER_WHITELISTED_IPS=””, I am able to use ChromeDriver from any other container but nothing else can execute them.  An embedded browser like Selenium is akin to an open proxy so you do not want that.&lt;/p&gt;

&lt;h1 id=&quot;references&quot;&gt;References&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://hub.docker.com/r/robcherry/docker-chromedriver/&quot;&gt;Docker Chrome Driver&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/SeleniumHQ/selenium/wiki/Ruby-Bindings&quot;&gt;Ruby and Selenium&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.github.com/ziadoz/3e8ab7e944d02fe872c3454d17af31a5&quot;&gt;Installing Chrome Driver Locally on Ubuntu&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/SeleniumHQ/docker-selenium/issues/198&quot;&gt;Net::ReadTimeout during browser launch&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://intoli.com/blog/running-selenium-with-headless-chrome/&quot;&gt;Running Selenium on Headless Chrome&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.docker.com/engine/reference/run/#ipc-settings-ipc&quot;&gt;Setting Docker Shm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/elgalu/docker-selenium&quot;&gt;Docker and Selenium&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/zalando/zalenium#run-it&quot;&gt;Zalenium&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/elgalu/docker-selenium/issues/20#issuecomment-133011186&quot;&gt;Docker and Selenium and Shm / Chrome&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;thank-you&quot;&gt;Thank You&lt;/h1&gt;

&lt;p&gt;Kudos and thanks to &lt;a href=&quot;http://www.nickjanetakis.com/&quot;&gt;Nick my Docker buddy&lt;/a&gt;.  He teaches Docker professionally and really knows his stuff.  I probably could have slogged through this but his help turned what would have been a man day into a quick one hour pairing session.  Appreciated.&lt;/p&gt;
</description>
        <pubDate>Sat, 30 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/09/30/using-chrome-driver-with-docker-rails-and-selenium-on-aws.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/09/30/using-chrome-driver-with-docker-rails-and-selenium-on-aws.html</guid>
        
        <category>docker</category>
        
        <category>rails</category>
        
        <category>ruby</category>
        
        <category>selenium</category>
        
        <category>aws</category>
        
        
        <category>docker</category>
        
      </item>
    
      <item>
        <title>Creating an HTTPS Site on AWS with a .IO Domain</title>
        <description>&lt;p&gt;I recently registered my first .io domain using an all AWS stack (Route 53, EC2, Elastic Load Balancer or ELB, Amazon Certificate Manager or ACM) and I found the process mildly odd – to the degree that I know that it will either bite me again or it will bite someone else.  Either way I thought that it would be best to fully document the process.&lt;/p&gt;

&lt;p&gt;The site I’m building has login and as such https is important for this site.  Although I could have used Let’s Encrypt,&lt;/p&gt;

&lt;p&gt;If you’re using https on AWS then there’s a good chance that you are using an ELB and ACM as they make SSL brilliantly simple.  In all my years of deploying SSL, it has never been as simple as using this AWS stack and I sincerely recommend it.  The oddness occurred when I had to bind the .io domain into the certificate itself.  This process requires an email authentication to the owner of the domain to ensure that no one compromised your AWS credentials.  When you are using a normal .com or .net domain and you do this, Amazon sends the email to the email address on the domain registration itself, easy peasy.  When you are using a .io account, the email is NOT sent to the email address on the domain registration but it is instead sent to all of these:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;administrator@your_domain.io&lt;/li&gt;
  &lt;li&gt;hostmaster@your_domain.io&lt;/li&gt;
  &lt;li&gt;postmaster@your_domain.io&lt;/li&gt;
  &lt;li&gt;webmaster@your_domain.io&lt;/li&gt;
  &lt;li&gt;admin@your_domain.io&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To Amazon’s credit, they do kind of disclose this in the ACM documentation &lt;a href=&quot;http://docs.aws.amazon.com/acm/latest/userguide/troubleshoot-iodomains.html&quot;&gt;here&lt;/a&gt;. Here’s the relevant passage:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ACM does, however, send validation email to the following five common system addresses where your_domain is the domain name you entered when you initially requested a certificate and .io is the top level domain.

(see above)

To receive validation mail for an .IO domain, make sure that you have one of the preceding five email accounts enabled. If you do not, you will not receive validation email and you will not be issued an ACM certificate. 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The problem here is that like a lot of us, probably most of us, I don’t have a mail server running on my .io domain so there’s nothing to receive the email (so I can respond to it).  Now I could have set up a mail server but a much, much easier approach is to use &lt;a href=&quot;http://improvmx.com/&quot;&gt;ImprovMX&lt;/a&gt; which promises “Free painless email forwarding for your domains” and it really, really delivers.  Within only a few minutes, I had my ACM mailing and I was off to the races.  With any luck, I will even launch my new site later this week.&lt;/p&gt;

&lt;p&gt;ImprovMX is strongly, strongly recommended.&lt;/p&gt;

&lt;h1 id=&quot;thank-you&quot;&gt;Thank You&lt;/h1&gt;

&lt;p&gt;As always, I resolved this with my favorite pairing buddy, &lt;a href=&quot;http://www.nickjanetakis.com&quot;&gt;Nick Janetakis&lt;/a&gt;.  He does Docker stuff and is very, very talented.  Recommended.&lt;/p&gt;
</description>
        <pubDate>Sat, 30 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/aws/2017/09/30/creating-an-https-site-on-aws-with-a-io-domain.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/aws/2017/09/30/creating-an-https-site-on-aws-with-a-io-domain.html</guid>
        
        <category>aws</category>
        
        <category>io</category>
        
        <category>https</category>
        
        
        <category>aws</category>
        
      </item>
    
      <item>
        <title>Rails, AuthLogic, CSRF, 422 and session_store.rb</title>
        <description>&lt;p&gt;When you’re a professional developer, you come to recognize a category of problems that I refer to as “Pair Programming Required”.  These are those mysterious failures where you know damn well that something should work but &lt;em&gt;nothing&lt;/em&gt; and I repeat &lt;strong&gt;&lt;em&gt;nothing&lt;/em&gt;&lt;/strong&gt; works.  In this situation, you really want to bring another set of eyes to bear on the problem.&lt;/p&gt;

&lt;p&gt;I’m in the process of bringing a new Rails powered application online and I discovered around 3:53 am this morning that login, which works perfectly in development, completely fails in production with the wonderfully helpful error message:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Rails 5 ActionController::InvalidAuthenticityToken error&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When I dug into it, I saw that was a CSRF error and, oddly, I was getting a 422 error message returned to me.&lt;/p&gt;

&lt;p&gt;The mystery of all this was that this wasn’t new login code – it was code that I’ve been using in another application for months and it has been flawless.&lt;/p&gt;

&lt;p&gt;Here are just a few of the things that I tried to address this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Switch from Rails 5.1.x back to 5.0.x&lt;/li&gt;
  &lt;li&gt;Investigate the prepend: true approach to protect_from_forgery (&lt;a href=&quot;http://www.stackoverflow.com/questions/38331496&quot;&gt;StackOverflow&lt;/a&gt;)&lt;/li&gt;
  &lt;li&gt;Rewrite most of application_controller.rb&lt;/li&gt;
  &lt;li&gt;Massively hack around in the guts of AuthLogic&lt;/li&gt;
  &lt;li&gt;Google&lt;/li&gt;
  &lt;li&gt;Stack Overflow&lt;/li&gt;
  &lt;li&gt;Run production locally&lt;/li&gt;
  &lt;li&gt;change, deploy, test, change again, Lather, Rinse Repeat N times where N is &amp;gt; 10 and less than 50&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Once I exhausted all these possibilities, I reached out to a &lt;a href=&quot;http://www.nickjanetakis.com/&quot;&gt;friend&lt;/a&gt; and he and I paired on it.  And that’s where the power of pair programming really illustrated itself.  We fairly quickly discovered that the issue was that session_store.rb didn’t match the production domain.  I find it unbelievable that the error message wasn’t actually useful but since I’ve been guilty of that sin more than a few times, well, karma I guess.&lt;/p&gt;

&lt;p&gt;Documented here for the next time that I hit this (in the spirit of being a good Internet citizen, I did add it to the Stack Overflow as well).&lt;/p&gt;
</description>
        <pubDate>Mon, 25 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/09/25/rails-authlogic-csrf-422-and-session-store-rb.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/09/25/rails-authlogic-csrf-422-and-session-store-rb.html</guid>
        
        <category>rails</category>
        
        <category>authlogic</category>
        
        <category>csrf</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Docker Won't Install Libxml</title>
        <description>&lt;p&gt;One of the most vexing situations in any type of development is when something that you swear you’ve done literally hundreds of times fails to work – at all.  It always turns out to be that what you’re doing is 99.995% the same as something previous – and .005% different.  Last night I went to do a docker-compose build on a new application using my standard stack of Ruby, Rails, Mechanize and the like and I got this, well, crap:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[24/1918]
Gem::Ext::BuildError: ERROR: Failed to build gem native extension.

   current directory: /usr/local/bundle/gems/libxml-ruby-3.0.0/ext/libxml
/usr/local/bin/ruby -r ./siteconf20170920-5-mpa6ar.rb extconf.rb
checking for libxml/xmlversion.h in
/opt/include/libxml2,/opt/local/include/libxml2,/usr/local/include/libxml2,/usr/include/libxml2...
no
*** extconf.rb failed ***
Could not create Makefile due to some reason, probably lack of necessary
libraries and/or headers.  Check the mkmf.log file for more details.  You may
need configuration options.

Provided configuration options:
       --with-opt-dir
       --without-opt-dir
       --with-opt-include
       --without-opt-include=${opt-dir}/include
       --with-opt-lib
       --without-opt-lib=${opt-dir}/lib
       --with-make-prog
       --without-make-prog
       --srcdir=.
       --curdir
       --ruby=/usr/local/bin/$(RUBY_BASE_NAME)
       --with-xml2-config
       --without-xml2-config
       --with-xml2-dir
       --without-xml2-dir
       --with-xml2-include
       --without-xml2-include=${xml2-dir}/include
       --with-xml2-lib
       --without-xml2-lib=${xml2-dir}/lib
extconf failure: need libxml2.

   Install the library or try one of the following options to extconf.rb:

     --with-xml2-config=/path/to/xml2-config
     --with-xml2-dir=/path/to/libxml2
     --with-xml2-lib=/path/to/libxml2/lib
     --with-xml2-include=/path/to/libxml2/include


To see why this extension failed to compile, please check the mkmf.log which can
be found here:

/usr/local/bundle/extensions/x86_64-linux/2.3.0-static/libxml-ruby-3.0.0/mkmf.log
I can't get to the mkmf.log file since that's I think done with a container since its clearly linux not osx.
No clue why this is happening since I use this same damn gem everwhere
There was also this info

Gem files will remain installed in /usr/local/bundle/gems/libxml-ruby-3.0.0 for
inspection.
Results logged to
/usr/local/bundle/extensions/x86_64-linux/2.3.0-static/libxml-ruby-3.0.0/gem_make.out

An error occurred while installing libxml-ruby (3.0.0), and Bundler cannot
continue.
Make sure that `gem install libxml-ruby -v '3.0.0'` succeeds before bundling.
ERROR: Service 'web' failed to build: The command '/bin/sh -c bundle install --binstubs' returned a non-zero code: 5
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;One of the major reasons I got into Docker in the first place was to get away from this kind of crap!  Gem builds, particularly where libxml is involved, well, suck.  I spent close to two hours last night tweaking things, updating libraries and such and it was a complete and utter failure.  I even installed Docker on a brand new dev machine and got the exact same result.&lt;/p&gt;

&lt;h1 id=&quot;the-solution&quot;&gt;The Solution&lt;/h1&gt;

&lt;p&gt;This morning I revisited it using the Google query &lt;a href=&quot;https://www.google.com/search?q=docker+won%27t+install+libxml&amp;amp;ie=utf-8&amp;amp;oe=utf-8&quot;&gt;docker won’t install libxml&lt;/a&gt; and found this &lt;a href=&quot;https://github.com/docker-library/php/issues/315&quot;&gt;Github Issue&lt;/a&gt; where they suggest adding libxml2-dev to your Dockerfile.  Thus this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;RUN apk update &amp;amp;&amp;amp; apk add build-base nodejs mariadb-dev tzdata git&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;becomes&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;RUN apk update &amp;amp;&amp;amp; apk add build-base nodejs mariadb-dev tzdata git libxml2-dev&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This was hugely surprising to me because according to github, I haven’t touched my Dockerfile in &lt;strong&gt;4 months&lt;/strong&gt; ever since my &lt;a href=&quot;https://diveintodocker.com/&quot;&gt;Docker buddy and guru, Nick&lt;/a&gt;, helped me set it up.  My docker-compose file, however, was just modified 22 days ago. As docker-compose has become ever more important in the Docker world, the basic Dockerfile is something you touch less and less – apparently until something bites you in the proverbial arse.&lt;/p&gt;

&lt;h1 id=&quot;and-heres-why-this-happened&quot;&gt;And Here’s Why this Happened&lt;/h1&gt;

&lt;p&gt;My normal use of libxml, for the past decade or so, is always tied straight to Ruby’s &lt;a href=&quot;https://github.com/sparklemotion/mechanize&quot;&gt;Mechanize gem&lt;/a&gt; which I’ve had running correctly under Docker for the past six months.  And that’s why this was so, so surprising to me.  The mistake that I made was that earlier today I had added &lt;a href=&quot;https://github.com/twilio/twilio-ruby&quot;&gt;twilio-ruby&lt;/a&gt; to my Gemfile and apparently twilio-ruby has different nokogiri dependencies than Mechanize which caused the Dockerfile to need libxml2-dev.  Digging into the twilio-ruby issues, I found &lt;a href=&quot;https://github.com/twilio/twilio-ruby/issues/315&quot;&gt;this issue&lt;/a&gt; which seems to address it.&lt;/p&gt;

&lt;h1 id=&quot;see-also&quot;&gt;See Also&lt;/h1&gt;

&lt;p&gt;My buddy Nick, mentioned above, &lt;a href=&quot;https://nickjanetakis.com/blog/docker-tip-9-installing-popular-packages-on-alpine&quot;&gt;talks about this on his blog&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Thu, 21 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/09/21/docker-won-t-install-libxml.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/09/21/docker-won-t-install-libxml.html</guid>
        
        <category>docker</category>
        
        <category>rails</category>
        
        
        <category>docker</category>
        
      </item>
    
      <item>
        <title>Analyzing iPhone X, iPhone 8 and iPhone 8 Plus</title>
        <description>&lt;p&gt;I am not an Apple blogger – I leave that to people like &lt;a href=&quot;https://www.daringfireball.net&quot;&gt;Daring Fireball&lt;/a&gt; but I am an avid Apple user.  Between my wife and two sons, all of us have at least one Mac, iPad or iPhone.  I wrote this piece to analyze the differences between the new iPhones and help analyze how to spend what ultimately will be quite a bit of money.&lt;/p&gt;

&lt;p&gt;Note: This is all sourced from the web; my thanks to all the wonderful coverage cited below.  Particular kudos to Quincy Larson for his salient &lt;a href=&quot;https://medium.freecodecamp.org/why-you-should-never-unlock-your-phone-with-your-face-79c07772a28&quot;&gt;FaceID analysis&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;understanding-your-personal-phone-usage&quot;&gt;Understanding Your Personal Phone Usage&lt;/h1&gt;

&lt;p&gt;I think the key to deciding whether or not to upgrade is to understand your personal phone usage and then if the new phones offer &lt;em&gt;you&lt;/em&gt; a benefit.  You &lt;em&gt;don’t have&lt;/em&gt; to upgrade.  Let me repeat that – you &lt;strong&gt;don’t have&lt;/strong&gt; to upgrade.  Personally I am still running a 128 gig iPhone 6.  I never made the leap to the 7 because I use the smaller phone form factor and the camera was mostly unchanged from the 6 to the 7.  Given the importance of the camera to people’s daily lives, I was delighted to see all the camera updates in the iPhone X - it is now the same camera as the 6 plus / 7 plus but in the smaller phone’s form factor (ok the X is a little bit larger but I would deem it insignificant).&lt;/p&gt;

&lt;p&gt;My iPhone usage pattern is simple: it goes &lt;strong&gt;everywhere&lt;/strong&gt; I go.  I carry it constantly and the only place I don’t take it is swimming. I’ve carried it with me when I was:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;working on a roof&lt;/li&gt;
  &lt;li&gt;cutting down trees&lt;/li&gt;
  &lt;li&gt;fishing&lt;/li&gt;
  &lt;li&gt;working out&lt;/li&gt;
  &lt;li&gt;cooking&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In aggregate, I use my phone more than any other computing device.  I compute less with it than I do a laptop but I use it more (if that makes sense).&lt;/p&gt;

&lt;p&gt;Since I am using an iPhone 6 still, this means that I am now two cycles removed from current.  Consequently my battery life is such that I have to recharge during the day even when I’m not using the GPS, I’m constantly running out of space, the screen is scratched (no clue how that happened).  I am thus in the market for a new phone.&lt;/p&gt;

&lt;h1 id=&quot;new-phones-summarized&quot;&gt;New Phones Summarized&lt;/h1&gt;

&lt;p&gt;There are three new phones:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-8/specs/&quot;&gt;iPhone 8&lt;/a&gt; (similar to the current 7).  $699.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-x/specs/&quot;&gt;iPhone 8 Plus&lt;/a&gt; (similar to the current 7 plus).  $799.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-x/specs/&quot;&gt;iPhone X&lt;/a&gt; (the new phone).  $999.  Slightly bigger physically than the current iPhone 6 / 7 base model but NOT at all as large as the plus model.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The iPhone X is the new hotness with an all new form factor, better camera, &lt;strong&gt;no home button&lt;/strong&gt; and an OLED screen.  Both the iPhone X and iPhone 8 offer wireless charging although Apple’s own wireless charging mat will not ship until “2018”.  Given the AirPod shipping delays this is concerning.  Technically any Qi compatible charging mat can be used but my suspicion is that Apple’s will somehow be better / faster (otherwise why the delay).&lt;/p&gt;

&lt;h1 id=&quot;key-stats&quot;&gt;Key Stats&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;iPhone X is available for pre-order on October 27 w/ launch on November 3&lt;/li&gt;
  &lt;li&gt;iPhone X is available in 256 and 64 gig capacities&lt;/li&gt;
  &lt;li&gt;iPhone X has the &lt;strong&gt;same camera&lt;/strong&gt; as on the 7 Plus.&lt;/li&gt;
  &lt;li&gt;iPhone X has no home button and no TouchID.&lt;/li&gt;
  &lt;li&gt;iPhone X claims 2 hours longer battery life than the iPhone 7.&lt;/li&gt;
  &lt;li&gt;Animoji is exclusive to the iPhone X&lt;/li&gt;
  &lt;li&gt;iPhone 8 is available for pre-order on September 15th with launch on September 22&lt;/li&gt;
  &lt;li&gt;iPhone 8 and iPhone 8 Plus offer 12 MP cameras but the 8 Plus also has a telephoto lens.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;See the &lt;a href=&quot;https://www.apple.com/iphone/compare/&quot;&gt;Compare page&lt;/a&gt; for more.&lt;/p&gt;

&lt;h1 id=&quot;qualms-and-a-decision&quot;&gt;Qualms and a Decision&lt;/h1&gt;

&lt;p&gt;My biggest issue with the iPhone X is the lack of the home button and TouchID.  This is a fundamental change to the iPhone interface and one that greatly concerns me.  &lt;a href=&quot;https://medium.freecodecamp.org/why-you-should-never-unlock-your-phone-with-your-face-79c07772a28&quot;&gt;Quincy Larson&lt;/a&gt; raises some excellent points on why you shouldn’t unlock with your face.  Personally I find the need to unlock your phone while driving (GPS, play a podcast, etc) and the new FaceID feature disturbing to say the least.  As the parent of a driving age teenager, I will not be eager to see him get anything with FaceID.  Thankfully the device cost alone will prevent that but in a few years …&lt;/p&gt;

&lt;p&gt;Based on the analysis that I’ve done so far, I’m likely to upgrade to the iPhone X and do it through Apple’s monthly plan.  From what I’ve read, this amounts to about a $12 and change difference over the baseline 7 model and while I don’t like the $999 price, I don’t think that’s too much for something that I use constantly and travels with me literally everywhere I go that isn’t a swimming pool.&lt;/p&gt;

&lt;p&gt;The tipping point that pushed me over the edge to the new iPhone X was the new camera features being available in the iPhone X’s smaller form factor.  Had iPhone X had the same camera as the iPhone 7 then I likely wouldn’t have upgraded at all.  And had the iPhone 7 had the new camera as the iPhone X or 7 Plus, I likely would have decided to stay with the traditional home button design and not risked learning the new gestures.&lt;/p&gt;

&lt;h1 id=&quot;see-also&quot;&gt;See Also&lt;/h1&gt;

&lt;p&gt;Here are some excellent breakdowns:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone/compare/&quot;&gt;Apple iPhone Compare Page&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-x/&quot;&gt;Apple iPhone X Page&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-8/&quot;&gt;Apple iPhone 8 Page&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/apple-watch-series-3/&quot;&gt;Apple Watch Page&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-x/specs/&quot;&gt;iPhone X Tech Specs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.apple.com/iphone-8/specs/&quot;&gt;iPhone 8 Tech Specs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://arstechnica.com/gadgets/2017/09/hands-on-with-the-iphone-x-oled-and-hdr-outshine-everything-else/&quot;&gt;Ars Technica Hands On on the iPhone X&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://arstechnica.com/gadgets/2017/09/apples-radically-different-smartphone-is-called-the-iphone-x/&quot;&gt;Ars Technica on the iPhone X&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.theverge.com/2017/9/12/16287932/apple-iphone-8-plus-photos-video-hands-on&quot;&gt;iPhone 8 and 8 Plus from The Verge&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.theverge.com/2017/9/12/16291244/new-iphone-x-photos-video-hands-on&quot;&gt;iPhone X from the Verge&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.macrumors.com/roundup/iphone-x/&quot;&gt;MacRumors on iPhone X&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.macrumors.com/roundup/iphone-8/&quot;&gt;MacRumors on iPhone 8&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=15229317&quot;&gt;Apple Watch Discussion on Hacker News&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Wed, 13 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/iphone/2017/09/13/analyzing-iphone-x-iphone-7-and-iphone-7-plus.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/iphone/2017/09/13/analyzing-iphone-x-iphone-7-and-iphone-7-plus.html</guid>
        
        <category>iphone</category>
        
        <category>apple</category>
        
        
        <category>iphone</category>
        
      </item>
    
      <item>
        <title>Remembering Jerry Pournelle</title>
        <description>&lt;p&gt;There were three main dimensions to how I grew up:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Reading.&lt;/li&gt;
  &lt;li&gt;Computing.&lt;/li&gt;
  &lt;li&gt;Entrepreneurship.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Jerry_Pournelle&quot;&gt;Jerry Pournelle&lt;/a&gt; dramatically affected each of these for me.  Here’s how:&lt;/p&gt;

&lt;h1 id=&quot;reading&quot;&gt;Reading&lt;/h1&gt;

&lt;p&gt;If you strip everything else away from me, at my core, I am a reader, specifically of the science fiction variety – and this goes all the way back to my childhood.  I’ve been reading as long as I can remember and it pretty much always has been science fiction.  I got started early with the Heinlein juveniles and it wasn’t a far leap from Heinlein to Jerry Pournelle.  I still remember when the librarians let me move from the kids section of the library to the adult section and that’s where I found him - King David’s Spaceship, West of Honor, Lucifer’s Hammer, Oath of Fealty and more.  And I can remember devouring Jerry’s work in Analog both under his name and under “Wade Curtis” when I started buying back issues and I remember having &lt;a href=&quot;https://www.abebooks.com/book-search/author/curtis-wade-pournelle-jerry/&quot;&gt;this one&lt;/a&gt; in my collection.&lt;/p&gt;

&lt;p&gt;A good author, whether fact or fiction, imparts something to his readers far beyond the story and what Jerry Pournelle gave to me was a deep appreciation for engineering and just plain &lt;em&gt;rationality&lt;/em&gt;.  Thanks Jerry!&lt;/p&gt;

&lt;h1 id=&quot;computing&quot;&gt;Computing&lt;/h1&gt;

&lt;p&gt;Right along side reading for me was computing which I discovered in the 7th grade in Wilton, Connecticut at the school’s computer lab (a selection of TRS-80 Model 1s).  A trip to the local Walden Books made me aware of Byte Magazine way back in April 82 with this issues:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://fiu-assets-2-syitaetz61hl2sa.stackpathdns.com/static/use-media-items/25/24048/full-971x1298/56703a87/198204.jpeg?resolution=0&quot; alt=&quot;byte magazine&quot; /&gt;&lt;/p&gt;

&lt;p&gt;That issue is still in my office and as I write this it is on my desk; I’ve owned it since I was 14 years old.&lt;/p&gt;

&lt;p&gt;And if I’m being honest, well, I understood about 1 word in 20, mostly the adjectives but what I did find actually not only readable but just plain joyful was &lt;em&gt;Chaos Manor&lt;/em&gt;, Jerry Pournelle’s column.  From that point forward, I read Byte for Jerry’s column and he was the person who gave me a deep love for computing in general and software in specific.  I can remember hours upon hours in my college library devouring back issues of Byte Magazine once I found their periodicals section.&lt;/p&gt;

&lt;p&gt;Finally I became aware of hypertext from things written in Byte Magazine – and my first startup was a hypertext company.  If not for Jerry addicting me to Byte Magazine, I might never have known about it and my whole life would have been different.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; If you didn’t read Jerry back in the day then you don’t understand what a colossus Jerry was in small computing.  Computing was deeply different in those days, a much smaller community and if you were influential, well, you were important.  This was a man who knew everyone – Bill Gates, Marvin Minsky, Steve Wozniak and more.  According to Jerry, Byte Magazine paid him $10,000 per month to write that column and that’s a fair bit of $$$ even today – back in the early 80s, that was a king’s ransom just to write a monthly computer column.&lt;/p&gt;

&lt;h1 id=&quot;entrepreneurship&quot;&gt;Entrepreneurship&lt;/h1&gt;

&lt;p&gt;I started my first company, a software firm building hypertext tools, when I was 19 and the very first copy of software I ever sent to a reviewer was sent to Jerry Pournelle.  He didn’t cover it then and it took repeated copies that we kept sending him until November 26, 1990 when he did give us some coverage in his &lt;a href=&quot;https://books.google.com/books?id=u1AEAAAAMBAJ&amp;amp;pg=PA64&amp;amp;lpg=PA64&amp;amp;dq=%22jerry+pournelle%22+%22ntergaid%22&amp;amp;source=bl&amp;amp;ots=pDFl9rznro&amp;amp;sig=wHE-VXmUd2h64RPIIYSYmvcs2Rs&amp;amp;hl=en&amp;amp;sa=X&amp;amp;ved=0ahUKEwjGjdCY55zWAhUJ5oMKHeZPCHoQ6AEIJjAA#v=onepage&amp;amp;q=%22jerry%20pournelle%22%20%22ntergaid%22&amp;amp;f=false&quot;&gt;Infoworld column&lt;/a&gt;. A huge amount of what I know about the software business, specifically about writing good documentation, providing good technical support and just plain listening to customers, I learned from Jerry and his long tales of Zeke, the S100 bus and more.  Jerry wrote about computing from the user’s perspective and he gave a large number of us a deep appreciation for the user.&lt;/p&gt;

&lt;h1 id=&quot;rediscovering-jerry-pournelle-through-twit&quot;&gt;Rediscovering Jerry Pournelle Through Twit&lt;/h1&gt;

&lt;p&gt;Despite the deep impact that Jerry Pournelle has had on my life, I haven’t thought much about Jerry for a long time now – Byte is long gone and the pace of his fiction output has decreased and his Chaos Manor column on the web didn’t resonate for me in the same way as his print column.  But thanks to Leo Laporte’s excellent TWIT show on YouTube, I have been able to discover him all over again:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=S7j3IG4h42Y&quot;&gt;Twit 90&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=_5UVunOiXCk&quot;&gt;Twit 95&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are some amazing stories here:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;In Twit 90, he talks about making nitroglycerin at age 12&lt;/li&gt;
  &lt;li&gt;In Twit 95, he talks about the act of god that led him into freelance writing and then discussing the probability of it with Marvin Minsky (Minsky created Lisp and founded the MIT AI lab)&lt;/li&gt;
  &lt;li&gt;In Twit 95, we talks about Robert Heinlein and the problem with being a best selling author, no one has the guts to edit you: “Time Enough or Love – there are three good novels there, shouldn’t they be three good novels?” (loose paraphrase but it is pretty close)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In Twit 90, Jerry describes his Byte writing as “I wrote the Field and Stream column” and that analogy instantly brought all of his computing writing into focus for me since I actually grew up hunting &lt;strong&gt;and&lt;/strong&gt; reading Field and Stream.&lt;/p&gt;

&lt;p&gt;Thank you very, very much Leo for doing these interviews, listening to you talk with Jerry for a few hours means a huge amount to me.&lt;/p&gt;

&lt;p&gt;Goodbye Jerry, you’ll be missed but your influence is still alive and well.&lt;/p&gt;
</description>
        <pubDate>Mon, 11 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/personal/2017/09/11/remembering-jerry-pournelle.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/personal/2017/09/11/remembering-jerry-pournelle.html</guid>
        
        <category>personal</category>
        
        <category>scifi</category>
        
        
        <category>personal</category>
        
      </item>
    
      <item>
        <title>SAAS Business Best Practices from Jonathan Siegel</title>
        <description>&lt;p&gt;Jonathan Siegel wrote &lt;a href=&quot;https://www.amazon.com/dp/B071NGMJPN&quot;&gt;The San Francisco Fallacy&lt;/a&gt; which is my favorite startup book of the year.  I liked it well enough that I’m in the middle of a second read and its one of the books I packed for an upcoming trip to Disney World.  Jonathan was &lt;a href=&quot;http://okdork.com/buying-a-business-jonathan-siegel/&quot;&gt;recently interviewed by Noah Kagan for Ok Dork&lt;/a&gt; and while all of it was excellent, there was one brief shining moment where it felt like the sun had opened up and ideas were literally shining down.  Here’s a recap of the best practices that he identified for a SAAS business:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Testing their adwords.&lt;/li&gt;
  &lt;li&gt;Doing landing page testing.&lt;/li&gt;
  &lt;li&gt;Sending out newsletters.&lt;/li&gt;
  &lt;li&gt;Blogging regularly.&lt;/li&gt;
  &lt;li&gt;Forming partnerships.&lt;/li&gt;
  &lt;li&gt;Going to events.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;5 minute callbacks whenever they get a new lead on the website&lt;/strong&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Try six times to reach every new inbound lead&lt;/strong&gt;.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Numbers 7 and 8 are new to me and ones that I definitely want to try.  Much of this interview was covering how he buys a business and the money statement of this was “If they team is already doing all these then I would never buy this company” because these techniques are how he adds value to the business and increases revenue.&lt;/p&gt;

&lt;p&gt;All of this was covered around the 24 minute mark.  If you’re an entrepreneur, I’d highly recommend listening to this podcast.  Noah’s stuff is always great but this particular episode was golden.  There’s also a great segment on how he identifies people to hire and why he doesn’t hire A players.&lt;/p&gt;
</description>
        <pubDate>Wed, 06 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/saas/2017/09/06/saas-business-best-practices-from-jonathan-siegel.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/saas/2017/09/06/saas-business-best-practices-from-jonathan-siegel.html</guid>
        
        <category>saas</category>
        
        <category>marketing</category>
        
        <category>best_practices</category>
        
        <category>business</category>
        
        
        <category>saas</category>
        
      </item>
    
      <item>
        <title>Reclaiming Docker Disc Space on OSX</title>
        <description>&lt;p&gt;A few nights ago, after a truly horrible night’s sleep complete with my first ever incidence of acid reflux, I woke to find my Mac nattering at me about being &lt;strong&gt;out of disc space&lt;/strong&gt;.  And by out of disc space I mean that I was down to about 3 gigs out of a terabyte sized SSD.  Yikes!&lt;/p&gt;

&lt;p&gt;Taking a look at the normal culprits yielded no surprise increases and I can distinctly recall having in excess of 30 gigs just a day or two ago.  Given all the &lt;a href=&quot;http://fuzzyblog.io/blog/docker/2017/08/30/running-out-of-disc-space-with-docker.html&quot;&gt;server side problems with respect to Docker and disc space&lt;/a&gt; that I have written about previously, I had a strong hunch that somehow Docker was involved.&lt;/p&gt;

&lt;h1 id=&quot;logs&quot;&gt;Logs&lt;/h1&gt;

&lt;p&gt;My first thought was that perhaps Docker logs are huge.  On OSX, Docker logs are stored here:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/log&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;But a quick:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;09:41 $ du -shc ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/log
 20K	/Users/sjohnson/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/log
 20K	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Nope – clearly 20K isn’t anything for disc space usage.&lt;/p&gt;

&lt;h1 id=&quot;containers&quot;&gt;Containers&lt;/h1&gt;

&lt;p&gt;My next thought was that perhaps Docker has some massive backing store for containers.  I did a bunch of searches and ran across this &lt;a href=&quot;https://forums.docker.com/t/consistently-out-of-disk-space-in-docker-beta/9438/67&quot;&gt;Docker thread&lt;/a&gt; and then &lt;a href=&quot;https://forums.docker.com/t/consistently-out-of-disk-space-in-docker-beta/9438/36&quot;&gt;another thread&lt;/a&gt;, both of which pointed me to the Docker.qcow2 file.&lt;/p&gt;

&lt;p&gt;Here’s what a du -shc showed me on this file:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
 57G	/Users/sjohnson/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
 57G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;futile-attempts-to-reclaim-space&quot;&gt;Futile Attempts to Reclaim Space&lt;/h1&gt;

&lt;p&gt;I tried the normal things like:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;docker system prune&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;And when that failed, I tried a bash based approach:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;item &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;docker ps -aq&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do
&lt;/span&gt;docker stop &lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;
docker rm &lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done

for &lt;/span&gt;item &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;docker images --filter &lt;span class=&quot;nv&quot;&gt;dangling&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt; -q&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do
&lt;/span&gt;docker rmi &lt;span class=&quot;nv&quot;&gt;$item&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;But even after both of these, I still had:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
 57G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;my-solution&quot;&gt;My Solution&lt;/h1&gt;

&lt;p&gt;Here was the approach that I used:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Quit Docker for Mac entirely.&lt;/li&gt;
  &lt;li&gt;rm /Users/sjohnson/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2&lt;/li&gt;
  &lt;li&gt;As best as I can tell this is actually safe because containers can always be rebuilt.&lt;/li&gt;
  &lt;li&gt;Restart Docker&lt;/li&gt;
  &lt;li&gt;Verify space usage:&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
  1.3G total&lt;/p&gt;

&lt;p&gt;I then built a container and then reverified disc space usage.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
1.3G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I then built some more containers and then checked disc space usage:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
3.0G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I then started my overall “build all containers” shell script and tracked progress as it went:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
3.0G	total

09:58 $ du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
3.1G	total

du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
3.4G    total

du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
5.4G    total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;By the time all containers were built:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
7.2G    /Users/sjohnson/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;And now, several days later and even more deploys, it has increased again:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;du -shc     ~/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
8.2G	/Users/sjohnson/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
8.2G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;read-more&quot;&gt;Read More&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://forums.docker.com/t/consistently-out-of-disk-space-in-docker-beta/9438/67&quot;&gt;Great Docker Thread about Disc Space Usage&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://forums.docker.com/t/where-does-docker-keep-images-containers-so-i-can-better-track-my-disk-usage/8370&quot;&gt;Docker Thread about Disc Space&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Wed, 06 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/09/06/reclaiming-docker-disc-space-on-osx.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/09/06/reclaiming-docker-disc-space-on-osx.html</guid>
        
        <category>docker</category>
        
        <category>osx</category>
        
        <category>mac</category>
        
        
        <category>docker</category>
        
      </item>
    
      <item>
        <title>Notes on Upgrading to Rails 5.1</title>
        <description>&lt;p&gt;So this morning I upgraded the suite of Rails apps (7 in total) that make up the product that I’ve been building from Rails 5.0.2 to 5.1.3.  I took my usual, slow as a turtle, approach to doing this upgrade (5.1.4 has now reached RC1 status which means that 1 release behind is uite stable by now).  The main change driving my desire to upgrade was the improved low level connection handling in ActiveRecord which should make developing multi-tenant applications better.&lt;/p&gt;

&lt;p&gt;Here are a few notes on upgrading to Rails 5.1.&lt;/p&gt;

&lt;h1 id=&quot;the-lines-to-change-in-gemfile&quot;&gt;The Lines to Change in Gemfile&lt;/h1&gt;

&lt;p&gt;Previously I had:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem 'rails', '~&amp;gt; 5.0.2'
gem 'puma', '~&amp;gt; 3.0'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;which I changed to&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem 'rails', '~&amp;gt; 5.1.3'
gem 'puma', '~&amp;gt; 3.10'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The reason for the Puma update turned out to be unneeded but it is a core part of my stack so it is likely good to upgrade.&lt;/p&gt;

&lt;h1 id=&quot;useful-links&quot;&gt;Useful Links&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://edgeguides.rubyonrails.org/5_1_release_notes.html&quot;&gt;Rails 5.1 Readme&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rubygems.org/gems/puma/versions/3.4.0&quot;&gt;Ruby Gems on Puma&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rubygems.org/gems/rails/versions/5.0.0&quot;&gt;Ruby Gems on Rails&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;dont-be-afraid-to-delete-gemfilelock-and-re-bundle&quot;&gt;Don’t Be Afraid to Delete Gemfile.lock and Re Bundle&lt;/h1&gt;

&lt;p&gt;Out of my seven apps, all built on top of the same version of Rails, two had problems with:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle update rails puma&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;These two applications had issues with the font-awesome-rails gem and railties.  Rather than try and monkey around with them, I simply did a:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;git rm Gemfile.lock&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;and then a:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle install&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;And that fixed everything.&lt;/p&gt;

&lt;h1 id=&quot;puma-now-needs-a-space-before-the-port&quot;&gt;Puma Now Needs a Space Before the Port&lt;/h1&gt;

&lt;p&gt;Right after my Rails update and before I did the Puma update, I got this bit of joy when I started my server:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bundle exec rails s -p3203
=&amp;gt; Booting Puma
=&amp;gt; Rails 5.1.3 application starting in development on http://localhost:3203
=&amp;gt; Run `rails server -h` for more startup options
Puma starting in single mode...
* Version 3.10.0 (ruby 2.3.1-p112), codename: Russell's Teapot
* Min threads: 2, max threads: 2
* Environment: development
* Listening on tcp://
Exiting
/Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `initialize': getaddrinfo: nodename nor servname provided, or not known (SocketError)
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `new'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:270:in `add_tcp_listener'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:105:in `block in parse'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:88:in `each'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/binder.rb:88:in `parse'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/runner.rb:144:in `load_and_bind'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/single.rb:87:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/puma/launcher.rb:183:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/puma-3.10.0/lib/rack/handler/puma.rb:69:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/rack-2.0.3/lib/rack/server.rb:297:in `start'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:44:in `start'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:131:in `block in perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:126:in `tap'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands/server/server_command.rb:126:in `perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor/command.rb:27:in `run'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor/invocation.rb:126:in `invoke_command'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/thor-0.20.0/lib/thor.rb:387:in `dispatch'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/command/base.rb:63:in `perform'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/command.rb:44:in `invoke'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_admin/gems/railties-5.1.3/lib/rails/commands.rb:16:in `&amp;lt;top (required)&amp;gt;'
        from /Users/sjohnson/Dropbox/fuzzygroup/hyde/seira_watch/seira_admin/bin/rails:9:in `require'
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This turned out to be a change somewhere in Rails where a space is now needed between the -p and the port number, so this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle exec rails s -p3203&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;needs to be:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;bundle exec rails s -p 3203&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This was covered in this &lt;a href=&quot;https://github.com/rails/rails/issues/28971&quot;&gt;Github Issue&lt;/a&gt;. Supposedly the latest version of Puma restores the previous functionality where a space isn’t needed but I have &lt;strong&gt;NOT&lt;/strong&gt; found that to be so.  The solution was to simply accept that a space after -p is required.  Technically I could have not upgraded Puma but it feels like running the current version of is always a good thing.&lt;/p&gt;

&lt;h1 id=&quot;middleware-now-needs-a-class-constant-not-a-string&quot;&gt;Middleware Now Needs a Class Constant Not a String&lt;/h1&gt;

&lt;p&gt;What I am building uses a multi-tenant approach based on the &lt;a href=&quot;https://github.com/influitive/apartment&quot;&gt;Apartment gem&lt;/a&gt; and this requires an initializer that specifies a middleware layer.  Prior to Rails 5.1, this was done as follows:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rails.application.config.middleware.use 'Apartment::Elevators::Subdomain'
(in config/initializers/apartment.rb)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;When I first started my application using Rails 5.1, I got this unpleasant result:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; bundle exec rails s -p 3210
=&amp;gt; Booting Puma
=&amp;gt; Rails 5.1.3 application starting in development on http://localhost:3210
=&amp;gt; Run `rails server -h` for more startup options
Exiting
/Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:35:in `build': undefined method `new' for &quot;Apartment::Elevators::Subdomain&quot;:String (NoMethodError)
Did you mean?  next
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `block in build'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `each'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `inject'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/actionpack-5.1.3/lib/action_dispatch/middleware/stack.rb:99:in `build'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:508:in `block in app'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:504:in `synchronize'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/engine.rb:504:in `app'
        from /Users/sjohnson/.rvm/gems/ruby-2.3.1@seira_watch/gems/railties-5.1.3/lib/rails/application/finisher.rb:45:in `block in &amp;lt;module
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Apparently middleware layers that used to take a string now need a class constant so this needs to be rewritten as:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Rails.application.config.middleware.use Apartment::Elevators::Subdomain
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This is discussed in this &lt;a href=&quot;https://github.com/rails/rails/issues/28946&quot;&gt;Rails Issue&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&quot;skipbeforefilter-is-now-skipbeforeaction&quot;&gt;skip_before_filter Is Now skip_before_action&lt;/h1&gt;

&lt;p&gt;Although I was able to start my application correctly in development mode with a still in place skip_before_filter, when I tried it in production, I got:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;=&amp;gt; Run `rails server -h` for more startup options
Exiting
/Users/sjohnson/Dropbox/fuzzygroup/hyde/seira_watch/seira_watch_web_app/app/controllers/api_controller.rb:3:in   `&amp;lt;class:ApiController&amp;gt;': undefined method `skip_before_filter' for ApiController:Class (NoMethodError)
Did you mean?  skip_before_action
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This was an easy change but it is still something that could easily trip you up.  Obviously I have been seeing the deprecation warnings for some time now and it is my bad for not having made these changes.&lt;/p&gt;

&lt;h1 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h1&gt;

&lt;p&gt;While mildly annoying these are relatively small issues htat I was able to work around quite cleanly.  The total time to upgrade 7 Rails apps from 5.0.2 to 5.1 was less than an hour in total even including the research and deploy time.  &lt;strong&gt;Recommended&lt;/strong&gt;.&lt;/p&gt;

&lt;h1 id=&quot;public-service-announcement&quot;&gt;Public Service Announcement&lt;/h1&gt;

&lt;p&gt;If you haven’t upgraded your Ruby Gems executable, you likely should.  &lt;a href=&quot;https://www.ruby-lang.org/en/news/2017/08/29/multiple-vulnerabilities-in-rubygems/&quot;&gt;More details are here&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Fri, 01 Sep 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/rails/2017/09/01/notes-on-upgrading-to-rails-5-1.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/rails/2017/09/01/notes-on-upgrading-to-rails-5-1.html</guid>
        
        <category>rails</category>
        
        <category>ruby</category>
        
        <category>puma</category>
        
        <category>apartment</category>
        
        
        <category>rails</category>
        
      </item>
    
      <item>
        <title>Running out of Disc Space with Docker</title>
        <description>&lt;p&gt;I’ve now been exploring &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; for almost a year now and using it daily for five months or so.  And, as I get ever closer to shipping a product that runs using containers for everything, I have been continually hitting issues regarding running out of disc space.&lt;/p&gt;

&lt;h1 id=&quot;understanding-the-problem&quot;&gt;Understanding The Problem&lt;/h1&gt;

&lt;p&gt;The platform I have been using is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Docker Community Edition, Docker version 17.06.0-ce, build 02c1d87&lt;/li&gt;
  &lt;li&gt;AWS EC2 instances including ELB&lt;/li&gt;
  &lt;li&gt;No use of Kubernetes or the AWS ECS&lt;/li&gt;
  &lt;li&gt;Ubuntu Linux&lt;/li&gt;
  &lt;li&gt;Docker Hub for image hosting&lt;/li&gt;
  &lt;li&gt;Rails / Ruby as an application language&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What I have experienced is constant growth in disc space usage ultimately ending up in 0 bytes of free disc space and subsequent failure conditions in most of my containers.&lt;/p&gt;

&lt;h1 id=&quot;docker-on-linux-basics&quot;&gt;Docker on Linux Basics&lt;/h1&gt;

&lt;p&gt;On Ubuntu and most Linux platforms that I understand, the core Docker installation of your data is stored in /var/lib/docker and then a collection of subdirectories.  Here’s an example:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ls -l /var/lib/docker
total 44
drwx------ 21 root root  4096 Aug 30 01:17 containers
drwx------  3 root root  4096 Aug 30 01:10 image
drwxr-x---  3 root root  4096 Aug 30 01:10 network
drwx------ 85 root root 12288 Aug 30 01:17 overlay2
drwx------  4 root root  4096 Aug 30 01:10 plugins
drwx------  2 root root  4096 Aug 30 01:10 swarm
drwx------  2 root root  4096 Aug 30 01:16 tmp
drwx------  2 root root  4096 Aug 30 01:10 trust
drwx------ 12 root root  4096 Aug 30 03:01 volumes
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;There are two interesting directories here: containers and overlay2.  You should note that on a default docker installation the overlay2 directory would be named aufs.  The directories overlay2 and aufs are different filesystems that Docker can use to store your containers, volumes, etc.  The default Docker filesystem is called aufs and it is the oldest Docker filesystem.  The overlay2 filesystem is newer and seems to have some dramatic advantages.&lt;/p&gt;

&lt;p&gt;I am currently involved in what is termed &lt;em&gt;green field&lt;/em&gt; software development – this is a development term related to creating a brand new product i.e. everything is a green field waiting to be plowed.  One of the characteristics of green field development is a &lt;strong&gt;lot&lt;/strong&gt; of deploys.  As I initially looked into this problem, its characteristics seemed to map directly to the number of deploys – more deploys meant more disc space used.  When you see this type of situation, it tends to argue that the underlying issue is somehow tied to garbage collection.  My research and analysis of this led me to think that the issue was somehow tied to issues in the Docker aufs filesystem and I switched my installation from aufs to overlay2 and thought it was resolved.&lt;/p&gt;

&lt;p&gt;Last night I started getting alerts that my production server was again almost out of disc space (thank you &lt;a href=&quot;https://github.com/arnaudsj/monit&quot;&gt;Monit!&lt;/a&gt;).  Now the interesting thing is that between when I thought this was resolved and last night, I &lt;strong&gt;have not been deploying at all&lt;/strong&gt;.  Over the past 5 days, I have been involved in an intense refactor of my new product’s two core &lt;a href=&quot;https://en.wikipedia.org/wiki/God_object&quot;&gt;god objects&lt;/a&gt; - course.rb and teacher.rb.  In software development parlance, a god object is an object that knows too much or does too much and it is regarded as an &lt;a href=&quot;https://en.wikipedia.org/wiki/Anti-pattern&quot;&gt;anti pattern&lt;/a&gt;.  When you do this type of refactoring, it tends to shut down everything since it breaks, well, &lt;strong&gt;everything&lt;/strong&gt;.  Seeing that I was again running out of disc space – while I wasn’t deploying – argued that my working theory was just plain &lt;strong&gt;wrong&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;My next step was to ssh into the box (yes, even with a containerized architecture, there are still servers and sshing in is still a thing) and look into /var/lib/docker once again.  My general tool for this was the command du -shc *  which translates to “show me the disc space usage at a summary level and translate it to human style (i.e. k / megs / gigs)”.  Here’s an example of my command flow:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su - 
cd /var/lib/docker
du -shc * 

du -shc *
10G	containers
11M	image
140K	network
3.4G	overlay2
20K	plugins
4.0K	swarm
4.0K	tmp
4.0K	trust
3.3M	volumes
13.5G	total
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I started to wonder what could possibly be in the containers directory with a size of &lt;strong&gt;10G&lt;/strong&gt; so I changed into that directory and I found an anomaly, a single file, 6.2 gigs in size, like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;586e6e0b559281785d023097518ed9303e15db66eee04173792856ff7b2da528-json.log
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;When I looked at that file, it was a log file showing the log output from the underlying crawler at the coder of the product I have been building.  And with this one discovery, the problem came into focus:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;While there may have been issues related to a constant ongoing deploy process, the core underlying issue seems to be disc usage due to log file build up.&lt;/li&gt;
  &lt;li&gt;Docker makes it very hard to see the underlying problem since there doesn’t seem to be a “where is my damn disc space going” type of command.  Update: Try using “docker system df” to visualize docker disc space usage.  I only found this late in the writing process on this post.  The docker system df command doesn’t specifically report log file space usage which I suspect would illuminate this problem.&lt;/li&gt;
  &lt;li&gt;Logs appear to be persistent over time and not reclaimed as you deploy.  My suspicion is that logs are only reset when you stop the Docker daemon (and sometimes not even then).&lt;/li&gt;
  &lt;li&gt;Traditional log management like log rotate won’t work unless you restart the Docker daemon.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Sidebar&lt;/strong&gt;: I wonder how many people that have struggled with this issue have actually had log file growth issues not actual Docker problems?  Most of the unresolved Docker / Moby issues below don’t explore the logs possibility.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;It should be noted that I’m not logging to files from within my application code and I’m using the log to standard out approach from the &lt;a href=&quot;https://github.com/nickjj/orats&quot;&gt;Orats gem&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;fixing-this-problem-once-and-for-all&quot;&gt;Fixing this Problem Once and For All&lt;/h1&gt;

&lt;p&gt;Here are the steps that I took to address this problem:&lt;/p&gt;

&lt;h2 id=&quot;step-1-stop-the-docker-daemon&quot;&gt;Step 1: Stop the Docker Daemon&lt;/h2&gt;

&lt;p&gt;The first step is shutting down Docker itself:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo service docker stop&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;step-2-delete-varlibdocker&quot;&gt;Step 2: Delete /var/lib/docker&lt;/h2&gt;

&lt;p&gt;The next step appears drastic and it is.  If you have important data in your Docker system then you’re going to lose it at this stage but when I attempted to do this piecemeal, I got bizarre deployment errors related to missing containers and even redeploying did not fix it.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo su
umount /var/lib/docker/overlay2
cd /var/lib/docker
rm -rf * 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This blows away everything in your Docker installation.  The second command line is only necessary if you have already switched your system to overlay2 as I had.&lt;/p&gt;

&lt;h2 id=&quot;step-3-switch-from-aufs-to-overlay2-and-add-log-limits-to-docker-config&quot;&gt;Step 3: Switch from aufs to overlay2 and Add Log Limits to Docker Config&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: Full use of the overlay2 driver is covered &lt;a href=&quot;https://docs.docker.com/engine/userguide/storagedriver/overlayfs-driver/#configure-docker-with-the-overlay-or-overlay2-storage-driver&quot;&gt;here&lt;/a&gt; and should probably be read before you make this switch.  Not everyone can make use of overlay2.&lt;/p&gt;

&lt;p&gt;The core docker config file is:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/docker/daemon.json&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You should edit this file and make it look something like this:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;storage-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;overlay2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;log-driver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;log-opts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&quot;max-size&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;100m&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Disclaimer&lt;/strong&gt;: I’m honestly not 100% certain that switching from aufs to overlay2 is absolutely required but it was a part of the overall solution and does seem to have benefits so I left it in here although I suspect that the logging is clearly the biggest win here.&lt;/p&gt;

&lt;h2 id=&quot;step-4-restart-docker-daemon&quot;&gt;Step 4: Restart Docker Daemon&lt;/h2&gt;

&lt;p&gt;Start Docker up again:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo service docker start&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;step-5-add-logging-limits-to-your-compose-files&quot;&gt;Step 5: Add Logging Limits to Your Compose Files&lt;/h2&gt;

&lt;p&gt;On your local machine where you do your development, you need to set the logging options on a per container basis to your docker-compose file.  The lines to add are to each service are:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;logging:
  options:
    max-size: 50m
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Here’s an example in the context of a full container:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;services:
  redis:
    image: 'redis:3.2-alpine'
    ports:
      - '6379'
    volumes:
      - 'redis:/var/lib/redis/data'
    restart: on-failure
    logging:
      options:
        max-size: 50m
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Theoretically I could have ignored this at a per container level and just relied on the log management defined in /etc/docker/daemon.json but when you have a system level config file, that often gets changed and not checked into version control, belt &lt;strong&gt;and&lt;/strong&gt; suspenders is better.  Setting this at the application level and the system level should ensure that I don’t get bit by this again.  This will also protect your local dev box from unlimited log growth which could otherwise be a problem since your local dev box isn’t configured by the same /etc/docker/daemon.json file.&lt;/p&gt;

&lt;h2 id=&quot;add-cron-jobs-for-removing-unused-stuff-periodically&quot;&gt;Add Cron Jobs for Removing Unused Stuff Periodically&lt;/h2&gt;

&lt;p&gt;I added cron jobs to my underlying instance for cleaning up after dangling containers and volumes:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#Ansible: docker rmi images
1 1 * * * docker rmi -f $(docker images -a -q -f dangling=true)
#Ansible: docker volume rm
1 3 * * * docker volume rm -f $(docker volume ls -q -f dangling=true)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The #Ansible comment indicates that these were added by Ansible as part of my machine provisioning script (Step 8 below is now also part of that same script).&lt;/p&gt;

&lt;h2 id=&quot;step-7-get-etcdockerdaemonjson-into-ansible--version-control&quot;&gt;Step 7: Get /etc/docker/daemon.json into Ansible / Version Control&lt;/h2&gt;

&lt;p&gt;However you configure a new instance, you should make sure that your modified daemon.json file from Step 3 is part of that process or you’ll find that setting up a new machine has this same problem.&lt;/p&gt;

&lt;h2 id=&quot;step-8-redeploy-everything&quot;&gt;Step 8: Redeploy Everything&lt;/h2&gt;

&lt;p&gt;The final step is to re-deploy everything as all containers, volumes, etc have been deleted earlier in the process.  Hopefully you will find that your disc space usage comes under control.&lt;/p&gt;

&lt;h1 id=&quot;sidebar-1-docker-system-df&quot;&gt;Sidebar 1: docker system df&lt;/h1&gt;

&lt;p&gt;As I was finishing this post, I found the command docker system df which shows you the space docker uses.  Here’s an example from my local dev box:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FuzzygroupMacbookPro2016% docker system df
TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              671                 67                  40.59GB             24.07GB (59%)
Containers          84                  5                   742.2MB             718MB (96%)
Local Volumes       41                  22                  634.5MB             1.553kB (0%)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h1 id=&quot;sidebar-2-docker-system-prune&quot;&gt;Sidebar 2: docker system prune&lt;/h1&gt;

&lt;p&gt;The command docker system prune reclaims dangling images and stopped containers.  Here’s an example:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FuzzygroupMacbookPro2016% docker system prune
WARNING! This will remove:
        - all stopped containers
        - all networks not used by at least one container
        - all dangling images
        - all build cache
Are you sure you want to continue? [y/N] y
Deleted Containers:
4fc625609ac8f86f8d8f9076a8e75d5ccb31c1e871ed6f4589b79de2721af02c
... (A long, long list of containers was here)
Total reclaimed space: 28.72GB
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;The interesting thing here is that before I ran this I had 46 gigs of free space on my local dev box and after I ran this, I still had 46 gigs free.  I don’t know why Docker states that it reclaimed space when it doesn’t.&lt;/p&gt;

&lt;p&gt;Note: I’m not the only person who can’t reclaim this space.&lt;/p&gt;

&lt;h1 id=&quot;what-to-learn-from-this&quot;&gt;What to Learn from This&lt;/h1&gt;

&lt;p&gt;I would argue that the big takeaway from this isn’t actually the specific Docker commands, useful as they are, but the observation that disc space growth wasn’t tied to deploys but instead to system operation.  Realizing this changed how I approached the problem.  When you build complex systems, learning how to observe them and then correlating that with what you are doing to the system is a key technique.&lt;/p&gt;

&lt;h1 id=&quot;thank-yous&quot;&gt;Thank Yous&lt;/h1&gt;

&lt;p&gt;Most of what I know about Docker, I learned from the courses of &lt;a href=&quot;https://diveintodocker.com/&quot;&gt;Nick Janetakis&lt;/a&gt;.  He is a friend and he pitched in greatly on the analysis and resolution of this.  Thanks man!&lt;/p&gt;

&lt;h1 id=&quot;references&quot;&gt;References&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://blog.idetailaid.co.uk/docker-using-up-all-your-disk-space-dont-forget-to-clean-up-after-docker/&quot;&gt;Interesting Blog Post about Cleaning Up After Docker&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.google.com/search?tbs=li:1&amp;amp;q=how+much+space+are+my+docker+logs+taking&quot;&gt;Docker Logs on Stack Overflow&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/3804&quot;&gt;Docker Disc Space Quotas and aufs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://thehftguy.com/2016/11/01/docker-in-production-an-history-of-failure/&quot;&gt;Docker in Production a History of Failure&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=12872304&quot;&gt;Docker in Production a History of Failure&lt;/a&gt; (search for overlay2)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/22207&quot;&gt;Docker not Cleaning Up tmp Files&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/moby/moby/issues/29486&quot;&gt;Docker Orphaned Diffs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.docker.com/engine/userguide/storagedriver/overlayfs-driver/&quot;&gt;Using Overlay2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gist.github.com/stanislavb/6634fc35b3d1655201a93d2dd2c3a366&quot;&gt;A seemingly good shell script for cleaning up after Docker&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Wed, 30 Aug 2017 00:00:00 -0400</pubDate>
        <link>http://fuzzyblog.io//blog/docker/2017/08/30/running-out-of-disc-space-with-docker.html</link>
        <guid isPermaLink="true">http://fuzzyblog.io//blog/docker/2017/08/30/running-out-of-disc-space-with-docker.html</guid>
        
        <category>docker</category>
        
        <category>aufs</category>
        
        <category>disc_space</category>
        
        <category>bloat</category>
        
        
        <category>Docker</category>
        
      </item>
    
  </channel>
</rss>
