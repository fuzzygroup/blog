<p class="center"><img src="/blog/assets/IMG_1464.jpeg" alt="IMG_1464.jpeg" /></p>

<p>I recently started a new application and tried running the generated tests and got this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>rails test test/models/user_test.rb
Running via Spring preloader in process 27379
Run options: --seed 14413

# Running:

E

Error:
UserTest#test_can_delete_user_with_teams:
NoMethodError: undefined method `unpack1' for nil:NilClass
    app/models/user/connected_account.rb:37:in `&lt;class:ConnectedAccount&gt;'
    app/models/user/connected_account.rb:31:in `&lt;main&gt;'


rails test test/models/user_test.rb:57

E

Error:
UserTest#test_user_has_a_personal_team:
NoMethodError: undefined method `unpack1' for nil:NilClass
    app/models/user/connected_account.rb:37:in `&lt;class:ConnectedAccount&gt;'
    app/models/user/connected_account.rb:31:in `&lt;main&gt;'


rails test test/models/user_test.rb:52

E

Error:
UserTest#test_user_has_many_teams:
NoMethodError: undefined method `unpack1' for nil:NilClass
    app/models/user/connected_account.rb:37:in `&lt;class:ConnectedAccount&gt;'
    app/models/user/connected_account.rb:31:in `&lt;main&gt;'


rails test test/models/user_test.rb:46



Finished in 0.060465s, 49.6155 runs/s, 0.0000 assertions/s.
3 runs, 0 assertions, 0 failures, 3 errors, 0 skips
</code></pre>
</div>

<p>Now this is the the first time I've used test (as opposed to RSpec) in more than a decade and I was more than a bit taken aback.  A quick <a href="https://stackoverflow.com/questions/57197682/in-decode64-undefined-method-unpack1-for-nilnilclass-nomethoderror">Stack Overflow</a> led me to:</p>

<blockquote>
  <p>The error happens if you call Base64.decode64(nil). The method however is strictly expecting a String object here.</p>
</blockquote>

<p>Now the line of code in question is:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">attr_encrypted</span> <span class="ss">:access_token</span><span class="p">,</span> <span class="ss">key: </span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">access_token_encryption_key</span><span class="p">)</span>
</code></pre>
</div>

<p>So the implication is that:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">access_token_encryption_key</span>
</code></pre>
</div>

<p>is returning <strong>nil</strong>.</p>

<p>The solution is actually pretty simple â€“ create the credentials file using:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>EDITOR=vi rails credentials:edit --environment test
</code></pre>
</div>

<p>See this <a href="https://fuzzyblog.io/blog/rails/2020/01/24/when-rails-credentials-edit-won-t-save-your-credentials.html">blog post</a> for why you have to use EDITOR=vi.</p>
