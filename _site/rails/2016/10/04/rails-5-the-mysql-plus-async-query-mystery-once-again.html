<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Rails 5 - The MySQL Plus / Async Query Mystery Once Again</title>
  <meta name="description" content="I do a lot of work with high throughput db writes using MySQL and we’ve historically done this thru a bit of an oddity:">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://fuzzyblog.io//blog/rails/2016/10/04/rails-5-the-mysql-plus-async-query-mystery-once-again.html">
  <link rel="alternate" type="application/rss+xml" title="FuzzyBlog" href="http://fuzzyblog.io//blog/feed.xml">
  
  <!-- favicons -->
  <!-- shout out to: http://www.favicon-generator.org/ --> 
  <link rel="apple-touch-icon" sizes="57x57" href="/blog/assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/blog/assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/blog/assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/blog/assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/blog/assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/blog/assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/blog/assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/favicon-16x16.png">
  <link rel="manifest" href="/blog/assets/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/blog/assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- end_favicons -->
  
  <!-- twitter specific head tags -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@fuzzygroup">
  <meta name="twitter:creator" content="@fuzzygroup">
  <meta name="twitter:title" content="Rails 5 - The MySQL Plus / Async Query Mystery Once Again">

  
    <meta name="twitter:description"
      content="I do a lot of work with high throughput db writes using MySQL and we’ve historically done this thru a bit of an oddity:

Gemfile:

gem 'mysql2'
gem 'mysqlplus'



In our application:

require 'mysq...">
  

  
    <meta name="twitter:image"
      content="https://fuzzyblog.io/blog/assets/scott_johnson.jpg">
  
  
  
  
  
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83931583-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">FuzzyBlog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/aws.html">AWS</a>
          
        
          
          <a class="page-link" href="/blog/category.html">Category</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/blog/resume.html">Resume for J. Scott Johnson</a>
          
        
          
          <a class="page-link" href="/blog/tag.html">Tag</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Rails 5 - The MySQL Plus / Async Query Mystery Once Again</h1>
    <p class="I'll"><time datetime="2016-10-04T17:29:55-04:00" itemprop="datePublished">Oct 4, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I do a lot of work with high throughput db writes using MySQL and we’ve historically done this thru a bit of an oddity:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Gemfile:

gem 'mysql2'
gem 'mysqlplus'
</code></pre>
</div>

<p>In our application:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>require 'mysql'
class Mysql; alias :query :async_query; end
</code></pre>
</div>

<p>What this effectively does is load the async_query method of mysqlplus over the mysql2 gem’s query method allowing non blocking queries.  This is an old school technique that we developed in the Rails 4 / Ruby 1.9.3 world and its gone badly awry now that we are in Ruby 2.3.1.  Or has it?  We’ve changed:</p>

<ul>
  <li>ruby version</li>
  <li>rails version</li>
  <li>gem stack</li>
  <li>number of servers</li>
  <li>mysql version (now its MariaDB)</li>
  <li>operating system</li>
</ul>

<p>This is all in the context of our custom crawler which has its own application framework (hence the require statement above).  With that many changes what we need to do is establish a benchmark.  Thankfully when things change in a major way for me, I keep my old development system available.  This will allow us to easily compare crawl throughput over a somewhat long time period.  Here’s the initial results:</p>

<ul>
  <li>Ruby 2.3.1 version of code base: 2 hours produced a crawl of:
    <ul>
      <li>358 pages;</li>
      <li>16492 links;</li>
      <li>52 forms;</li>
      <li>2443 unique urls;</li>
      <li>358 page_bodies</li>
    </ul>
  </li>
  <li>Ruby 1.9.3 version of code base: 2 hours produced a crawl of:
    <ul>
      <li>609 pages</li>
      <li>13660 links</li>
      <li>204 forms</li>
      <li>0 unique urls</li>
      <li>609 page_bodies</li>
    </ul>
  </li>
</ul>

<p>Clearly this is a significant difference so this problem has to be addressed.  All I’ve been going on so far is a feeling that we had a performance difference in our crawl results.  Now we actually have numbers and that’s infinitely better – always remember that <strong>if you can’t measure it then its not engineering</strong>.</p>

<p>This was done with the following process:</p>

<ul>
  <li>bin/rails c Site.truncate_shards</li>
  <li>mysql -uroot -p banks_development &lt; ~/Downloads/sites.sql</li>
  <li>mysql -uroot -p banks_development &lt; ~/Downloads/banks.sql</li>
  <li>mysql -uroot -p banks_development &lt; ~/Downloads/processing_runs.sql</li>
  <li>mysql -uroot -p banks_development &lt; ~/Downloads/bank_details.sql</li>
  <li>bundle exec rake ucrawler:load_command_line_queue foo=bar OBJECT=Site METHOD=crawl_queue_all –trace</li>
  <li>bundle exec ruby script/ucrawler foo=bar NUM_THREADS=25 CRAWL_QUEUE=Site –trace</li>
</ul>

<p>Benchmarking could be done on a development system or the production boxes but by benchmarking on a development system we can eliminate the impact of the OS change, the server types, etc and limit it to, generally, just the ruby level differences.</p>

<p>The key difference is the lack of the mysqlplus gem and the alias method on query being mapped to async_query.</p>

<p>https://github.com/phusion/passenger/issues/1314</p>

<p>=======</p>

<p>Gem::Ext::BuildError: ERROR: Failed to build gem native extension.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>current directory: /Users/sjohnson/.rvm/gems/ruby-2.3.1@banks/gems/mysqlplus-0.1.2/ext /Users/sjohnson/.rvm/rubies/ruby-2.3.1/bin/ruby -r ./siteconf20160928-56313-10a73fn.rb extconf.rb checking for mysql_ssl_set()... yes checking for rb_str_set_len()... yes checking for mysql.h... yes checking for rb_thread_blocking_region()... no *** extconf.rb failed *** Could not create Makefile due to some reason, probably lack of necessary libraries and/or headers.  Check the mkmf.log file for more details.  You may need configuration options.
</code></pre>
</div>

<p>Provided configuration options:
	–with-opt-dir
	–with-opt-include
	–without-opt-include=${opt-dir}/include
	–with-opt-lib
	–without-opt-lib=${opt-dir}/lib
	–with-make-prog
	–without-make-prog
	–srcdir=.
	–curdir
	–ruby=/Users/sjohnson/.rvm/rubies/ruby-2.3.1/bin/$(RUBY_BASE_NAME)
	–with-mysql-config
	–without-mysql-config
extconf.rb:59:in `<main>': uninitialized constant Config (NameError)
Did you mean?  RbConfig
               CONFIG</main></p>

<p>To see why this extension failed to compile, please check the mkmf.log which can be found here:</p>

<p>/Users/sjohnson/.rvm/gems/ruby-2.3.1@banks/extensions/x86_64-darwin-15/2.3.0/mysqlplus-0.1.2/mkmf.log</p>

<p>extconf failed, exit code 1</p>

<p>Gem files will remain installed in /Users/sjohnson/.rvm/gems/ruby-2.3.1@banks/gems/mysqlplus-0.1.2 for inspection.
Results logged to /Users/sjohnson/.rvm/gems/ruby-2.3.1@banks/extensions/x86_64-darwin-15/2.3.0/mysqlplus-0.1.2/gem_make.out
An error occurred while installing mysqlplus (0.1.2), and Bundler cannot continue.
Make sure that <code class="highlighter-rouge">gem install mysqlplus -v '0.1.2'</code> succeeds before bundling.</p>

  </div>
  
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">FuzzyBlog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>FuzzyBlog</li>
          <li><a href="mailto:fuzzygroup@gmail.com">fuzzygroup@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fuzzygroup"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/fuzzygroup"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
