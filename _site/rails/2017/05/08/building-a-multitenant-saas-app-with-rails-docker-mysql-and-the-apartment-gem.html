<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Building a Multitenant SAAS App with Rails, Docker, MySQL and the Apartment Gem</title>
  <meta name="description" content="SAAS and Provisioning">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://fuzzyblog.io//blog/rails/2017/05/08/building-a-multitenant-saas-app-with-rails-docker-mysql-and-the-apartment-gem.html">
  <link rel="alternate" type="application/rss+xml" title="FuzzyBlog" href="http://fuzzyblog.io//blog/feed.xml">
  
  <!-- favicons -->
  <!-- shout out to: http://www.favicon-generator.org/ --> 
  <link rel="apple-touch-icon" sizes="57x57" href="/blog/assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/blog/assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/blog/assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/blog/assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/blog/assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/blog/assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/blog/assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/assets/favicon-16x16.png">
  <link rel="manifest" href="/blog/assets/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/blog/assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!-- end_favicons -->
  
  <!-- twitter specific head tags -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@fuzzygroup">
  <meta name="twitter:creator" content="@fuzzygroup">
  <meta name="twitter:title" content="Building a Multitenant SAAS App with Rails, Docker, MySQL and the Apartment Gem">

  
    <meta name="twitter:description"
      content="SAAS and Provisioning

This document lays out the SAAS and provisioning aspects of SeiraWatch.

Types of SAAS Isolation

At the heart of any SAAS app is isolating one user’s data from another.  The...">
  

  
    <meta name="twitter:image"
      content="https://fuzzyblog.io/blog/assets/scott_johnson.jpg">
  
  
  
  
  
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83931583-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">FuzzyBlog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/aws.html">AWS</a>
          
        
          
          <a class="page-link" href="/blog/category.html">Category</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/blog/resume.html">Resume for J. Scott Johnson</a>
          
        
          
          <a class="page-link" href="/blog/tag.html">Tag</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Building a Multitenant SAAS App with Rails, Docker, MySQL and the Apartment Gem</h1>
    <p class="I'll"><time datetime="2017-05-08T18:46:08-04:00" itemprop="datePublished">May 8, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="saas-and-provisioning">SAAS and Provisioning</h1>

<p>This document lays out the SAAS and provisioning aspects of SeiraWatch.</p>

<h1 id="types-of-saas-isolation">Types of SAAS Isolation</h1>

<p>At the heart of any SAAS app is isolating one user’s data from another.  There are several ways to do this but the simplest are:</p>

<ul>
  <li>scoping</li>
  <li>schemaing</li>
  <li>separating</li>
</ul>

<p>Scoping refers to bundling a user_id or account_id parameter with every single query so that you are always injecting the isolation with every query.  There are several disadvantages to this:</p>

<ul>
  <li>Assumes that every db query is ActiveRecord and can be automagically done</li>
  <li>Eliminates straight sql or pushes it down to the user</li>
  <li>If something goes wrong User A gets access to User B’s data</li>
  <li>Adds a tricky bit of Rails magic to what is literally the most complex part of your application (storage)</li>
  <li>Pushes performance issues right onto the developer since every index has to incorporate user_id or account_id as well as all othe rthings</li>
  <li>The core db will grow in size infiniitely leading to an ever more costly database server</li>
</ul>

<p>Schemaing means using the ability of Postgres to run multiple schemas per physical database.  This is dramatically better than scoping but also has disadvantages:</p>

<ul>
  <li>Ties you irrevocably to Postgres</li>
  <li>The core db will grow in size infiniitely leading to an ever more costly database server</li>
</ul>

<p>Separating means just what it sounds – every user or account gets a <strong>separate</strong> database.  This is the approach that WordPress uses and its hard to argue with the sucess of WordPress.  While everything has its issues, I like the disavantages here best of all:</p>

<ul>
  <li>More expensive since it means more physical databases but this is 2017 and we’re up to 64 bit servers now; we can get past this.</li>
  <li>In a broken up, non-monolith this is intimidating to implement but its actually pretty easy once you get your head around it</li>
</ul>

<h1 id="provisioning-approach">Provisioning Approach</h1>

<p>In order to make the provisioning work we need to rely on the Apartment gem.  Apartment is a multitenancy gem which allows subdomain based tenancy so we can have a domain structure like this:</p>

<p>www.seirawatch.com - the site
nickjj.seirawatch.com - nick’s account
fuzzygroup.seirawatch.com - scott’s account
…</p>

<p>Each new customer will get to register a username and that will become their subdomain that they log in by.  We will end up running one seira_watch_web_app container which can be autoscaled (since each database connection is separate) for load and we only need to run enough initial capacity that at least one instance is always available.</p>

<p>The way that the Apartment gem works is by changing the database it is using on the fly automatically based on the subdomain.  Here’s a peek at the logs from a test application:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># when I visited blog_1_development.lvmh.me:3000 (I started puma with -b lvmh.me:3000)
Started GET "/" for 127.0.0.1 at 2017-04-23 23:24:19 -0400
   (0.1ms)  use `apartment_development`
   (0.2ms)  SELECT DATABASE() as db
   (0.1ms)  use `blog_1_development`
Processing by Rails::WelcomeController#index as HTML
  Parameters: {"internal"=&gt;true}
  Rendering /Users/sjohnson/.rvm/gems/ruby-2.3.1/gems/railties-5.0.2/lib/rails/templates/rails/welcome/index.html.erb
  Rendered /Users/sjohnson/.rvm/gems/ruby-2.3.1/gems/railties-5.0.2/lib/rails/templates/rails/welcome/index.html.erb (4.5ms)
Completed 200 OK in 11ms (Views: 7.1ms | ActiveRecord: 0.0ms)

  # when I visited foo.lvmh.me:3000 (I started puma with -b lvmh.me:3000)
   (0.5ms)  use `apartment_development`
Started GET "/" for 127.0.0.1 at 2017-04-23 23:24:23 -0400
   (0.6ms)  use `apartment_development`
   (0.3ms)  SELECT DATABASE() as db
   (0.2ms)  use `foo`
Processing by Rails::WelcomeController#index as HTML
  Parameters: {"internal"=&gt;true}
  Rendering /Users/sjohnson/.rvm/gems/ruby-2.3.1/gems/railties-5.0.2/lib/rails/templates/rails/welcome/index.html.erb
  Rendered /Users/sjohnson/.rvm/gems/ruby-2.3.1/gems/railties-5.0.2/lib/rails/templates/rails/welcome/index.html.erb (3.3ms)
Completed 200 OK in 9ms (Views: 6.0ms | ActiveRecord: 0.0ms)
</code></pre>
</div>

<h2 id="adding-an-api-from-another-monolith-component">Adding an API from Another Monolith Component</h2>

<p>The way that Apartment works is that has a call:</p>

<blockquote>
  <p>Apartment::Tenant.create(tenant_name)</p>
</blockquote>

<p>what you invoke in order to create the “tenancy” database (think subdomain) and this either runs migrations or uses schema.rb to create a new database.  The problem is that if you’re NOT building a monolith you are running in a context AWAY from the schema you need to clone.  The solution is two fold:</p>

<ul>
  <li>Add an api for provisioning to the SAAS app which allows for two calls: create_db and add_user</li>
  <li>The create_db call takes a single, unique, username, a fully validated string and then invokes Apartment::Tenant.create</li>
  <li>The add_user method takes all the params for the user instance that we want on the model and builds the user_instance</li>
</ul>

<p>This will allow a user to:</p>

<ul>
  <li>sign up at the web site (or commerce portion) if I decide to decouple signup and commerce from the home page</li>
  <li>goto the subdomain and be automatically prompted for login</li>
  <li>normal cookie based login approaches will preserve the login for the period of time of the cookie</li>
  <li>allows normal development to continue with something like bundle exec rails s -p3010 -b lvh.me and still allow the right database to be selected when I goto nickjj.lvh.me:3010</li>
  <li>should work brilliantly with Docker as a deployment tech and allow Docker to be used to test locally the entire stack</li>
</ul>

<p>Issues:</p>

<ul>
  <li>We need to block the common domains that we don’t want a user to register like www, help, search, admin, etc (this can be done when the username is created with a Rails validator)</li>
  <li>Exactly how we let fuzzygroup into the SAAS container but not www is unclear but I would expect that’s an nginx proxying thing</li>
</ul>

<h1 id="thoughts">Thoughts?</h1>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://github.com/influitive/apartment">Apartment Gem</a></li>
  <li><a href="https://github.com/wireframe/multitenant">MultiTenant Gem</a></li>
  <li><a href="http://codecrate.com/2011/03/multitenant-locking-down-your-app-and.html">MultiTenant Blog Post</a></li>
  <li><a href="https://www.quora.com/How-can-I-operate-a-DB-model-for-a-Rails-multi-tenant-application-with-a-multiple-database-model">Quora</a></li>
  <li><a href="https://github.com/citusdata/activerecord-multi-tenant">ActiveRecord-Multi-Tenant</a></li>
  <li><a href="https://github.com/ErwinM/acts_as_tenant">ActsAsTenant</a></li>
  <li><a href="https://influitive.io/our-multi-tenancy-journey-with-postgres-schemas-and-apartment-6ecda151a21f">Blog Post About Apartment</a></li>
</ul>

<h1 id="creating-a-tenant">Creating a Tenant</h1>

<blockquote>
  <p>Apartment::Tenant.create(‘fuzzygroup5’)</p>
</blockquote>

<h1 id="the-initializer">The Initializer</h1>

<p>Shown below is the apartment.rb initializer.  The changes needed to enable db level tenancy are indicated by <strong>jsj</strong> in the comments.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># You can have Apartment route to the appropriate Tenant by adding some Rack middleware.
# Apartment can support many different "Elevators" that can take care of this routing to your data.
# Require whichever Elevator you're using below or none if you have a custom one.
#
# require 'apartment/elevators/generic'
# require 'apartment/elevators/domain'
require 'apartment/elevators/subdomain'
# require 'apartment/elevators/first_subdomain'

#
# Apartment Configuration
#
Apartment.configure do |config|

  # Add any models that you do not want to be multi-tenanted, but remain in the global (public) namespace.
  # A typical example would be a Customer or Tenant model that stores each Tenant's information.
  #
  # config.excluded_models = %w{ Tenant }

  # In order to migrate all of your Tenants you need to provide a list of Tenant names to Apartment.
  # You can make this dynamic by providing a Proc object to be called on migrations.
  # This object should yield either:
  # - an array of strings representing each Tenant name.
  # - a hash which keys are tenant names, and values custom db config (must contain all key/values required in database.yml)
  #
  # config.tenant_names = lambda{ Customer.pluck(:tenant_name) }
  # config.tenant_names = ['tenant1', 'tenant2']
  # config.tenant_names = {
  #   'tenant1' =&gt; {
  #     adapter: 'postgresql',
  #     host: 'some_server',
  #     port: 5555,
  #     database: 'postgres' # this is not the name of the tenant's db
  #                          # but the name of the database to connect to before creating the tenant's db
  #                          # mandatory in postgresql
  #   },
  #   'tenant2' =&gt; {
  #     adapter:  'postgresql',
  #     database: 'postgres' # this is not the name of the tenant's db
  #                          # but the name of the database to connect to before creating the tenant's db
  #                          # mandatory in postgresql
  #   }
  # }
  # config.tenant_names = lambda do
  #   Tenant.all.each_with_object({}) do |tenant, hash|
  #     hash[tenant.name] = tenant.db_configuration
  #   end
  # end
  #
  
  # jsj - this needed to be turned OFF 
  ###config.tenant_names = lambda { ToDo_Tenant_Or_User_Model.pluck :database }

  #
  # ==&gt; PostgreSQL only options

  # Specifies whether to use PostgreSQL schemas or create a new database per Tenant.
  # The default behaviour is true.
  #
  # config.use_schemas = true
  
  # jsj - this needed to be set to false
  # required for mysql / Rails 5:
  # https://github.com/influitive/apartment/issues/345#issuecomment-258733219
  config.use_schemas = false

  # Apartment can be forced to use raw SQL dumps instead of schema.rb for creating new schemas.
  # Use this when you are using some extra features in PostgreSQL that can't be respresented in
  # schema.rb, like materialized views etc. (only applies with use_schemas set to true).
  # (Note: this option doesn't use db/structure.sql, it creates SQL dump by executing pg_dump)
  #
  # config.use_sql = false

  # There are cases where you might want some schemas to always be in your search_path
  # e.g when using a PostgreSQL extension like hstore.
  # Any schemas added here will be available along with your selected Tenant.
  #
  # config.persistent_schemas = %w{ hstore }

  # &lt;== PostgreSQL only options
  #

  # By default, and only when not using PostgreSQL schemas, Apartment will prepend the environment
  # to the tenant name to ensure there is no conflict between your environments.
  # This is mainly for the benefit of your development and test environments.
  # Uncomment the line below if you want to disable this behaviour in production.
  #
  # config.prepend_environment = !Rails.env.production?
end

# Setup a custom Tenant switching middleware. The Proc should return the name of the Tenant that
# you want to switch to.
# Rails.application.config.middleware.use 'Apartment::Elevators::Generic', lambda { |request|
#   request.host.split('.').first
# }

# Rails.application.config.middleware.use 'Apartment::Elevators::Domain'

# jsj - this needed to be set
Rails.application.config.middleware.use 'Apartment::Elevators::Subdomain'
# Rails.application.config.middleware.use 'Apartment::Elevators::FirstSubdomain'
</code></pre>
</div>


  </div>
  
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">FuzzyBlog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>FuzzyBlog</li>
          <li><a href="mailto:fuzzygroup@gmail.com">fuzzygroup@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fuzzygroup"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/fuzzygroup"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">fuzzygroup</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Scott Johnson writing about the usual array of nerd stuff: AWS / Ansible / Ruby / Rails / Elixir / Misc / Hyde.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
