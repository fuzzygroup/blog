<p>In this tutorial we’re going to use the latest version of Capistrano to deploy your Rails app onto one or more EC2 instances.  I’m dividing this tutorial into two parts:</p>

<ul>
  <li>Take 1 where a static set of boxes is encoded into your deploy/production.rb file</li>
  <li>Take 2 where we call AWS apis to figure out what boxes to deploy to</li>
</ul>

<p>The reason for separating them is that take 2 will bring us much deeper into AWS API programming and concepts like tagging / IAM roles I wanted that to be highly separate from the guts of Capistrano.</p>

<h1 id="tools">Tools</h1>

<p>In this tutorial I’m going to be specific to:</p>

<ul>
  <li>Capistrano</li>
  <li>Passenger</li>
  <li>Bundler</li>
  <li>RVM</li>
</ul>

<p>That’s my standard Rails stack and while other configurations will work, NGINX is a favorite of people, that’s the only stack I personally understand end to end.</p>

<h1 id="getting-started---add-capistrano-to-your-gemfile">Getting Started - Add Capistrano to Your Gemfile</h1>

<p>You’re going to want to use Capistrano 3.6 or later.  Earlier versions of Capistrano should work but, in my experience, Capistrano 3.6 is a much better release - it took me away from Vlad finally and for that I was glad.</p>

<p>If your Gemfile you want something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>group :development do
  # Use Capistrano for deployment
  gem 'capistrano', "3.6.1"
  gem 'capistrano3-puma'
  gem 'capistrano-rails', require: false
  gem 'capistrano-bundler', require: false
  gem 'capistrano-rvm'
  gem 'capistrano-passenger'
end
</code></pre>
</div>

<p>After that you want to run bundle install:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bundle install
</code></pre>
</div>

<p>As long as this runs correctly you should be fine to move onto the next step.</p>

<h1 id="run-the-cap-install-command">Run the Cap install Command</h1>

<p>Capistrano requires a one time setup step.  Do this now:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Cap install
</code></pre>
</div>

<p>This generates a file in the root of your Rails app called Capfile.  Open that file and uncomment these lines:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>require 'capistrano/rvm'
require 'capistrano/bundler'
require 'capistrano/rails/assets'    
</code></pre>
</div>

<h1 id="modify-configdeployrb">Modify config/deploy.rb</h1>

<p>The file config/deploy.rb covers the application level configuration for deployment. In this file you need to add lines like the ones below but specific to your code base / toolset:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>set :application, 'banks'
set :repo_url, 'git@github.com:appdatallc/banks.git'

set :ssh_options, {
  forward_agent: true,
  auth_methods: ["publickey"],
  keys: ["#{Dir.home}/.ssh/fi_nav_sitecrawl.pem"]
}

set :deploy_to, '/var/www/apps/banks'
</code></pre>
</div>

<h1 id="modifying-configdeployproductionrb">Modifying config/deploy/production.rb</h1>

<p>The file config/deploy/production.rb covers the servers you are deploying to in the production environment. If you’re setting up a staging server then there is a similar file in config/deploy/staging.rb.</p>

<p>Before you start does this section I strongly, strong, strongly advice you to read my <a href="https://fuzzygroup.github.io/blog/aws/2016/09/20/aws-tutorial-08-using-ssh-s-config-file-with-your-aws-boxes.html">AWS Tutorial on the SSH Config file</a>.  You can use the approach in that file to identify your boxes.  If you do then this line:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server 'ec2-52-41-237-52.us-west-2.compute.amazonaws.com', user: 'ubuntu', roles: %w{web app}
</code></pre>
</div>

<p>would be replaced by this line:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server 'ficrawler1', roles: %w{web app}
</code></pre>
</div>

<p>Not only is this simpler to understand but it centralizes all your EC2 machine addresses in one place.  That’s a huge win.</p>

<p>Regardless of the approach you decide to take, you need one line in this file for each EC2 instance along with the roles the instance provides.</p>

<h1 id="doing-a-deploy">Doing a Deploy</h1>

<p>Once all of this configured then you should be able to do a:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cap production deploy
</code></pre>
</div>

<p>to get your current code base onto all your boxes.  Please keep in mind that Capistrano executes everything via SSH and it generates a long stream of commands.  If you see errors then there are two things to understand:</p>

<ul>
  <li>Not every error may be significant and need to be addressed</li>
  <li>If you are trying to track down an error then I would strongly recommend reducing the boxes you deploy to to just one and then redeploying.  This is much easier to troubleshoot exactly what is happening</li>
</ul>

<h1 id="references">References</h1>

<p>Here are some of the research sources I used in writing this:</p>

<ul>
  <li><a href="https://www.sitepoint.com/deploy-your-rails-app-to-aws/">https://www.sitepoint.com/deploy-your-rails-app-to-aws/</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-deploy-a-rails-app-with-puma-and-nginx-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-deploy-a-rails-app-with-puma-and-nginx-on-ubuntu-14-04</a></li>
  <li><a href="https://github.com/capistrano/bundler">https://github.com/capistrano/bundler</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma">https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma</a></li>
  <li><a href="http://stackoverflow.com/questions/21259826/ruby-on-rails-capistrano-3-deployment-error">http://stackoverflow.com/questions/21259826/ruby-on-rails-capistrano-3-deployment-error</a></li>
  <li><a href="http://jyaasa.com/blog/deploying-rails-web-application-using-capistrano-bundler-and-rvm">http://jyaasa.com/blog/deploying-rails-web-application-using-capistrano-bundler-and-rvm</a> &lt;== This is the best source</li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-an-ubuntu-14-04-server">https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-an-ubuntu-14-04-server</a></li>
  <li><a href="http://railsapps.github.io/installing-rails.html">http://railsapps.github.io/installing-rails.html</a></li>
  <li><a href="http://stackoverflow.com/questions/12967918/deploy-with-capistrano-using-a-pem-file">http://stackoverflow.com/questions/12967918/deploy-with-capistrano-using-a-pem-file</a></li>
  <li><a href="http://stackoverflow.com/questions/9217868/deploying-ruby-on-rails-app-using-capistrano-cap-deploysetup-failing">http://stackoverflow.com/questions/9217868/deploying-ruby-on-rails-app-using-capistrano-cap-deploysetup-failing</a></li>
  <li><a href="http://stackoverflow.com/questions/9277731/cap-generates-cannot-load-such-file-bundler-capistrano-loaderror">http://stackoverflow.com/questions/9277731/cap-generates-cannot-load-such-file-bundler-capistrano-loaderror</a></li>
  <li><a href="http://stackoverflow.com/questions/15282532/capistrano-deploy-using-passenger-not-changing-release">http://stackoverflow.com/questions/15282532/capistrano-deploy-using-passenger-not-changing-release</a></li>
  <li><a href="http://stackoverflow.com/questions/29241053/incomplete-response-received-from-application-from-nginx-passenger">http://stackoverflow.com/questions/29241053/incomplete-response-received-from-application-from-nginx-passenger</a></li>
  <li><a href="https://semaphoreci.com/community/tutorials/how-to-deploy-node-js-applications-with-capistrano">https://semaphoreci.com/community/tutorials/how-to-deploy-node-js-applications-with-capistrano</a></li>
</ul>
